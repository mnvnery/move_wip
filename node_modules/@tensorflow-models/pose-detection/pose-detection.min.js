/**
    * @license
    * Copyright 2022 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@mediapipe/pose"),require("@tensorflow/tfjs-core"),require("@tensorflow/tfjs-converter")):"function"==typeof define&&define.amd?define(["exports","@mediapipe/pose","@tensorflow/tfjs-core","@tensorflow/tfjs-converter"],e):e((t=t||self).poseDetection={},t.globalThis,t.tf,t.tf)}(this,(function(t,e,i,n){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var a=function(){return(a=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function s(t,e,i,n){return new(i||(i=Promise))((function(r,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function s(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}l((n=n.apply(t,e||[])).next())}))}function l(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function u(t,e,i){if(i||2===arguments.length)for(var n,r=0,o=e.length;r<o;r++)!n&&r in e||(n||(n=Array.prototype.slice.call(e,0,r)),n[r]=e[r]);return t.concat(n||Array.prototype.slice.call(e))}var h=["nose","left_eye","right_eye","left_ear","right_ear","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle"],c=["nose","left_eye_inner","left_eye","left_eye_outer","right_eye_inner","right_eye","right_eye_outer","left_ear","right_ear","mouth_left","mouth_right","left_shoulder","right_shoulder","left_elbow","right_elbow","left_wrist","right_wrist","left_pinky","right_pinky","left_index","right_index","left_thumb","right_thumb","left_hip","right_hip","left_knee","right_knee","left_ankle","right_ankle","left_heel","right_heel","left_foot_index","right_foot_index"],p={left:[1,2,3,7,9,11,13,15,17,19,21,23,25,27,29,31],right:[4,5,6,8,10,12,14,16,18,20,22,24,26,28,30,32],middle:[0]},d={left:[1,3,5,7,9,11,13,15],right:[2,4,6,8,10,12,14,16],middle:[0]},f=[[0,1],[0,2],[1,3],[2,4],[5,6],[5,7],[5,11],[6,8],[6,12],[7,9],[8,10],[11,12],[11,13],[12,14],[13,15],[14,16]],m=[[0,1],[0,4],[1,2],[2,3],[3,7],[4,5],[5,6],[6,8],[9,10],[11,12],[11,13],[11,23],[12,14],[14,16],[12,24],[13,15],[15,17],[16,18],[16,20],[15,17],[15,19],[15,21],[16,22],[17,19],[18,20],[23,25],[23,24],[24,26],[25,27],[26,28],[27,29],[28,30],[27,31],[28,32],[29,31],[30,32]];function g(t){return t instanceof SVGAnimatedLength?t.baseVal.value:t}function y(t){return s(this,void 0,void 0,(function(){var e,n;return l(this,(function(r){switch(r.label){case 0:return e=document.createElement("canvas"),t instanceof i.Tensor?[4,i.browser.toPixels(t,e)]:[3,2];case 1:return r.sent(),[3,3];case 2:e.width=g(t.width),e.height=g(t.height),n=e.getContext("2d"),t instanceof ImageData?n.putImageData(t,0,0):n.drawImage(t,0,0),r.label=3;case 3:return[2,e]}}))}))}function v(t){return s(this,void 0,void 0,(function(){var e,n,r,o,a,s;return l(this,(function(l){switch(l.label){case 0:return t instanceof i.Tensor?(e=t.shape.slice(0,2),n=e[0],r=e[1],o=ImageData.bind,[4,i.browser.toPixels(t)]):[3,2];case 1:return[2,new(o.apply(ImageData,[void 0,l.sent(),r,n]))];case 2:return a=document.createElement("canvas"),s=a.getContext("2d"),a.width=g(t.width),a.height=g(t.height),s.drawImage(t,0,0),[2,s.getImageData(0,0,a.width,a.height)]}}))}))}function x(t){return s(this,void 0,void 0,(function(){var e,n;return l(this,(function(r){switch(r.label){case 0:return t instanceof SVGImageElement||t instanceof OffscreenCanvas?[4,y(t)]:[3,2];case 1:return n=r.sent(),[3,3];case 2:n=t,r.label=3;case 3:return e=n,[2,i.browser.fromPixels(e,4)]}}))}))}function w(t){if(t<0||t>=256)throw new Error("Mask value must be in range [0, 255] but got ".concat(t));if(!Number.isInteger(t))throw new Error("Mask value must be an integer but got ".concat(t))}var k={runtime:"mediapipe",enableSmoothing:!0,enableSegmentation:!1,smoothSegmentation:!0,modelType:"full"};var b=function(){function t(t){this.mask=t}return t.prototype.toCanvasImageSource=function(){return s(this,void 0,void 0,(function(){return l(this,(function(t){return[2,this.mask]}))}))},t.prototype.toImageData=function(){return s(this,void 0,void 0,(function(){return l(this,(function(t){return[2,v(this.mask)]}))}))},t.prototype.toTensor=function(){return s(this,void 0,void 0,(function(){return l(this,(function(t){return[2,x(this.mask)]}))}))},t.prototype.getUnderlyingType=function(){return"canvasimagesource"},t}();function M(t){return w(t),"person"}var S=function(){function t(t){var i,n=this;switch(this.width=0,this.height=0,this.selfieMode=!1,this.poseSolution=new e.Pose({locateFile:function(e,i){if(t.solutionPath){var n=t.solutionPath.replace(/\/+$/,"");return"".concat(n,"/").concat(e)}return"".concat(i,"/").concat(e)}}),t.modelType){case"lite":i=0;break;case"heavy":i=2;break;case"full":default:i=1}this.poseSolution.setOptions({modelComplexity:i,smoothLandmarks:t.enableSmoothing,enableSegmentation:t.enableSegmentation,smoothSegmentation:t.smoothSegmentation,selfieMode:this.selfieMode}),this.poseSolution.onResults((function(t){if(n.height=t.image.height,n.width=t.image.width,null==t.poseLandmarks)n.poses=[];else{var e=n.translateOutput(t.poseLandmarks,t.poseWorldLandmarks);t.segmentationMask&&(e.segmentation={maskValueToLabel:M,mask:new b(t.segmentationMask)}),n.poses=[e]}}))}return t.prototype.translateOutput=function(t,e){var i=this,n={keypoints:t.map((function(t,e){return{x:t.x*i.width,y:t.y*i.height,z:t.z,score:t.visibility,name:c[e]}}))};return null!=e&&(n.keypoints3D=e.map((function(t,e){return{x:t.x,y:t.y,z:t.z,score:t.visibility,name:c[e]}}))),n},t.prototype.estimatePoses=function(t,e,n){return s(this,void 0,void 0,(function(){var r,o;return l(this,(function(a){switch(a.label){case 0:return e&&e.flipHorizontal&&e.flipHorizontal!==this.selfieMode&&(this.selfieMode=e.flipHorizontal,this.poseSolution.setOptions({selfieMode:this.selfieMode})),t instanceof i.Tensor?(o=ImageData.bind,[4,i.browser.toPixels(t)]):[3,2];case 1:return r=new(o.apply(ImageData,[void 0,a.sent(),t.shape[1],t.shape[0]])),[3,3];case 2:r=t,a.label=3;case 3:return t=r,[4,this.poseSolution.send({image:t},n)];case 4:return a.sent(),[2,this.poses]}}))}))},t.prototype.dispose=function(){this.poseSolution.close()},t.prototype.reset=function(){this.poseSolution.reset()},t.prototype.initialize=function(){return this.poseSolution.initialize()},t}();function T(t){return s(this,void 0,void 0,(function(){var e,i;return l(this,(function(n){switch(n.label){case 0:return e=function(t){if(null==t)return a({},k);var e=a({},t);return e.runtime="mediapipe",null==e.enableSegmentation&&(e.enableSegmentation=k.enableSegmentation),null==e.enableSmoothing&&(e.enableSmoothing=k.enableSmoothing),null==e.smoothSegmentation&&(e.smoothSegmentation=k.smoothSegmentation),null==e.modelType&&(e.modelType=k.modelType),e}(t),[4,(i=new S(e)).initialize()];case 1:return n.sent(),[2,i]}}))}))}function P(t){return t instanceof i.Tensor?{height:t.shape[0],width:t.shape[1]}:{height:t.height,width:t.width}}function F(t){return t-2*Math.PI*Math.floor((t+Math.PI)/(2*Math.PI))}function _(t){return t instanceof i.Tensor?t:i.browser.fromPixels(t)}function z(t,e,i){return O(i,"inputResolution"),[1/i.width*t[0][0]*e.width,1/i.height*t[0][1]*e.width,t[0][3]*e.width,1/i.width*t[1][0]*e.height,1/i.height*t[1][1]*e.height,t[1][3]*e.height,0,0]}function O(t,e){i.util.assert(0!==t.width,(function(){return"".concat(e," width cannot be 0.")})),i.util.assert(0!==t.height,(function(){return"".concat(e," height cannot be 0.")}))}function A(t,e,i){var n=i.rotationVectorStartKeypointIndex,r=i.rotationVectorEndKeypointIndex,o=t.locationData,a=o.relativeKeypoints[n].x*e.width,s=o.relativeKeypoints[n].y*e.height,l=o.relativeKeypoints[r].x*e.width,u=o.relativeKeypoints[r].y*e.height,h=2*Math.sqrt((l-a)*(l-a)+(u-s)*(u-s)),c=function(t,e,i){var n,r=t.locationData,o=i.rotationVectorStartKeypointIndex,a=i.rotationVectorEndKeypointIndex;n=i.rotationVectorTargetAngle?i.rotationVectorTargetAngle:Math.PI*i.rotationVectorTargetAngleDegree/180;var s=r.relativeKeypoints[o].x*e.width,l=r.relativeKeypoints[o].y*e.height,u=r.relativeKeypoints[a].x*e.width,h=r.relativeKeypoints[a].y*e.height;return F(n-Math.atan2(-(h-l),u-s))}(t,e,i);return{xCenter:a/e.width,yCenter:s/e.height,width:h/e.width,height:h/e.height,rotation:c}}function C(t){if(16!==t.length)throw new Error("Array length must be 16 but got ".concat(t.length));return[[t[0],t[1],t[2],t[3]],[t[4],t[5],t[6],t[7]],[t[8],t[9],t[10],t[11]],[t[12],t[13],t[14],t[15]]]}function I(t,e,i,n,r,o,a){return t[e][r]*(t[i][o]*t[n][a]-t[i][a]*t[n][o])}function R(t,e,i){var n=(e+1)%4,r=(e+2)%4,o=(e+3)%4,a=(i+1)%4,s=(i+2)%4,l=(i+3)%4;return I(t,n,r,o,a,s,l)+I(t,r,o,n,a,s,l)+I(t,o,n,r,a,s,l)}function E(t,e,i){void 0===i&&(i={ignoreRotation:!1});for(var n=[],r=0,o=t;r<o.length;r++){var s=o[r],l=s.x-.5,u=s.y-.5,h=i.ignoreRotation?0:e.rotation,c=Math.cos(h)*l-Math.sin(h)*u,p=Math.sin(h)*l+Math.cos(h)*u;c=c*e.width+e.xCenter,p=p*e.height+e.yCenter;var d=s.z*e.width,f=a({},s);f.x=c,f.y=p,f.z=d,n.push(f)}return n}function V(t,e){var n=function(t,e,i,n){var r=e-t,o=n-i;if(0===r)throw new Error("Original min and max are both ".concat(t,", range cannot be 0."));var a=o/r;return{scale:a,offset:i-t*a}}(0,255,e[0],e[1]);return i.tidy((function(){return i.add(i.mul(t,n.scale),n.offset)}))}function B(t,e,n){var r,o,a,s,l,u,h,c,p,d,f,m,g,y,v=e.outputTensorSize,x=e.keepAspectRatio,w=e.borderMode,k=e.outputTensorFloatRange,b=P(t),M=function(t,e){return e?{xCenter:e.xCenter*t.width,yCenter:e.yCenter*t.height,width:e.width*t.width,height:e.height*t.height,rotation:e.rotation}:{xCenter:.5*t.width,yCenter:.5*t.height,width:t.width,height:t.height,rotation:0}}(b,n),S=function(t,e,i){if(void 0===i&&(i=!1),!i)return{top:0,left:0,right:0,bottom:0};var n=e.height,r=e.width;O(e,"targetSize"),O(t,"roi");var o,a,s=n/r,l=t.height/t.width,u=0,h=0;return s>l?(o=t.width,a=t.width*s,h=(1-l/s)/2):(o=t.height/s,a=t.height,u=(1-s/l)/2),t.width=o,t.height=a,{top:h,left:u,right:u,bottom:h}}(M,v,x),T=(r=M,o=b.width,a=b.height,s=!1,l=r.width,u=r.height,h=s?-1:1,c=Math.cos(r.rotation),p=Math.sin(r.rotation),d=r.xCenter,f=r.yCenter,m=1/o,g=1/a,(y=new Array(16))[0]=l*c*h*m,y[1]=-u*p*m,y[2]=0,y[3]=(-.5*l*c*h+.5*u*p+d)*m,y[4]=l*p*h*g,y[5]=u*c*g,y[6]=0,y[7]=(-.5*u*c-.5*l*p*h+f)*g,y[8]=0,y[9]=0,y[10]=l*m,y[11]=0,y[12]=0,y[13]=0,y[14]=0,y[15]=1,C(y));return{imageTensor:i.tidy((function(){var e=_(t),n=i.tensor2d(z(T,b,v),[1,8]),r="zero"===w?"constant":"nearest",o=i.image.transform(i.expandDims(i.cast(e,"float32")),n,"bilinear",r,0,[v.height,v.width]);return null!=k?V(o,k):o})),padding:S,transformationMatrix:T}}function L(t,e,i,n){return 1===n?.5*(t+e):t+(e-t)*i/(n-1)}function D(t){return i.tidy((function(){var e=function(t){return i.tidy((function(){return[i.slice(t,[0,0,0],[1,-1,1]),i.slice(t,[0,0,1],[1,-1,-1])]}))}(t),n=e[0],r=e[1];return{boxes:i.squeeze(r),logits:i.squeeze(n)}}))}function N(t){return null!=t&&null!=t.currentTime}function q(t){for(var e={locationData:{relativeKeypoints:[]}},i=Number.MAX_SAFE_INTEGER,n=Number.MIN_SAFE_INTEGER,r=Number.MAX_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,a=0;a<t.length;++a){var s=t[a];i=Math.min(i,s.x),n=Math.max(n,s.x),r=Math.min(r,s.y),o=Math.max(o,s.y),e.locationData.relativeKeypoints.push({x:s.x,y:s.y})}return e.locationData.relativeBoundingBox={xMin:i,yMin:r,xMax:n,yMax:o,width:n-i,height:o-r},e}function K(t,e,n,r){return s(this,void 0,void 0,(function(){var r,o,a,s,u;return l(this,(function(l){switch(l.label){case 0:return t.sort((function(t,e){return Math.max.apply(Math,e.score)-Math.max.apply(Math,t.score)})),r=i.tensor2d(t.map((function(t){return[t.locationData.relativeBoundingBox.yMin,t.locationData.relativeBoundingBox.xMin,t.locationData.relativeBoundingBox.yMax,t.locationData.relativeBoundingBox.xMax]}))),o=i.tensor1d(t.map((function(t){return t.score[0]}))),[4,i.image.nonMaxSuppressionAsync(r,o,e,n)];case 1:return[4,(a=l.sent()).array()];case 2:return s=l.sent(),u=t.filter((function(t,e){return s.indexOf(e)>-1})),i.dispose([r,o,a]),[2,u]}}))}))}function j(t,e){return t.map((function(t){var i=a(a({},t),{x:t.x*e.width,y:t.y*e.height});return null!=t.z&&(i.z=t.z*e.width),i}))}function H(t,e,n){return s(this,void 0,void 0,(function(){var r,o,s,u,h,c,p,d,f,m,g,y,v,x,w,k,b,M,S,T,P,F,_,z;return l(this,(function(l){switch(l.label){case 0:if(r=i.squeeze(e,[0]),o=r.shape,s=o[0],u=o[1],h=o[2],t.length!==h)throw new Error("Expected heatmap to have same number of channels as the number of landmarks. But got landmarks length: "+"".concat(t.length,", heatmap length: ").concat(h));return c=[],[4,r.buffer()];case 1:for(p=l.sent(),d=0;d<t.length;d++)if(f=t[d],m=a({},f),c.push(m),g=Math.trunc(m.x*u),y=Math.trunc(m.y*s),!(g<0||g>=u||y<0||g>=s)){for(v=Math.trunc((n.kernelSize-1)/2),x=Math.max(0,g-v),w=Math.min(u,g+v+1),k=Math.max(0,y-v),b=Math.min(s,y+v+1),M=0,S=0,T=0,P=0,F=k;F<b;++F)for(_=x;_<w;++_)z=p.get(F,_,d),M+=z,P=Math.max(P,z),S+=_*z,T+=F*z;P>=n.minConfidenceToRefine&&M>0&&(m.x=S/u/M,m.y=T/s/M)}return r.dispose(),[2,c]}}))}))}function U(t,e){var i=e.left,n=e.top,r=e.left+e.right,o=e.top+e.bottom;return t.map((function(t){return a(a({},t),{x:(t.x-i)/(1-r),y:(t.y-n)/(1-o),z:t.z/(1-r)})}))}function X(t,e,n){return"webgl"===i.getBackend()?function(t,e,n){var r=n.combineWithPreviousRatio.toFixed(2),o={variableNames:["prevMask","newMask"],outputShape:t.shape,userCode:"\n  void main() {\n      ivec2 coords = getOutputCoords();\n      int height = coords[0];\n      int width = coords[1];\n\n      float prevMaskValue = getPrevMask(height, width);\n      float newMaskValue = getNewMask(height, width);\n\n      /*\n      * Assume p := newMaskValue\n      * H(p) := 1 + (p * log(p) + (1-p) * log(1-p)) / log(2)\n      * uncertainty alpha(p) =\n      *   Clamp(1 - (1 - H(p)) * (1 - H(p)), 0, 1) [squaring the\n      * uncertainty]\n      *\n      * The following polynomial approximates uncertainty alpha as a\n      * function of (p + 0.5):\n      */\n      const float c1 = 5.68842;\n      const float c2 = -0.748699;\n      const float c3 = -57.8051;\n      const float c4 = 291.309;\n      const float c5 = -624.717;\n      float t = newMaskValue - 0.5;\n      float x = t * t;\n\n      float uncertainty =\n        1.0 - min(1.0, x * (c1 + x * (c2 + x * (c3 + x * (c4 + x * c5)))));\n\n      float outputValue = newMaskValue + (prevMaskValue - newMaskValue) *\n                             (uncertainty * ".concat(r,");\n\n      setOutput(outputValue);\n    }\n")},a=i.backend();return i.tidy((function(){var n=a.compileAndRun(o,[t,e]);return i.engine().makeTensorFromDataId(n.dataId,n.shape,n.dtype)}))}(t,e,n):i.tidy((function(){var r=i.sub(e,.5),o=i.square(r),a=i.sub(1,i.minimum(1,i.mul(o,i.add(5.68842,i.mul(o,i.add(-.748699,i.mul(o,i.add(-57.8051,i.mul(o,i.add(291.309,i.mul(o,-624.717)))))))))));return i.add(e,i.mul(i.sub(t,e),i.mul(a,n.combineWithPreviousRatio)))}))}function W(t,e,n){return s(this,void 0,void 0,(function(){var r,o,a,s,u;return l(this,(function(l){switch(l.label){case 0:return r=t[0],o=t[1],a=function(t,e,n){return i.tidy((function(){var r,o,a,s;n.reverseOutputOrder?(o=i.squeeze(i.slice(t,[0,n.boxCoordOffset+0],[-1,1])),r=i.squeeze(i.slice(t,[0,n.boxCoordOffset+1],[-1,1])),s=i.squeeze(i.slice(t,[0,n.boxCoordOffset+2],[-1,1])),a=i.squeeze(i.slice(t,[0,n.boxCoordOffset+3],[-1,1]))):(r=i.squeeze(i.slice(t,[0,n.boxCoordOffset+0],[-1,1])),o=i.squeeze(i.slice(t,[0,n.boxCoordOffset+1],[-1,1])),a=i.squeeze(i.slice(t,[0,n.boxCoordOffset+2],[-1,1])),s=i.squeeze(i.slice(t,[0,n.boxCoordOffset+3],[-1,1]))),o=i.add(i.mul(i.div(o,n.xScale),e.w),e.x),r=i.add(i.mul(i.div(r,n.yScale),e.h),e.y),n.applyExponentialOnBoxSize?(a=i.mul(i.exp(i.div(a,n.hScale)),e.h),s=i.mul(i.exp(i.div(s,n.wScale)),e.w)):(a=i.mul(i.div(a,n.hScale),e.h),s=i.mul(i.div(s,n.wScale),e.h));var l=i.sub(r,i.div(a,2)),u=i.sub(o,i.div(s,2)),h=i.add(r,i.div(a,2)),c=i.add(o,i.div(s,2)),p=i.concat([i.reshape(l,[n.numBoxes,1]),i.reshape(u,[n.numBoxes,1]),i.reshape(h,[n.numBoxes,1]),i.reshape(c,[n.numBoxes,1])],1);if(n.numKeypoints)for(var d=0;d<n.numKeypoints;++d){var f=n.keypointCoordOffset+d*n.numValuesPerKeypoint,m=void 0,g=void 0;n.reverseOutputOrder?(m=i.squeeze(i.slice(t,[0,f],[-1,1])),g=i.squeeze(i.slice(t,[0,f+1],[-1,1]))):(g=i.squeeze(i.slice(t,[0,f],[-1,1])),m=i.squeeze(i.slice(t,[0,f+1],[-1,1])));var y=i.add(i.mul(i.div(m,n.xScale),e.w),e.x),v=i.add(i.mul(i.div(g,n.yScale),e.h),e.y);p=i.concat([p,i.reshape(y,[n.numBoxes,1]),i.reshape(v,[n.numBoxes,1])],1)}return p}))}(o,e,n),s=i.tidy((function(){var t=r;return n.sigmoidScore?(null!=n.scoreClippingThresh&&(t=i.clipByValue(r,-n.scoreClippingThresh,n.scoreClippingThresh)),t=i.sigmoid(t)):t})),[4,G(a,s,n)];case 1:return u=l.sent(),i.dispose([a,s]),[2,u]}}))}))}function G(t,e,i){return s(this,void 0,void 0,(function(){var n,r,o,a,s,u,h,c,p,d,f,m;return l(this,(function(l){switch(l.label){case 0:return n=[],[4,t.data()];case 1:return r=l.sent(),[4,e.data()];case 2:for(o=l.sent(),a=0;a<i.numBoxes;++a)if(!(null!=i.minScoreThresh&&o[a]<i.minScoreThresh||(s=a*i.numCoords,u=Y(r[s+0],r[s+1],r[s+2],r[s+3],o[a],i.flipVertically,a),(h=u.locationData.relativeBoundingBox).width<0||h.height<0))){if(i.numKeypoints>0)for((c=u.locationData).relativeKeypoints=[],p=i.numKeypoints*i.numValuesPerKeypoint,d=0;d<p;d+=i.numValuesPerKeypoint)f=s+i.keypointCoordOffset+d,m={x:r[f+0],y:i.flipVertically?1-r[f+1]:r[f+1]},c.relativeKeypoints.push(m);n.push(u)}return[2,n]}}))}))}function Y(t,e,i,n,r,o,a){return{score:[r],ind:a,locationData:{relativeBoundingBox:{xMin:e,yMin:o?1-i:t,xMax:n,yMax:o?1-t:i,width:n-e,height:i-t}}}}function Q(t,e){return"none"===t?e:function(t){return 1/(1+Math.exp(-t))}(e)}function Z(t,e,i,n){return s(this,void 0,void 0,(function(){var r,o,a,s,u,h,c,p;return l(this,(function(l){switch(l.label){case 0:return i=i||e.flipHorizontally||!1,n=n||e.flipVertically||!1,r=t.size,o=r/e.numLandmarks,[4,t.data()];case 1:for(a=l.sent(),s=[],u=0;u<e.numLandmarks;++u)h=u*o,(p={x:0,y:0}).x=i?e.inputImageWidth-a[h]:a[h],o>1&&(p.y=n?e.inputImageHeight-a[h+1]:a[h+1]),o>2&&(p.z=a[h+2]),o>3&&(p.score=Q(e.visibilityActivation,a[h+3])),s.push(p);for(c=0;c<s.length;++c)(p=s[c]).x=p.x/e.inputImageWidth,p.y=p.y/e.inputImageHeight,p.z=p.z/e.inputImageWidth/(e.normalizeZ||1);return[2,s]}}))}))}function $(t,e,i){var n=t.width,r=t.height,o=t.rotation;if(null==i.rotation&&null==i.rotationDegree||(o=function(t,e){null!=e.rotation?t+=e.rotation:null!=e.rotationDegree&&(t+=Math.PI*e.rotationDegree/180);return F(t)}(o,i)),0===o)t.xCenter=t.xCenter+n*i.shiftX,t.yCenter=t.yCenter+r*i.shiftY;else{var a=(e.width*n*i.shiftX*Math.cos(o)-e.height*r*i.shiftY*Math.sin(o))/e.width,s=(e.width*n*i.shiftX*Math.sin(o)+e.height*r*i.shiftY*Math.cos(o))/e.height;t.xCenter=t.xCenter+a,t.yCenter=t.yCenter+s}if(i.squareLong){var l=Math.max(n*e.width,r*e.height);n=l/e.width,r=l/e.height}else if(i.squareShort){var u=Math.min(n*e.width,r*e.height);n=u/e.width,r=u/e.height}return t.width=n*i.scaleX,t.height=r*i.scaleY,t}function J(t,e){return t.map((function(t){var i=a(a({},t),{x:t.x/e.width,y:t.y/e.height});return null!=t.z&&(t.z=t.z/e.width),i}))}var tt=function(){function t(t){this.alpha=t,this.initialized=!1}return t.prototype.apply=function(t,e){var i;return this.initialized?i=null==e?this.storedValue+this.alpha*(t-this.storedValue):this.storedValue+this.alpha*e*Math.asinh((t-this.storedValue)/e):(i=t,this.initialized=!0),this.rawValue=t,this.storedValue=i,i},t.prototype.applyWithAlpha=function(t,e,i){return this.alpha=e,this.apply(t,i)},t.prototype.hasLastRawValue=function(){return this.initialized},t.prototype.lastRawValue=function(){return this.rawValue},t.prototype.reset=function(){this.initialized=!1},t}(),et=function(){function t(t){this.frequency=t.frequency,this.minCutOff=t.minCutOff,this.beta=t.beta,this.thresholdCutOff=t.thresholdCutOff,this.thresholdBeta=t.thresholdBeta,this.derivateCutOff=t.derivateCutOff,this.x=new tt(this.getAlpha(this.minCutOff)),this.dx=new tt(this.getAlpha(this.derivateCutOff)),this.lastTimestamp=0}return t.prototype.apply=function(t,e,i){if(null==t)return t;var n=Math.trunc(e);if(this.lastTimestamp>=n)return t;0!==this.lastTimestamp&&0!==n&&(this.frequency=1/(1e-6*(n-this.lastTimestamp))),this.lastTimestamp=n;var r=this.x.hasLastRawValue()?(t-this.x.lastRawValue())*i*this.frequency:0,o=this.dx.applyWithAlpha(r,this.getAlpha(this.derivateCutOff)),a=this.minCutOff+this.beta*Math.abs(o),s=null!=this.thresholdCutOff?this.thresholdCutOff+this.thresholdBeta*Math.abs(o):null;return this.x.applyWithAlpha(t,this.getAlpha(a),s)},t.prototype.getAlpha=function(t){return 1/(1+this.frequency/(2*Math.PI*t))},t}(),it=function(){function t(t){this.config=t}return t.prototype.apply=function(t,e,i){var n=this;if(null==t)return this.reset(),null;this.initializeFiltersIfEmpty(t);var r=1;if(!this.config.disableValueScaling){if(i<this.config.minAllowedObjectScale)return u([],t,!0);r=1/i}return t.map((function(t,i){var o=a(a({},t),{x:n.xFilters[i].apply(t.x,e,r),y:n.yFilters[i].apply(t.y,e,r)});return null!=t.z&&(o.z=n.zFilters[i].apply(t.z,e,r)),o}))},t.prototype.reset=function(){this.xFilters=null,this.yFilters=null,this.zFilters=null},t.prototype.initializeFiltersIfEmpty=function(t){var e=this;null!=this.xFilters&&this.xFilters.length===t.length||(this.xFilters=t.map((function(t){return new et(e.config)})),this.yFilters=t.map((function(t){return new et(e.config)})),this.zFilters=t.map((function(t){return new et(e.config)})))},t}(),nt=function(){function t(t){this.config=t,this.window=[],this.lowPassFilter=new tt(1),this.lastValue=0,this.lastValueScale=1,this.lastTimestamp=-1}return t.prototype.apply=function(t,e,i){if(null==t)return t;var n,r=Math.trunc(e);if(this.lastTimestamp>=r)return t;if(-1===this.lastTimestamp)n=1;else{for(var o=t*i-this.lastValue*this.lastValueScale,a=r-this.lastTimestamp,s=o,l=a,u=(1+this.window.length)*(1e6/30),h=0,c=this.window;h<c.length;h++){var p=c[h];if(l+p.duration>u)break;s+=p.distance,l+=p.duration}var d=s/(1e-6*l);n=1-1/(1+this.config.velocityScale*Math.abs(d)),this.window.unshift({distance:o,duration:a}),this.window.length>this.config.windowSize&&this.window.pop()}return this.lastValue=t,this.lastValueScale=i,this.lastTimestamp=r,this.lowPassFilter.applyWithAlpha(t,n)},t}(),rt=function(){function t(t){this.config=t}return t.prototype.apply=function(t,e,i){var n=this;if(null==t)return this.reset(),null;var r=1;if(!this.config.disableValueScaling){if(i<this.config.minAllowedObjectScale)return u([],t,!0);r=1/i}return this.initializeFiltersIfEmpty(t),t.map((function(t,i){var o=a(a({},t),{x:n.xFilters[i].apply(t.x,e,r),y:n.yFilters[i].apply(t.y,e,r)});return null!=t.z&&(o.z=n.zFilters[i].apply(t.z,e,r)),o}))},t.prototype.reset=function(){this.xFilters=null,this.yFilters=null,this.zFilters=null},t.prototype.initializeFiltersIfEmpty=function(t){var e=this;null!=this.xFilters&&this.xFilters.length===t.length||(this.xFilters=t.map((function(t){return new nt(e.config)})),this.yFilters=t.map((function(t){return new nt(e.config)})),this.zFilters=t.map((function(t){return new nt(e.config)})))},t}(),ot=function(){function t(t){if(null!=t.velocityFilter)this.keypointsFilter=new rt(t.velocityFilter);else{if(null==t.oneEuroFilter)throw new Error("Either configure velocityFilter or oneEuroFilter, but got "+"".concat(t,"."));this.keypointsFilter=new it(t.oneEuroFilter)}}return t.prototype.apply=function(t,e,i,n,r){if(void 0===n&&(n=!1),null==t)return this.keypointsFilter.reset(),null;var o=null!=r?function(t,e){return(t.width*e.width+t.height*e.height)/2}(r,i):1,a=n?j(t,i):t,s=this.keypointsFilter.apply(a,e,o);return n?J(s,i):s},t}(),at=function(){function t(t){this.alpha=t.alpha}return t.prototype.apply=function(t){var e=this;if(null==t)return this.visibilityFilters=null,null;null!=this.visibilityFilters&&this.visibilityFilters.length===t.length||(this.visibilityFilters=t.map((function(t){return new tt(e.alpha)})));for(var i=[],n=0;n<t.length;++n){var r=t[n],o=a({},r);o.score=this.visibilityFilters[n].apply(r.score),i.push(o)}return i},t}(),st={reduceBoxesInLowestlayer:!1,interpolatedScaleAspectRatio:1,featureMapHeight:[],featureMapWidth:[],numLayers:5,minScale:.1484375,maxScale:.75,inputSizeHeight:224,inputSizeWidth:224,anchorOffsetX:.5,anchorOffsetY:.5,strides:[8,16,32,32,32],aspectRatios:[1],fixedAnchorSize:!0},lt={runtime:"tfjs",modelType:"full",enableSmoothing:!0,enableSegmentation:!1,smoothSegmentation:!0,detectorModelUrl:"https://tfhub.dev/mediapipe/tfjs-model/blazepose_3d/detector/1",landmarkModelUrl:"https://tfhub.dev/mediapipe/tfjs-model/blazepose_3d/landmark/full/2"},ut={maxPoses:1,flipHorizontal:!1},ht={applyExponentialOnBoxSize:!1,flipVertically:!1,ignoreClasses:[],numClasses:1,numBoxes:2254,numCoords:12,boxCoordOffset:0,keypointCoordOffset:4,numKeypoints:4,numValuesPerKeypoint:2,sigmoidScore:!0,scoreClippingThresh:100,reverseOutputOrder:!0,xScale:224,yScale:224,hScale:224,wScale:224,minScoreThresh:.5},ct=.3,pt={shiftX:0,shiftY:0,scaleX:1.25,scaleY:1.25,squareLong:!0},dt={outputTensorSize:{width:224,height:224},keepAspectRatio:!0,outputTensorFloatRange:[-1,1],borderMode:"zero"},ft={outputTensorSize:{width:256,height:256},keepAspectRatio:!0,outputTensorFloatRange:[0,1],borderMode:"zero"},mt={numLandmarks:39,inputImageWidth:256,inputImageHeight:256,visibilityActivation:"sigmoid",flipHorizontally:!1,flipVertically:!1},gt={numLandmarks:39,inputImageWidth:1,inputImageHeight:1,visibilityActivation:"sigmoid",flipHorizontally:!1,flipVertically:!1},yt={kernelSize:7,minConfidenceToRefine:.5},vt={alpha:.1},xt={oneEuroFilter:{frequency:30,minCutOff:.05,beta:80,derivateCutOff:1,minAllowedObjectScale:1e-6}},wt={oneEuroFilter:{frequency:30,minCutOff:.01,beta:10,derivateCutOff:1,minAllowedObjectScale:1e-6}},kt={oneEuroFilter:{frequency:30,minCutOff:.1,beta:40,derivateCutOff:1,minAllowedObjectScale:1e-6,disableValueScaling:!0}},bt={activation:"none"},Mt={combineWithPreviousRatio:.7};var St=function(){function t(t){this.mask=t}return t.prototype.toCanvasImageSource=function(){return s(this,void 0,void 0,(function(){return l(this,(function(t){return[2,y(this.mask)]}))}))},t.prototype.toImageData=function(){return s(this,void 0,void 0,(function(){return l(this,(function(t){return[2,v(this.mask)]}))}))},t.prototype.toTensor=function(){return s(this,void 0,void 0,(function(){return l(this,(function(t){return[2,this.mask]}))}))},t.prototype.getUnderlyingType=function(){return"tensor"},t}();function Tt(t){return w(t),"person"}var Pt=function(){function t(t,e,n,r,o,a){this.detectorModel=t,this.landmarkModel=e,this.enableSmoothing=n,this.enableSegmentation=r,this.smoothSegmentation=o,this.modelType=a,this.regionOfInterest=null,this.prevFilteredSegmentationMask=null,this.anchors=function(t){null==t.reduceBoxesInLowestLayer&&(t.reduceBoxesInLowestLayer=!1),null==t.interpolatedScaleAspectRatio&&(t.interpolatedScaleAspectRatio=1),null==t.fixedAnchorSize&&(t.fixedAnchorSize=!1);for(var e=[],i=0;i<t.numLayers;){for(var n=[],r=[],o=[],a=[],s=i;s<t.strides.length&&t.strides[s]===t.strides[i];){var l=L(t.minScale,t.maxScale,s,t.strides.length);if(0===s&&t.reduceBoxesInLowestLayer)o.push(1),o.push(2),o.push(.5),a.push(.1),a.push(l),a.push(l);else{for(var u=0;u<t.aspectRatios.length;++u)o.push(t.aspectRatios[u]),a.push(l);if(t.interpolatedScaleAspectRatio>0){var h=s===t.strides.length-1?1:L(t.minScale,t.maxScale,s+1,t.strides.length);a.push(Math.sqrt(l*h)),o.push(t.interpolatedScaleAspectRatio)}}s++}for(var c=0;c<o.length;++c){var p=Math.sqrt(o[c]);n.push(a[c]/p),r.push(a[c]*p)}var d=0,f=0;if(t.featureMapHeight.length>0)d=t.featureMapHeight[i],f=t.featureMapWidth[i];else{var m=t.strides[i];d=Math.ceil(t.inputSizeHeight/m),f=Math.ceil(t.inputSizeWidth/m)}for(var g=0;g<d;++g)for(var y=0;y<f;++y)for(var v=0;v<n.length;++v){var x={xCenter:(y+t.anchorOffsetX)/f,yCenter:(g+t.anchorOffsetY)/d,width:0,height:0};t.fixedAnchorSize?(x.width=1,x.height=1):(x.width=r[v],x.height=n[v]),e.push(x)}i=s}return e}(st);var s=i.tensor1d(this.anchors.map((function(t){return t.width}))),l=i.tensor1d(this.anchors.map((function(t){return t.height}))),u=i.tensor1d(this.anchors.map((function(t){return t.xCenter}))),h=i.tensor1d(this.anchors.map((function(t){return t.yCenter})));this.anchorTensor={x:u,y:h,w:s,h:l},this.prevFilteredSegmentationMask=this.enableSegmentation?i.tensor2d([],[0,0]):null}return t.prototype.estimatePoses=function(t,e,n){return s(this,void 0,void 0,(function(){var r,o,s,u,h,p,d,f,m,g,y,v,x,w,k,b,M,S,T,F,z,O,A;return l(this,(function(l){switch(l.label){case 0:return r=function(t){var e;if(null==(e=null==t?ut:a({},t)).maxPoses&&(e.maxPoses=1),e.maxPoses<=0)throw new Error("Invalid maxPoses ".concat(e.maxPoses,". Should be > 0."));if(e.maxPoses>1)throw new Error("Multi-pose detection is not implemented yet. Please set maxPoses to 1.");return e}(e),null==t?(this.reset(),[2,[]]):(this.maxPoses=r.maxPoses,this.timestamp=null!=n?1e3*n:N(t)?1e6*t.currentTime:null,o=P(t),s=i.tidy((function(){return i.cast(_(t),"float32")})),null!=(u=this.regionOfInterest)?[3,2]:[4,this.detectPose(s)]);case 1:if(0===(h=l.sent()).length)return this.reset(),s.dispose(),[2,[]];p=h[0],u=this.poseDetectionToRoi(p,o),l.label=2;case 2:return[4,this.poseLandmarksByRoi(u,s)];case 3:return d=l.sent(),s.dispose(),null==d?(this.reset(),[2,[]]):(f=d.landmarks,m=d.auxiliaryLandmarks,g=d.poseScore,y=d.worldLandmarks,v=d.segmentationMask,x=this.poseLandmarkFiltering(f,m,y,o),w=x.actualLandmarksFiltered,k=x.auxiliaryLandmarksFiltered,b=x.actualWorldLandmarksFiltered,M=this.poseLandmarksToRoi(k,o),this.regionOfInterest=M,S=this.smoothSegmentation&&null!=v?this.poseSegmentationFiltering(v):v,null!=(T=null!=w?j(w,o):null)&&T.forEach((function(t,e){t.name=c[e]})),null!=(F=b)&&F.forEach((function(t,e){t.name=c[e]})),z={score:g,keypoints:T,keypoints3D:F},null!==S&&(O=i.tidy((function(){var t=i.expandDims(S,2),e=i.pad(t,[[0,0],[0,0],[0,1]]);return i.mirrorPad(e,[[0,0],[0,0],[0,2]],"symmetric")})),this.smoothSegmentation||i.dispose(S),A={maskValueToLabel:Tt,mask:new St(O)},z.segmentation=A),[2,[z]])}}))}))},t.prototype.poseSegmentationFiltering=function(t){var e=this.prevFilteredSegmentationMask;return 0===e.size?this.prevFilteredSegmentationMask=t:(this.prevFilteredSegmentationMask=X(e,t,Mt),i.dispose(t)),i.dispose(e),this.prevFilteredSegmentationMask},t.prototype.dispose=function(){this.detectorModel.dispose(),this.landmarkModel.dispose(),i.dispose([this.anchorTensor.x,this.anchorTensor.y,this.anchorTensor.w,this.anchorTensor.h,this.prevFilteredSegmentationMask])},t.prototype.reset=function(){this.regionOfInterest=null,this.enableSegmentation&&(i.dispose(this.prevFilteredSegmentationMask),this.prevFilteredSegmentationMask=i.tensor2d([],[0,0])),this.visibilitySmoothingFilterActual=null,this.visibilitySmoothingFilterAuxiliary=null,this.landmarksSmoothingFilterActual=null,this.landmarksSmoothingFilterAuxiliary=null},t.prototype.detectPose=function(t){return s(this,void 0,void 0,(function(){var e,n,r,o,a,s,u,h,c,p;return l(this,(function(l){switch(l.label){case 0:return e=B(t,dt),n=e.imageTensor,r=e.padding,o=this.detectorModel.predict(n),a=D(o),s=a.boxes,[4,W([u=a.logits,s],this.anchorTensor,ht)];case 1:return 0===(h=l.sent()).length?(i.dispose([n,o,u,s]),[2,h]):[4,K(h,this.maxPoses,ct)];case 2:return c=l.sent(),p=function(t,e){void 0===t&&(t=[]);for(var i=e.left,n=e.top,r=e.left+e.right,o=e.top+e.bottom,a=0;a<t.length;a++){var s=t[a],l=s.locationData.relativeBoundingBox,u=(l.xMin-i)/(1-r),h=(l.yMin-n)/(1-o),c=l.width/(1-r),p=l.height/(1-o);l.xMin=u,l.yMin=h,l.width=c,l.height=p,l.xMax=u+c,l.yMax=h+p;var d=s.locationData.relativeKeypoints;d&&d.forEach((function(t){var e=(t.x-i)/(1-r),a=(t.y-n)/(1-o);t.x=e,t.y=a}))}return t}(c,r),i.dispose([n,o,u,s]),[2,p]}}))}))},t.prototype.poseDetectionToRoi=function(t,e){return 0,1,$(A(t,e,{rotationVectorEndKeypointIndex:1,rotationVectorStartKeypointIndex:0,rotationVectorTargetAngleDegree:90}),e,pt)},t.prototype.poseLandmarksByRoi=function(t,e){return s(this,void 0,void 0,(function(){var n,r,o,s,u,h,c,p,d,f,m,g,y,v;return l(this,(function(l){switch(l.label){case 0:if(n=P(e),r=B(e,ft,t),o=r.imageTensor,s=r.padding,u=r.transformationMatrix,"lite"!==this.modelType&&"full"!==this.modelType&&"heavy"!==this.modelType)throw new Error("Model type must be one of lite, full or heavy,"+"but got ".concat(this.modelType));return h=["ld_3d","output_poseflag","activation_heatmap","world_3d"],this.enableSegmentation&&h.push("activation_segmentation"),c=this.landmarkModel.execute(o,h),[4,this.tensorsToPoseLandmarksAndSegmentation(c)];case 1:return null==(p=l.sent())?(i.dispose(c),i.dispose(o),[2,null]):(d=p.landmarks,f=p.auxiliaryLandmarks,m=p.poseScore,g=p.worldLandmarks,y=p.segmentationMask,[4,this.poseLandmarksAndSegmentationInverseProjection(n,t,s,u,d,f,g,y)]);case 2:return v=l.sent(),i.dispose(c),i.dispose(o),[2,a({poseScore:m},v)]}}))}))},t.prototype.poseLandmarksAndSegmentationInverseProjection=function(t,e,n,r,o,u,h,c){return s(this,void 0,void 0,(function(){var s,p,d,f,m,g;return l(this,(function(l){return s=U(o,n),p=U(u,n),d=E(s,e),f=E(p,e),m=function(t,e){for(var i=[],n=0,r=t;n<r.length;n++){var o=r[n],s=o.x,l=o.y,u=e.rotation,h=Math.cos(u)*s-Math.sin(u)*l,c=Math.sin(u)*s+Math.cos(u)*l,p=a({},o);p.x=h,p.y=c,i.push(p)}return i}(h,e),g=null,this.enableSegmentation&&(g=i.tidy((function(){var e=c.shape,n=e[0],o=e[1],a=function(t){var e=C(new Array(16).fill(0));e[0][0]=R(t,0,0),e[1][0]=-R(t,0,1),e[2][0]=R(t,0,2),e[3][0]=-R(t,0,3),e[0][2]=R(t,2,0),e[1][2]=-R(t,2,1),e[2][2]=R(t,2,2),e[3][2]=-R(t,2,3),e[0][1]=-R(t,1,0),e[1][1]=R(t,1,1),e[2][1]=-R(t,1,2),e[3][1]=R(t,1,3),e[0][3]=-R(t,3,0),e[1][3]=R(t,3,1),e[2][3]=-R(t,3,2),e[3][3]=R(t,3,3);for(var i=t[0][0]*e[0][0]+t[1][0]*e[0][1]+t[2][0]*e[0][2]+t[3][0]*e[0][3],n=0;n<e.length;n++)for(var r=0;r<e.length;r++)e[n][r]/=i;return e}(r),s=i.tensor2d(z(a,{width:o,height:n},t),[1,8]),l=[1,n,o,1];return i.squeeze(i.image.transform(i.reshape(c,l),s,"bilinear","constant",0,[t.height,t.width]),[0,3])})),i.dispose(c)),[2,{landmarks:d,auxiliaryLandmarks:f,worldLandmarks:m,segmentationMask:g}]}))}))},t.prototype.tensorsToPoseLandmarksAndSegmentation=function(t){return s(this,void 0,void 0,(function(){var e,n,r,o,s,u,h,c,p,d,f,m,g;return l(this,(function(l){switch(l.label){case 0:return e=t[0],n=t[1],r=t[2],o=t[3],s=this.enableSegmentation?t[4]:null,[4,n.data()];case 1:return(u=l.sent()[0])<.5?[2,null]:[4,Z(e,mt)];case 2:return[4,H(l.sent(),r,yt)];case 3:return h=l.sent(),c=h.slice(0,33),p=h.slice(33,35),[4,Z(o,gt)];case 4:return d=l.sent(),f=d.slice(0,33),m=function(t,e,i){void 0===i&&(i=!0);for(var n=[],r=0;r<t.length;r++){var o=a({},e[r]);i&&(o.score=t[r].score),n.push(o)}return n}(c,f,!0),g=this.enableSegmentation?function(t,e,n){return i.tidy((function(){var r=i.squeeze(t,[0]),o=r.shape[2];if(1===o){var a=r;switch(e.activation){case"none":break;case"sigmoid":a=i.sigmoid(a);break;case"softmax":throw new Error("Softmax activation requires two channels.");default:throw new Error("Activation not supported (".concat(e.activation,")"))}var s=n?i.image.resizeBilinear(a,[n.height,n.width]):a;return i.squeeze(s,[2])}throw new Error("Unsupported number of tensor channels ".concat(o))}))}(s,bt):null,[2,{landmarks:c,auxiliaryLandmarks:p,poseScore:u,worldLandmarks:m,segmentationMask:g}]}}))}))},t.prototype.poseLandmarksToRoi=function(t,e){return $(A(q(t),e,{rotationVectorStartKeypointIndex:0,rotationVectorEndKeypointIndex:1,rotationVectorTargetAngleDegree:90}),e,pt)},t.prototype.poseLandmarkFiltering=function(t,e,i,n){var r,o,a;if(null!=this.timestamp&&this.enableSmoothing){var s=A(q(e),n,{rotationVectorEndKeypointIndex:0,rotationVectorStartKeypointIndex:1,rotationVectorTargetAngleDegree:90});null==this.visibilitySmoothingFilterActual&&(this.visibilitySmoothingFilterActual=new at(vt)),r=this.visibilitySmoothingFilterActual.apply(t),null==this.visibilitySmoothingFilterAuxiliary&&(this.visibilitySmoothingFilterAuxiliary=new at(vt)),o=this.visibilitySmoothingFilterAuxiliary.apply(e),a=this.visibilitySmoothingFilterActual.apply(i),null==this.landmarksSmoothingFilterActual&&(this.landmarksSmoothingFilterActual=new ot(xt)),r=this.landmarksSmoothingFilterActual.apply(r,this.timestamp,n,!0,s),null==this.landmarksSmoothingFilterAuxiliary&&(this.landmarksSmoothingFilterAuxiliary=new ot(wt)),o=this.landmarksSmoothingFilterAuxiliary.apply(o,this.timestamp,n,!0,s),null==this.worldLandmarksSmoothingFilterActual&&(this.worldLandmarksSmoothingFilterActual=new ot(kt)),a=this.worldLandmarksSmoothingFilterActual.apply(i,this.timestamp)}else r=t,o=e,a=i;return{actualLandmarksFiltered:r,auxiliaryLandmarksFiltered:o,actualWorldLandmarksFiltered:a}},t}();function Ft(t){return s(this,void 0,void 0,(function(){var e,i,r,o,s,u;return l(this,(function(l){switch(l.label){case 0:return e=function(t){var e=a({},null==t?lt:t);if(null==e.enableSmoothing&&(e.enableSmoothing=lt.enableSmoothing),null==e.enableSegmentation&&(e.enableSegmentation=lt.enableSegmentation),null==e.smoothSegmentation&&(e.smoothSegmentation=lt.smoothSegmentation),null==e.modelType&&(e.modelType=lt.modelType),null==e.detectorModelUrl&&(e.detectorModelUrl=lt.detectorModelUrl),null==e.landmarkModelUrl)switch(e.modelType){case"lite":e.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazepose_3d/landmark/lite/2";break;case"heavy":e.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazepose_3d/landmark/heavy/2";break;case"full":default:e.landmarkModelUrl="https://tfhub.dev/mediapipe/tfjs-model/blazepose_3d/landmark/full/2"}return e}(t),i="string"==typeof e.detectorModelUrl&&e.detectorModelUrl.indexOf("https://tfhub.dev")>-1,r="string"==typeof e.landmarkModelUrl&&e.landmarkModelUrl.indexOf("https://tfhub.dev")>-1,[4,Promise.all([n.loadGraphModel(e.detectorModelUrl,{fromTFHub:i}),n.loadGraphModel(e.landmarkModelUrl,{fromTFHub:r})])];case 1:return o=l.sent(),s=o[0],u=o[1],[2,new Pt(s,u,e.enableSmoothing,e.enableSegmentation,e.smoothSegmentation,e.modelType)]}}))}))}var _t,zt,Ot=function(){function t(t){!function(t){if(t.maxTracks<1)throw new Error("Must specify 'maxTracks' to be at least 1, but "+"encountered ".concat(t.maxTracks));if(t.maxAge<=0)throw new Error("Must specify 'maxAge' to be positive, but "+"encountered ".concat(t.maxAge));if(void 0!==t.keypointTrackerParams){if(t.keypointTrackerParams.keypointConfidenceThreshold<0||t.keypointTrackerParams.keypointConfidenceThreshold>1)throw new Error("Must specify 'keypointConfidenceThreshold' to be in the range [0, 1], but encountered "+"".concat(t.keypointTrackerParams.keypointConfidenceThreshold));if(t.keypointTrackerParams.minNumberOfKeypoints<1)throw new Error("Must specify 'minNumberOfKeypoints' to be at least 1, but "+"encountered ".concat(t.keypointTrackerParams.minNumberOfKeypoints));for(var e=0,i=t.keypointTrackerParams.keypointFalloff;e<i.length;e++){var n=i[e];if(n<=0)throw new Error("Must specify each keypoint falloff parameterto be positive "+"but encountered ".concat(n))}}}(t),this.tracks=[],this.maxTracks=t.maxTracks,this.maxAge=1e3*t.maxAge,this.minSimilarity=t.minSimilarity,this.nextID=1}return t.prototype.apply=function(t,e){this.filterOldTracks(e);var i=this.computeSimilarity(t);return this.assignTracks(t,i,e),this.updateTracks(e),t},t.prototype.getTracks=function(){return this.tracks.slice()},t.prototype.getTrackIDs=function(){return new Set(this.tracks.map((function(t){return t.id})))},t.prototype.filterOldTracks=function(t){var e=this;this.tracks=this.tracks.filter((function(i){return t-i.lastTimestamp<=e.maxAge}))},t.prototype.assignTracks=function(t,e,i){for(var n=Array.from(Array(e[0].length).keys()),r=[],o=0,a=Array.from(Array(t.length).keys());o<a.length;o++){var s=a[o];if(0!==n.length){for(var l=-1,u=-1,h=0,c=n;h<c.length;h++){var p=c[h],d=e[s][p];d>=this.minSimilarity&&d>u&&(l=p,u=d)}if(l>=0){var f=this.tracks[l];f=Object.assign(f,this.createTrack(t[s],i,f.id)),t[s].id=f.id;var m=n.indexOf(l);n.splice(m,1)}else r.push(s)}else r.push(s)}for(var g=0,y=r;g<y.length;g++){s=y[g];var v=this.createTrack(t[s],i);this.tracks.push(v),t[s].id=v.id}},t.prototype.updateTracks=function(t){this.tracks.sort((function(t,e){return e.lastTimestamp-t.lastTimestamp})),this.tracks=this.tracks.slice(0,this.maxTracks)},t.prototype.createTrack=function(t,e,i){var n={id:i||this.nextTrackID(),lastTimestamp:e,keypoints:u([],t.keypoints,!0).map((function(t){return a({},t)}))};return void 0!==t.box&&(n.box=a({},t.box)),n},t.prototype.nextTrackID=function(){var t=this.nextID;return this.nextID+=1,t},t.prototype.remove=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.tracks=this.tracks.filter((function(e){return!t.includes(e.id)}))},t.prototype.reset=function(){this.tracks=[]},t}(),At=function(t){function e(e){return t.call(this,e)||this}return o(e,t),e.prototype.computeSimilarity=function(t){var e=this;return 0===t.length||0===this.tracks.length?[[]]:t.map((function(t){return e.tracks.map((function(i){return e.iou(t,i)}))}))},e.prototype.iou=function(t,e){var i=Math.max(t.box.xMin,e.box.xMin),n=Math.max(t.box.yMin,e.box.yMin),r=Math.min(t.box.xMax,e.box.xMax),o=Math.min(t.box.yMax,e.box.yMax);if(i>=r||n>=o)return 0;var a=(r-i)*(o-n);return a/(t.box.width*t.box.height+e.box.width*e.box.height-a)},e}(Ot),Ct=function(t){function e(e){var i=t.call(this,e)||this;return i.keypointThreshold=e.keypointTrackerParams.keypointConfidenceThreshold,i.keypointFalloff=e.keypointTrackerParams.keypointFalloff,i.minNumKeyoints=e.keypointTrackerParams.minNumberOfKeypoints,i}return o(e,t),e.prototype.computeSimilarity=function(t){if(0===t.length||0===this.tracks.length)return[[]];for(var e=[],i=0,n=t;i<n.length;i++){for(var r=n[i],o=[],a=0,s=this.tracks;a<s.length;a++){var l=s[a];o.push(this.oks(r,l))}e.push(o)}return e},e.prototype.oks=function(t,e){for(var i=this.area(e.keypoints)+1e-6,n=0,r=0,o=0;o<t.keypoints.length;++o){var a=t.keypoints[o],s=e.keypoints[o];if(!(a.score<this.keypointThreshold||s.score<this.keypointThreshold)){r+=1;var l=Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2),u=2*this.keypointFalloff[o];n+=Math.exp(-1*l/(2*i*Math.pow(u,2)))}}return r<this.minNumKeyoints?0:n/r},e.prototype.area=function(t){var e=this,i=t.filter((function(t){return t.score>e.keypointThreshold})),n=Math.min.apply(Math,u([1],i.map((function(t){return t.x})),!1)),r=Math.max.apply(Math,u([0],i.map((function(t){return t.x})),!1)),o=Math.min.apply(Math,u([1],i.map((function(t){return t.y})),!1));return(r-n)*(Math.max.apply(Math,u([0],i.map((function(t){return t.y})),!1))-o)},e}(Ot);function It(e){switch(e){case t.SupportedModels.BlazePose:return c.reduce((function(t,e,i){return t[e]=i,t}),{});case t.SupportedModels.PoseNet:case t.SupportedModels.MoveNet:return h.reduce((function(t,e,i){return t[e]=i,t}),{});default:throw new Error("Model ".concat(e," is not supported."))}}(_t=t.TrackerType||(t.TrackerType={})).Keypoint="keypoint",_t.BoundingBox="boundingBox",(zt=t.SupportedModels||(t.SupportedModels={})).MoveNet="MoveNet",zt.BlazePose="BlazePose",zt.PoseNet="PoseNet";var Rt=Object.freeze({__proto__:null,getKeypointIndexBySide:function(e){switch(e){case t.SupportedModels.BlazePose:return p;case t.SupportedModels.PoseNet:case t.SupportedModels.MoveNet:return d;default:throw new Error("Model ".concat(e," is not supported."))}},getAdjacentPairs:function(e){switch(e){case t.SupportedModels.BlazePose:return m;case t.SupportedModels.PoseNet:case t.SupportedModels.MoveNet:return f;default:throw new Error("Model ".concat(e," is not supported."))}},getKeypointIndexByName:It}),Et=["SinglePose.Lightning","SinglePose.Thunder","MultiPose.Lightning"],Vt={modelType:"SinglePose.Lightning",enableSmoothing:!0},Bt={},Lt={frequency:30,minCutOff:2.5,beta:300,derivateCutOff:2.5,thresholdCutOff:.5,thresholdBeta:5,disableValueScaling:!0},Dt={maxTracks:18,maxAge:1e3,minSimilarity:.2,keypointTrackerParams:{keypointConfidenceThreshold:.3,keypointFalloff:[.026,.025,.025,.035,.035,.079,.079,.072,.072,.062,.062,.107,.107,.087,.087,.089,.089],minNumberOfKeypoints:4}},Nt={maxTracks:18,maxAge:1e3,minSimilarity:.15,trackerParams:{}};function qt(t,e,i,n){for(var r={},o=0,a=h;o<a.length;o++){var s=a[o];r[s]=[e[i[s]].y*n.height,e[i[s]].x*n.width]}if(function(t,e){return(t[e.left_hip].score>.2||t[e.right_hip].score>.2)&&(t[e.left_shoulder].score>.2||t[e.right_shoulder].score>.2)}(e,i)){var l=(r.left_hip[0]+r.right_hip[0])/2,u=(r.left_hip[1]+r.right_hip[1])/2,c=function(t,e,i,n,r){for(var o=["left_shoulder","right_shoulder","left_hip","right_hip"],a=0,s=0,l=0;l<o.length;l++){(d=Math.abs(n-i[o[l]][0]))>a&&(a=d),(f=Math.abs(r-i[o[l]][1]))>s&&(s=f)}for(var u=0,h=0,c=0,p=Object.keys(i);c<p.length;c++){var d,f,m=p[c];if(!(t[e[m]].score<.2))(d=Math.abs(n-i[m][0]))>u&&(u=d),(f=Math.abs(r-i[m][1]))>h&&(h=f)}return[a,s,u,h]}(e,i,r,l,u),p=c[0],d=c[1],f=c[2],m=c[3],g=Math.max(1.9*d,1.9*p,1.2*f,1.2*m),y=[l-(g=Math.min(g,Math.max(u,n.width-u,l,n.height-l))),u-g];if(g>Math.max(n.width,n.height)/2)return Kt(null==t,n);var v=2*g;return{yMin:y[0]/n.height,xMin:y[1]/n.width,yMax:(y[0]+v)/n.height,xMax:(y[1]+v)/n.width,height:(y[0]+v)/n.height-y[0]/n.height,width:(y[1]+v)/n.width-y[1]/n.width}}return Kt(null==t,n)}function Kt(t,e){var i,n,r,o;return t?e.width>e.height?(i=1,n=e.height/e.width,r=0,o=(e.width/2-e.height/2)/e.width):(i=e.width/e.height,n=1,r=(e.height/2-e.width/2)/e.height,o=0):e.width>e.height?(i=e.width/e.height,n=1,r=(e.height/2-e.width/2)/e.height,o=0):(i=1,n=e.height/e.width,r=0,o=(e.width/2-e.height/2)/e.width),{yMin:r,xMin:o,yMax:r+i,xMax:o+n,height:i,width:n}}function jt(e){var i,n=null==e?Vt:a({},e);if(null==n.modelType)n.modelType="SinglePose.Lightning";else if(Et.indexOf(n.modelType)<0)throw new Error("Invalid architecture ".concat(n.modelType,". ")+"Should be one of ".concat(Et));if(null==n.enableSmoothing&&(n.enableSmoothing=!0),null!=n.minPoseScore&&(n.minPoseScore<0||n.minPoseScore>1))throw new Error("minPoseScore should be between 0.0 and 1.0");if(null!=n.multiPoseMaxDimension&&(n.multiPoseMaxDimension%32!=0||n.multiPoseMaxDimension<32))throw new Error("multiPoseMaxDimension must be a multiple of 32 and higher than 0");if("MultiPose.Lightning"===n.modelType&&null==n.enableTracking&&(n.enableTracking=!0),"MultiPose.Lightning"===n.modelType&&!0===n.enableTracking)if(null==n.trackerType&&(n.trackerType=t.TrackerType.BoundingBox),n.trackerType===t.TrackerType.Keypoint)null!=n.trackerConfig?n.trackerConfig=function(t){var e=Ht(Dt,t);e.keypointTrackerParams=a({},Dt.keypointTrackerParams),null!=t.keypointTrackerParams&&(null!=t.keypointTrackerParams.keypointConfidenceThreshold&&(e.keypointTrackerParams.keypointConfidenceThreshold=t.keypointTrackerParams.keypointConfidenceThreshold),null!=t.keypointTrackerParams.keypointFalloff&&(e.keypointTrackerParams.keypointFalloff=t.keypointTrackerParams.keypointFalloff),null!=t.keypointTrackerParams.minNumberOfKeypoints&&(e.keypointTrackerParams.minNumberOfKeypoints=t.keypointTrackerParams.minNumberOfKeypoints));return e}(n.trackerConfig):n.trackerConfig=Dt;else{if(n.trackerType!==t.TrackerType.BoundingBox)throw new Error("Tracker type not supported by MoveNet");null!=n.trackerConfig?n.trackerConfig=(i=n.trackerConfig,Ht(Nt,i)):n.trackerConfig=Nt}return n}function Ht(t,e){var i={maxTracks:t.maxTracks,maxAge:t.maxAge,minSimilarity:t.minSimilarity};return null!=e.maxTracks&&(i.maxTracks=e.maxTracks),null!=e.maxAge&&(i.maxAge=e.maxAge),null!=e.minSimilarity&&(i.minSimilarity=e.minSimilarity),i}var Ut=function(){function e(e,i){this.moveNetModel=e,this.modelInputResolution={height:0,width:0},this.keypointIndexByName=It(t.SupportedModels.MoveNet),"SinglePose.Lightning"===i.modelType?(this.modelInputResolution.width=192,this.modelInputResolution.height=192):"SinglePose.Thunder"===i.modelType&&(this.modelInputResolution.width=256,this.modelInputResolution.height=256),this.multiPoseModel="MultiPose.Lightning"===i.modelType,this.multiPoseModel||(this.keypointFilter=new it(Lt),this.cropRegionFilterYMin=new tt(.9),this.cropRegionFilterXMin=new tt(.9),this.cropRegionFilterYMax=new tt(.9),this.cropRegionFilterXMax=new tt(.9)),this.enableSmoothing=i.enableSmoothing,i.minPoseScore?this.minPoseScore=i.minPoseScore:this.minPoseScore=.25,i.multiPoseMaxDimension?this.multiPoseMaxDimension=i.multiPoseMaxDimension:this.multiPoseMaxDimension=256,this.enableTracking=i.enableTracking,this.multiPoseModel&&this.enableTracking&&(i.trackerType===t.TrackerType.Keypoint?this.tracker=new Ct(i.trackerConfig):i.trackerType===t.TrackerType.BoundingBox&&(this.tracker=new At(i.trackerConfig)),this.enableSmoothing&&(this.keypointFilterMap=new Map))}return e.prototype.runSinglePersonPoseModel=function(t){return s(this,void 0,void 0,(function(){var e,n,r,o,a;return l(this,(function(s){switch(s.label){case 0:if(4!==(e=this.moveNetModel.execute(t)).shape.length||1!==e.shape[0]||1!==e.shape[1]||17!==e.shape[2]||3!==e.shape[3])throw e.dispose(),new Error("Unexpected output shape from model: [".concat(e.shape,"]"));return"webgpu"===i.getBackend()?[3,1]:(n=e.dataSync(),[3,3]);case 1:return[4,e.data()];case 2:n=s.sent(),s.label=3;case 3:for(e.dispose(),r={keypoints:[],score:0},o=0,a=0;a<17;++a)r.keypoints[a]={y:n[3*a],x:n[3*a+1],score:n[3*a+2]},r.keypoints[a].score>.2&&(++o,r.score+=r.keypoints[a].score);return o>0&&(r.score/=o),[2,r]}}))}))},e.prototype.runMultiPersonPoseModel=function(t){return s(this,void 0,void 0,(function(){var e,n,r,o,a,s,u,h;return l(this,(function(l){switch(l.label){case 0:if(3!==(e=this.moveNetModel.execute(t)).shape.length||1!==e.shape[0]||56!==e.shape[2])throw e.dispose(),new Error("Unexpected output shape from model: [".concat(e.shape,"]"));return"webgpu"===i.getBackend()?[3,1]:(n=e.dataSync(),[3,3]);case 1:return[4,e.data()];case 2:n=l.sent(),l.label=3;case 3:for(e.dispose(),r=[],o=n.length/56,a=0;a<o;++a)for(r[a]={keypoints:[]},s=56*a+51,r[a].box={yMin:n[s],xMin:n[s+1],yMax:n[s+2],xMax:n[s+3],width:n[s+3]-n[s+1],height:n[s+2]-n[s]},u=56*a+55,r[a].score=n[u],r[a].keypoints=[],h=0;h<17;++h)r[a].keypoints[h]={y:n[56*a+3*h],x:n[56*a+3*h+1],score:n[56*a+3*h+2]};return[2,r]}}))}))},e.prototype.estimatePoses=function(t,e,n){return void 0===e&&(e=Bt),s(this,void 0,void 0,(function(){var r,o,s,u,c,p;return l(this,(function(l){switch(l.label){case 0:return e=function(t){return null==t?Bt:a({},t)}(e),null==t?(this.reset(),[2,[]]):(null==n?N(t)&&(n=1e6*t.currentTime):n*=1e3,r=_(t),o=P(r),s=i.expandDims(r,0),t instanceof i.Tensor||r.dispose(),u=[],this.multiPoseModel?[3,2]:[4,this.estimateSinglePose(s,o,n)]);case 1:return u=l.sent(),[3,4];case 2:return[4,this.estimateMultiplePoses(s,o,n)];case 3:u=l.sent(),l.label=4;case 4:for(c=0;c<u.length;++c)for(p=0;p<u[c].keypoints.length;++p)u[c].keypoints[p].name=h[p],u[c].keypoints[p].y*=o.height,u[c].keypoints[p].x*=o.width;return[2,u]}}))}))},e.prototype.estimateSinglePose=function(t,e,n){return s(this,void 0,void 0,(function(){var r,o,a,s,u=this;return l(this,(function(l){switch(l.label){case 0:return this.cropRegion||(this.cropRegion=Kt(null==this.cropRegion,e)),r=i.tidy((function(){var e=i.tensor2d([[u.cropRegion.yMin,u.cropRegion.xMin,u.cropRegion.yMax,u.cropRegion.xMax]]),n=i.zeros([1],"int32"),r=[u.modelInputResolution.height,u.modelInputResolution.width];return i.cast(i.image.cropAndResize(t,e,n,r,"bilinear",0),"int32")})),t.dispose(),[4,this.runSinglePersonPoseModel(r)];case 1:if(o=l.sent(),r.dispose(),o.score<this.minPoseScore)return this.reset(),[2,[]];for(a=0;a<o.keypoints.length;++a)o.keypoints[a].y=this.cropRegion.yMin+o.keypoints[a].y*this.cropRegion.height,o.keypoints[a].x=this.cropRegion.xMin+o.keypoints[a].x*this.cropRegion.width;return null!=n&&this.enableSmoothing&&(o.keypoints=this.keypointFilter.apply(o.keypoints,n,1)),s=qt(this.cropRegion,o.keypoints,this.keypointIndexByName,e),this.cropRegion=this.filterCropRegion(s),[2,[o]]}}))}))},e.prototype.estimateMultiplePoses=function(t,e,n){return s(this,void 0,void 0,(function(){var r,o,a,s,u,h,c,p,d,f,m,g=this;return l(this,(function(l){switch(l.label){case 0:return 32,e.width>e.height?(o=this.multiPoseMaxDimension,a=Math.round(this.multiPoseMaxDimension*e.height/e.width),r=i.image.resizeBilinear(t,[a,o]),u=o,h=32*Math.ceil(a/32),s=i.pad(r,[[0,0],[0,h-a],[0,0],[0,0]])):(o=Math.round(this.multiPoseMaxDimension*e.width/e.height),a=this.multiPoseMaxDimension,r=i.image.resizeBilinear(t,[a,o]),u=32*Math.ceil(o/32),h=a,s=i.pad(r,[[0,0],[0,0],[0,u-o],[0,0]])),r.dispose(),t.dispose(),c=i.cast(s,"int32"),s.dispose(),[4,this.runMultiPersonPoseModel(c)];case 1:for(p=l.sent(),c.dispose(),p=p.filter((function(t){return t.score>=g.minPoseScore})),f=0;f<p.length;++f)for(d=0;d<p[f].keypoints.length;++d)p[f].keypoints[d].y*=h/a,p[f].keypoints[d].x*=u/o;if(this.enableTracking&&(this.tracker.apply(p,n),this.enableSmoothing)){for(f=0;f<p.length;++f)this.keypointFilterMap.has(p[f].id)||this.keypointFilterMap.set(p[f].id,new it(Lt)),p[f].keypoints=this.keypointFilterMap.get(p[f].id).apply(p[f].keypoints,n,1);m=this.tracker.getTrackIDs(),this.keypointFilterMap.forEach((function(t,e){m.has(e)||g.keypointFilterMap.delete(e)}))}return[2,p]}}))}))},e.prototype.filterCropRegion=function(t){if(t){var e=this.cropRegionFilterYMin.apply(t.yMin),i=this.cropRegionFilterXMin.apply(t.xMin),n=this.cropRegionFilterYMax.apply(t.yMax),r=this.cropRegionFilterXMax.apply(t.xMax);return{yMin:e,xMin:i,yMax:n,xMax:r,height:n-e,width:r-i}}return this.cropRegionFilterYMin.reset(),this.cropRegionFilterXMin.reset(),this.cropRegionFilterYMax.reset(),this.cropRegionFilterXMax.reset(),null},e.prototype.dispose=function(){this.moveNetModel.dispose()},e.prototype.reset=function(){this.cropRegion=null,this.resetFilters()},e.prototype.resetFilters=function(){this.keypointFilter.reset(),this.cropRegionFilterYMin.reset(),this.cropRegionFilterXMin.reset(),this.cropRegionFilterYMax.reset(),this.cropRegionFilterXMax.reset()},e}();function Xt(t){return void 0===t&&(t=Vt),s(this,void 0,void 0,(function(){var e,r,o,a;return l(this,(function(s){switch(s.label){case 0:return e=jt(t),o=!0,e.modelUrl?(o="string"==typeof e.modelUrl&&e.modelUrl.indexOf("https://tfhub.dev")>-1,[4,n.loadGraphModel(e.modelUrl,{fromTFHub:o})]):[3,2];case 1:return r=s.sent(),[3,4];case 2:return a=void 0,"SinglePose.Lightning"===e.modelType?a="https://tfhub.dev/google/tfjs-model/movenet/singlepose/lightning/4":"SinglePose.Thunder"===e.modelType?a="https://tfhub.dev/google/tfjs-model/movenet/singlepose/thunder/4":"MultiPose.Lightning"===e.modelType&&(a="https://tfhub.dev/google/tfjs-model/movenet/multipose/lightning/1"),[4,n.loadGraphModel(a,{fromTFHub:o})];case 3:r=s.sent(),s.label=4;case 4:return"webgl"===i.getBackend()&&i.env().set("TOPK_LAST_DIM_CPU_HANDOFF_SIZE_THRESHOLD",0),[2,new Ut(r,e)]}}))}))}var Wt={architecture:"MobileNetV1",outputStride:16,multiplier:.75,inputResolution:{height:257,width:257}},Gt=["MobileNetV1","ResNet50"],Yt={MobileNetV1:[8,16],ResNet50:[16]},Qt=[8,16,32],Zt={MobileNetV1:[.5,.75,1],ResNet50:[1]},$t=[1,2,4],Jt={maxPoses:1,flipHorizontal:!1},te={maxPoses:5,flipHorizontal:!1,scoreThreshold:.5,nmsRadius:20},ee=[-123.15,-115.9,-103.06];function ie(t){return Math.floor(t/2)}var ne=function(){function t(t,e){this.priorityQueue=new Array(t),this.numberOfElements=-1,this.getElementValue=e}return t.prototype.enqueue=function(t){this.priorityQueue[++this.numberOfElements]=t,this.swim(this.numberOfElements)},t.prototype.dequeue=function(){var t=this.priorityQueue[0];return this.exchange(0,this.numberOfElements--),this.sink(0),this.priorityQueue[this.numberOfElements+1]=null,t},t.prototype.empty=function(){return-1===this.numberOfElements},t.prototype.size=function(){return this.numberOfElements+1},t.prototype.all=function(){return this.priorityQueue.slice(0,this.numberOfElements+1)},t.prototype.max=function(){return this.priorityQueue[0]},t.prototype.swim=function(t){for(;t>0&&this.less(ie(t),t);)this.exchange(t,ie(t)),t=ie(t)},t.prototype.sink=function(t){for(;2*t<=this.numberOfElements;){var e=2*t;if(e<this.numberOfElements&&this.less(e,e+1)&&e++,!this.less(t,e))break;this.exchange(t,e),t=e}},t.prototype.getValueAt=function(t){return this.getElementValue(this.priorityQueue[t])},t.prototype.less=function(t,e){return this.getValueAt(t)<this.getValueAt(e)},t.prototype.exchange=function(t,e){var i=this.priorityQueue[t];this.priorityQueue[t]=this.priorityQueue[e],this.priorityQueue[e]=i},t}();function re(t,e,i,n,r,o){for(var a=o.shape,s=a[0],l=a[1],u=!0,h=Math.max(i-r,0),c=Math.min(i+r+1,s),p=h;p<c;++p){for(var d=Math.max(n-r,0),f=Math.min(n+r+1,l),m=d;m<f;++m)if(o.get(p,m,t)>e){u=!1;break}if(!u)break}return u}function oe(t){return s(this,void 0,void 0,(function(){return l(this,(function(e){return[2,Promise.all(t.map((function(t){return t.buffer()})))]}))}))}function ae(t,e,i,n){return{y:n.get(t,e,i),x:n.get(t,e,i+17)}}function se(t,e,i){var n=ae(t.heatmapY,t.heatmapX,t.id,i),r=n.y,o=n.x;return{x:t.heatmapX*e+o,y:t.heatmapY*e+r}}function le(t,e,i,n){var r=i.x,o=i.y;return t.some((function(t){var i,a,s,l,u,h,c=t.keypoints;return i=o,a=r,s=c[n].y,l=c[n].x,(u=s-i)*u+(h=l-a)*h<=e}))}var ue=h.reduce((function(t,e,i){return t[e]=i,t}),{}),he=[["nose","left_eye"],["left_eye","left_ear"],["nose","right_eye"],["right_eye","right_ear"],["nose","left_shoulder"],["left_shoulder","left_elbow"],["left_elbow","left_wrist"],["left_shoulder","left_hip"],["left_hip","left_knee"],["left_knee","left_ankle"],["nose","right_shoulder"],["right_shoulder","right_elbow"],["right_elbow","right_wrist"],["right_shoulder","right_hip"],["right_hip","right_knee"],["right_knee","right_ankle"]].map((function(t){var e=t[0],i=t[1];return[ue[e],ue[i]]})),ce=he.map((function(t){return t[1]})),pe=he.map((function(t){return t[0]}));function de(t,e,i){return t<e?e:t>i?i:t}function fe(t,e,i,n){return{y:de(Math.round(t.y/e),0,i-1),x:de(Math.round(t.x/e),0,n-1)}}function me(t,e){return{x:t.x+e.x,y:t.y+e.y}}function ge(t,e,i,n,r,o,a,s){void 0===s&&(s=2);for(var l=n.shape,u=l[0],c=l[1],p={y:e.y,x:e.x},d=me(p,function(t,e,i){var n=i.shape[2]/2;return{y:i.get(e.y,e.x,t),x:i.get(e.y,e.x,n+t)}}(t,fe(p,o,u,c),a)),f=0;f<s;f++){var m=fe(d,o,u,c),g=ae(m.y,m.x,i,r);d=me({x:m.x*o,y:m.y*o},{x:g.x,y:g.y})}var y=fe(d,o,u,c),v=n.get(y.y,y.x,i);return{y:d.y,x:d.x,name:h[i],score:v}}function ye(t,e,i,n,r,o){var a=e.shape[2],s=ce.length,l=new Array(a),u=t.part,c=t.score,p=se(u,n,i);l[u.id]={score:c,name:h[u.id],y:p.y,x:p.x};for(var d=s-1;d>=0;--d){var f=ce[d],m=pe[d];l[f]&&!l[m]&&(l[m]=ge(d,l[f],m,e,i,n,o))}for(d=0;d<s;++d){f=pe[d],m=ce[d];l[f]&&!l[m]&&(l[m]=ge(d,l[f],m,e,i,n,r))}return l}function ve(t,e,i){return i.reduce((function(i,n,r){var o=n.y,a=n.x,s=n.score;return le(t,e,{y:o,x:a},r)||(i+=s),i}),0)/i.length}function xe(t,e,i,n,r,o,a,u){return void 0===a&&(a=.5),void 0===u&&(u=20),s(this,void 0,void 0,(function(){var s,h,c,p,d,f,m,g,y,v,x,w;return l(this,(function(l){switch(l.label){case 0:return[4,oe([t,e,i,n])];case 1:for(s=l.sent(),h=s[0],c=s[1],p=s[2],d=s[3],f=[],m=function(t,e,i){for(var n=i.shape,r=n[0],o=n[1],a=n[2],s=new ne(r*o*a,(function(t){return t.score})),l=0;l<r;++l)for(var u=0;u<o;++u)for(var h=0;h<a;++h){var c=i.get(l,u,h);c<t||re(h,c,l,u,e,i)&&s.enqueue({score:c,part:{heatmapY:l,heatmapX:u,id:h}})}return s}(a,1,h),g=u*u;f.length<o&&!m.empty();)y=m.dequeue(),v=se(y.part,r,c),le(f,g,v,y.part.id)||(x=ye(y,h,c,r,p,d),w=ve(f,g,x),f.push({keypoints:x,score:w}));return[2,f]}}))}))}function we(t){var e=t.shape,n=e[0],r=e[1],o=e[2];return i.tidy((function(){var e,a,s=i.reshape(t,[n*r,o]),l=i.argMax(s,0),u=i.expandDims(i.div(l,i.scalar(r,"int32")),1),h=i.expandDims((e=l,a=r,i.tidy((function(){var t=i.div(e,i.scalar(a,"int32"));return i.sub(e,i.mul(t,i.scalar(a,"int32")))}))),1);return i.concat([u,h],1)}))}function ke(t,e,n){return i.tidy((function(){var r=function(t,e){for(var n=[],r=0;r<h.length;r++){var o=t.get(r,0).valueOf(),a=t.get(r,1).valueOf(),s=be(o,a,r,e),l=s.x,u=s.y;n.push(u),n.push(l)}return i.tensor2d(n,[h.length,2])}(t,n);return i.add(i.cast(i.mul(t.toTensor(),i.scalar(e,"int32")),"float32"),r)}))}function be(t,e,i,n){return{y:n.get(t,e,i),x:n.get(t,e,i+h.length)}}function Me(t,e,i){return s(this,void 0,void 0,(function(){var n,r,o,a,s,u,c,p,d,f;return l(this,(function(l){switch(l.label){case 0:return n=0,r=we(t),[4,Promise.all([t.buffer(),e.buffer(),r.buffer()])];case 1:return o=l.sent(),a=o[0],s=o[1],u=o[2],[4,(c=ke(u,i,s)).buffer()];case 2:return p=l.sent(),d=Array.from(function(t,e){for(var i=e.shape[0],n=new Float32Array(i),r=0;r<i;r++){var o=e.get(r,0),a=e.get(r,1);n[r]=t.get(o,a,r)}return n}(a,u)),f=d.map((function(t,e){return n+=t,{y:p.get(e,0),x:p.get(e,1),score:t,name:h[e]}})),r.dispose(),c.dispose(),[2,{keypoints:f,score:n/f.length}]}}))}))}function Se(t,e){return(t-1)%e==0}var Te="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/mobilenet/",Pe="https://storage.googleapis.com/tfjs-models/savedmodel/posenet/resnet50/";function Fe(t,e){return function(t,e){return(t-1)%e==0}(t,e)?t:Math.floor(t/e)*e+1}var _e=function(){function t(t,e){this.posenetModel=t;var n=this.posenetModel.inputs[0].shape;i.util.assert(-1===n[1]&&-1===n[2],(function(){return"Input shape [".concat(n[1],", ").concat(n[2],"] ")+"must both be equal to or -1"}));var r,o,a=(r=e.inputResolution,o=e.outputStride,{height:Fe(r.height,o),width:Fe(r.width,o)});!function(t){i.util.assert(Qt.indexOf(t)>=0,(function(){return"outputStride of ".concat(t," is invalid. ")+"It must be either 8 or 16."}))}(e.outputStride),function(t,e){i.util.assert(Se(t.height,e),(function(){return"height of ".concat(t.height," is invalid for output stride ")+"".concat(e,".")})),i.util.assert(Se(t.width,e),(function(){return"width of ".concat(t.width," is invalid for output stride ")+"".concat(e,".")}))}(a,e.outputStride),this.inputResolution=a,this.outputStride=e.outputStride,this.architecture=e.architecture}return t.prototype.estimatePoses=function(t,e){return void 0===e&&(e=Jt),s(this,void 0,void 0,(function(){var n,r,o,s,u,h,c,p,d,f,m,g,y,v,x;return l(this,(function(l){switch(l.label){case 0:return n=function(t){var e=t;if(null==e.maxPoses&&(e.maxPoses=1),e.maxPoses<=0)throw new Error("Invalid maxPoses ".concat(e.maxPoses,". Should be > 0."));if(e.maxPoses>1){if((e=a(a({},te),e)).scoreThreshold<0||e.scoreThreshold>1)throw new Error("Invalid scoreThreshold ".concat(e.scoreThreshold,". ")+"Should be in range [0.0, 1.0]");if(e.nmsRadius<=0)throw new Error("Invalid nmsRadius ".concat(e.nmsRadius,"."))}return e}(e),null==t?[2,[]]:(this.maxPoses=n.maxPoses,r=B(t,{outputTensorSize:this.inputResolution,keepAspectRatio:!0,borderMode:"replicate"}),o=r.imageTensor,s=r.padding,u="ResNet50"===this.architecture?i.add(o,ee):V(o,[-1,1]),h=this.posenetModel.predict(u),"ResNet50"===this.architecture?(c=i.squeeze(h[2],[0]),p=i.squeeze(h[3],[0]),d=i.squeeze(h[0],[0]),f=i.squeeze(h[1],[0])):(c=i.squeeze(h[0],[0]),p=i.squeeze(h[1],[0]),d=i.squeeze(h[2],[0]),f=i.squeeze(h[3],[0])),m=i.sigmoid(p),1!==this.maxPoses?[3,2]:[4,Me(m,c,this.outputStride)]);case 1:return y=l.sent(),g=[y],[3,4];case 2:return[4,xe(m,c,d,f,this.outputStride,this.maxPoses,n.scoreThreshold,n.nmsRadius)];case 3:g=l.sent(),l.label=4;case 4:return v=P(t),x=function(t,e,i,n){var r=e.height,o=e.width,a=r/(i.height*(1-n.top-n.bottom)),s=o/(i.width*(1-n.left-n.right)),l=-n.top*i.height,u=-n.left*i.width;if(1===s&&1===a&&0===l&&0===u)return t;for(var h=0,c=t;h<c.length;h++)for(var p=0,d=c[h].keypoints;p<d.length;p++){var f=d[p];f.x=(f.x+u)*s,f.y=(f.y+l)*a}return t}(g,v,this.inputResolution,s),n.flipHorizontal&&(x=function(t,e){for(var i=0,n=t;i<n.length;i++)for(var r=0,o=n[i].keypoints;r<o.length;r++){var a=o[r];a.x=e.width-1-a.x}return t}(x,v)),o.dispose(),u.dispose(),i.dispose(h),c.dispose(),p.dispose(),d.dispose(),f.dispose(),m.dispose(),[2,x]}}))}))},t.prototype.dispose=function(){this.posenetModel.dispose()},t.prototype.reset=function(){},t}();function ze(t){return void 0===t&&(t=Wt),s(this,void 0,void 0,(function(){var e,i,r,o,a;return l(this,(function(s){switch(s.label){case 0:return"ResNet50"!==(e=function(t){var e=t||Wt;if(null==e.architecture&&(e.architecture="MobileNetV1"),Gt.indexOf(e.architecture)<0)throw new Error("Invalid architecture ".concat(e.architecture,". ")+"Should be one of ".concat(Gt));if(null==e.inputResolution&&(e.inputResolution={height:257,width:257}),null==e.outputStride&&(e.outputStride=16),Yt[e.architecture].indexOf(e.outputStride)<0)throw new Error("Invalid outputStride ".concat(e.outputStride,". ")+"Should be one of ".concat(Yt[e.architecture]," ")+"for architecture ".concat(e.architecture,"."));if(null==e.multiplier&&(e.multiplier=1),Zt[e.architecture].indexOf(e.multiplier)<0)throw new Error("Invalid multiplier ".concat(e.multiplier,". ")+"Should be one of ".concat(Zt[e.architecture]," ")+"for architecture ".concat(e.architecture,"."));if(null==e.quantBytes&&(e.quantBytes=4),$t.indexOf(e.quantBytes)<0)throw new Error("Invalid quantBytes ".concat(e.quantBytes,". ")+"Should be one of ".concat($t," ")+"for architecture ".concat(e.architecture,"."));if("MobileNetV1"===e.architecture&&32===e.outputStride&&1!==e.multiplier)throw new Error("When using an output stride of 32, you must select 1 as the multiplier.");return e}(t)).architecture?[3,2]:(l=e.outputStride,u=e.quantBytes,h="model-stride".concat(l,".json"),i=4===u?Pe+"float/"+h:Pe+"quant".concat(u,"/")+h,[4,n.loadGraphModel(e.modelUrl||i)]);case 1:return r=s.sent(),[2,new _e(r,e)];case 2:return o=function(t,e,i){var n={1:"100",.75:"075",.5:"050"},r="model-stride".concat(t,".json");return 4===i?Te+"float/".concat(n[e],"/")+r:Te+"quant".concat(i,"/").concat(n[e],"/")+r}(e.outputStride,e.multiplier,e.quantBytes),[4,n.loadGraphModel(e.modelUrl||o)];case 3:return a=s.sent(),[2,new _e(a,e)]}var l,u,h}))}))}var Oe={keypointsToNormalizedKeypoints:J},Ae={modelType:{SINGLEPOSE_LIGHTNING:"SinglePose.Lightning",SINGLEPOSE_THUNDER:"SinglePose.Thunder",MULTIPOSE_LIGHTNING:"MultiPose.Lightning"}};t.calculators=Oe,t.createDetector=function(e,i){return s(this,void 0,void 0,(function(){var n,r;return l(this,(function(o){switch(e){case t.SupportedModels.PoseNet:return[2,ze(i)];case t.SupportedModels.BlazePose:if(r=void 0,null!=(n=i)){if("tfjs"===n.runtime)return[2,Ft(i)];if("mediapipe"===n.runtime)return[2,T(i)];r=n.runtime}throw new Error("Expect modelConfig.runtime to be either 'tfjs' "+"or 'mediapipe', but got ".concat(r));case t.SupportedModels.MoveNet:return[2,Xt(i)];default:throw new Error("".concat(e," is not a supported model name."))}}))}))},t.movenet=Ae,t.util=Rt,Object.defineProperty(t,"__esModule",{value:!0})}));
