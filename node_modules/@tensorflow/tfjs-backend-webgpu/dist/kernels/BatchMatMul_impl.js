/**
 * @license
 * Copyright 2021 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import { broadcast_util, env, util } from '@tensorflow/tfjs-core';
import { MatMulPackedProgram } from '../matmul_packed_webgpu';
import { MatMulReduceProgram } from '../matmul_reduce_webgpu';
import { MatMulSmallOutputSizeProgram } from '../matmul_small_output_size_webgpu';
import { BiasActivationProgram, MatMulSplitKProgram } from '../matmul_splitK_webgpu';
import { MatMulProgramType } from '../webgpu_util';
import { fill } from './Fill';
import { reshape } from './Reshape';
export function batchMatMulImpl({ a, b, transposeA, transposeB, backend, bias = null, preluActivationWeights = null, leakyreluAlpha = 0, activation = null }) {
    const aRank = a.shape.length;
    const bRank = b.shape.length;
    const innerShapeA = transposeA ? a.shape[aRank - 2] : a.shape[aRank - 1];
    const innerShapeB = transposeB ? b.shape[bRank - 1] : b.shape[bRank - 2];
    const outerShapeA = transposeA ? a.shape[aRank - 1] : a.shape[aRank - 2];
    const outerShapeB = transposeB ? b.shape[bRank - 2] : b.shape[bRank - 1];
    const outerDimsA = a.shape.slice(0, -2);
    const outerDimsB = b.shape.slice(0, -2);
    const batchDimA = util.sizeFromShape(outerDimsA);
    const batchDimB = util.sizeFromShape(outerDimsB);
    const outShapeOuterDims = broadcast_util.assertAndGetBroadcastShape(a.shape.slice(0, -2), b.shape.slice(0, -2));
    const outShape = outShapeOuterDims.concat([outerShapeA, outerShapeB]);
    util.assert(innerShapeA === innerShapeB, () => `Error in matMul: inner shapes (${innerShapeA}) and (` +
        `${innerShapeB}) of Tensors with shapes ${a.shape} and ` +
        `${b.shape} and transposeA=${transposeA}` +
        ` and transposeB=${transposeB} must match.`);
    const a3dShape = transposeA ?
        [batchDimA, innerShapeA, outerShapeA] :
        [batchDimA, outerShapeA, innerShapeA];
    const b3dShape = transposeB ?
        [batchDimB, outerShapeB, innerShapeB] :
        [batchDimB, innerShapeB, outerShapeB];
    // The rest of the implementation is designed to operate on rank-3 tensors
    const a3d = reshape({ inputs: { x: a }, backend, attrs: { shape: a3dShape } });
    const b3d = reshape({ inputs: { x: b }, backend, attrs: { shape: b3dShape } });
    const intermediates = [a3d, b3d];
    const batchDim = Math.max(batchDimA, batchDimB);
    const batchAEqualOne = batchDimA === 1;
    const batchBEqualOne = batchDimB === 1;
    const inputs = [a3d, b3d];
    const dimensions = [
        { type: 'int32', data: [outerShapeA] }, { type: 'int32', data: [outerShapeB] },
        { type: 'int32', data: [innerShapeA] }
    ];
    let program;
    let out;
    const outputShape = [batchDim, outerShapeA, outerShapeB];
    let matmulProgramType = env().get('WEBGPU_MATMUL_PROGRAM_TYPE');
    if (matmulProgramType < 0) {
        if (outerShapeA * outerShapeB <= 128) {
            matmulProgramType = MatMulProgramType.MatMulReduceProgram;
        }
        else if (
        // These boundaries are based on bodypix-ResNet50-image-0.5.
        // TODO: Relax or tight these boundaries when we have a complete matmul
        // test coverage.
        batchDim === 1 && outerShapeA <= 128 && outerShapeB <= 48 &&
            innerShapeB >= 2000) {
            matmulProgramType = MatMulProgramType.MatMulSplitKProgram;
        }
        else if (
        // When the output size is absolutely small or relatively small, we may
        // use MatMulSmallOutputSizeProgram to get better performance.
        // Absolutely small size means that the output size is smaller than [16,
        // 512]. Relatively small size means that one demension size of the
        // output is smaller than 16, and the output size is also more than or
        // equal two times smaller than each of the two input sizes. For
        // example, if input sizes are [12, 2048] and [2048, 1024], the output
        // size is [12, 1024], which is relatively small compared to input
        // sizes.
        (outerShapeA <= 16 &&
            (outerShapeB <= 512 || innerShapeB >= 2 * outerShapeB)) ||
            (outerShapeB <= 16 &&
                (outerShapeA <= 512 || innerShapeA >= 2 * outerShapeA))) {
            matmulProgramType = MatMulProgramType.MatMulSmallOutputSizeProgram;
        }
        else {
            matmulProgramType = MatMulProgramType.MatMulPackedProgram;
        }
    }
    switch (matmulProgramType) {
        case MatMulProgramType.MatMulReduceProgram:
            program = new MatMulReduceProgram(outputShape, batchAEqualOne, batchBEqualOne, transposeA, transposeB, bias, activation, preluActivationWeights);
            break;
        case MatMulProgramType.MatMulSplitKProgram: {
            // The output buffer must be initailzed to zero before using since we
            // use atomicAdd in MatMulSplitKProgram.
            out = fill({ backend, attrs: { shape: outputShape, value: 0, dtype: a.dtype } });
            program = new MatMulSplitKProgram(outputShape, innerShapeB, batchAEqualOne, batchBEqualOne, transposeA, transposeB);
            if (bias || activation) {
                out =
                    backend.runWebGPUProgram(program, inputs, a.dtype, dimensions, out);
                const biasActivationProgram = new BiasActivationProgram(out.shape, bias, activation, preluActivationWeights);
                let uniformData = null;
                const activationInputs = [out];
                if (bias) {
                    activationInputs.push(bias);
                }
                if (preluActivationWeights) {
                    activationInputs.push(preluActivationWeights);
                }
                if (activation === 'leakyrelu') {
                    uniformData = [{ type: 'float32', data: [leakyreluAlpha] }];
                    biasActivationProgram.uniforms += ' alpha : f32,';
                }
                const outActivated = backend.runWebGPUProgram(biasActivationProgram, activationInputs, out.dtype, uniformData);
                intermediates.push(out);
                const outReshaped = reshape({ inputs: { x: outActivated }, backend, attrs: { shape: outShape } });
                intermediates.push(outActivated);
                for (const i of intermediates) {
                    backend.disposeData(i.dataId);
                }
                return outReshaped;
            }
            break;
        }
        case MatMulProgramType.MatMulSmallOutputSizeProgram:
            program = new MatMulSmallOutputSizeProgram(a3dShape, b3dShape, outputShape, transposeA, transposeB, bias, activation, preluActivationWeights);
            break;
        case MatMulProgramType.MatMulPackedProgram:
            // Experiments show that sequential access is more friendly for Intel
            // GPUs.
            const sequentialAccessByThreads = backend.adapterInfo.isIntel();
            program = new MatMulPackedProgram(a3dShape, outputShape, batchAEqualOne, batchBEqualOne, transposeA, transposeB, bias, activation, preluActivationWeights, sequentialAccessByThreads);
            break;
        default:
            throw new Error(`Unsupported MatMulProgramType ${matmulProgramType}.`);
    }
    if (bias) {
        inputs.push(bias);
    }
    if (preluActivationWeights) {
        inputs.push(preluActivationWeights);
    }
    if (activation === 'leakyrelu') {
        dimensions.push({ type: 'float32', data: [leakyreluAlpha] });
        program.uniforms += ' alpha : f32,';
    }
    out = backend.runWebGPUProgram(program, inputs, a.dtype, dimensions, out);
    const outReshaped = reshape({ inputs: { x: out }, backend, attrs: { shape: outShape } });
    intermediates.push(out);
    for (const i of intermediates) {
        backend.disposeData(i.dataId);
    }
    return outReshaped;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQmF0Y2hNYXRNdWxfaW1wbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3RmanMtYmFja2VuZC13ZWJncHUvc3JjL2tlcm5lbHMvQmF0Y2hNYXRNdWxfaW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLEVBQWUsY0FBYyxFQUFFLEdBQUcsRUFBYyxJQUFJLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQUcxRixPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUM1RCxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUM1RCxPQUFPLEVBQUMsNEJBQTRCLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQUNoRixPQUFPLEVBQUMscUJBQXFCLEVBQUUsbUJBQW1CLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUVuRixPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRCxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBQyxPQUFPLEVBQUMsTUFBTSxXQUFXLENBQUM7QUFjbEMsTUFBTSxVQUFVLGVBQWUsQ0FBQyxFQUM5QixDQUFDLEVBQ0QsQ0FBQyxFQUNELFVBQVUsRUFDVixVQUFVLEVBQ1YsT0FBTyxFQUNQLElBQUksR0FBRyxJQUFJLEVBQ1gsc0JBQXNCLEdBQUcsSUFBSSxFQUM3QixjQUFjLEdBQUcsQ0FBQyxFQUNsQixVQUFVLEdBQUcsSUFBSSxFQUNDO0lBQ2xCLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO0lBQzdCLE1BQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO0lBRTdCLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxL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RSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUMsQ0FBQyxDQUFDO1FBQzNELE9BQU8sQ0FBQyxRQUFRLElBQUksZUFBZSxDQUFDO0tBQ3JDO0lBQ0QsR0FBRyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzFFLE1BQU0sV0FBVyxHQUNiLE9BQU8sQ0FBQyxFQUFDLE1BQU0sRUFBRSxFQUFDLENBQUMsRUFBRSxHQUFHLEVBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUMsS0FBSyxFQUFFLFFBQVEsRUFBQyxFQUFDLENBQUMsQ0FBQztJQUNuRSxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3hCLEtBQUssTUFBTSxDQUFDLElBQUksYUFBYSxFQUFFO1FBQzdCLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQy9CO0lBQ0QsT0FBTyxXQUFXLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDIxIEdvb2dsZSBMTEMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gKi9cblxuaW1wb3J0IHtiYWNrZW5kX3V0aWwsIGJyb2FkY2FzdF91dGlsLCBlbnYsIFRlbnNvckluZm8sIHV0aWx9IGZyb20gJ0B0ZW5zb3JmbG93L3RmanMtY29yZSc7XG5cbmltcG9ydCB7V2ViR1BVQmFja2VuZH0gZnJvbSAnLi4vYmFja2VuZF93ZWJncHUnO1xuaW1wb3J0IHtNYXRNdWxQYWNrZWRQcm9ncmFtfSBmcm9tICcuLi9tYXRtdWxfcGFja2VkX3dlYmdwdSc7XG5pbXBvcnQge01hdE11bFJlZHVjZVByb2dyYW19IGZyb20gJy4uL21hdG11bF9yZWR1Y2Vfd2ViZ3B1JztcbmltcG9ydCB7TWF0TXVsU21hbGxPdXRwdXRTaXplUHJvZ3JhbX0gZnJvbSAnLi4vbWF0bXVsX3NtYWxsX291dHB1dF9zaXplX3dlYmdwdSc7XG5pbXBvcnQge0JpYXNBY3RpdmF0aW9uUHJvZ3JhbSwgTWF0TXVsU3BsaXRLUHJvZ3JhbX0gZnJvbSAnLi4vbWF0bXVsX3NwbGl0S193ZWJncHUnO1xuaW1wb3J0IHtXZWJHUFVQcm9ncmFtfSBmcm9tICcuLi93ZWJncHVfcHJvZ3JhbSc7XG5pbXBvcnQge01hdE11bFByb2dyYW1UeXBlfSBmcm9tICcuLi93ZWJncHVfdXRpbCc7XG5cbmltcG9ydCB7ZmlsbH0gZnJvbSAnLi9GaWxsJztcbmltcG9ydCB7cmVzaGFwZX0gZnJvbSAnLi9SZXNoYXBlJztcblxudHlwZSBCYXRjaE1hdE11bENvbmZpZyA9IHtcbiAgYTogVGVuc29ySW5mbyxcbiAgYjogVGVuc29ySW5mbyxcbiAgdHJhbnNwb3NlQTogYm9vbGVhbixcbiAgdHJhbnNwb3NlQjogYm9vbGVhbixcbiAgYmFja2VuZDogV2ViR1BVQmFja2VuZCxcbiAgYmlhcz86IFRlbnNvckluZm8sXG4gIHByZWx1QWN0aXZhdGlvbldlaWdodHM/OiBUZW5zb3JJbmZvLFxuICBsZWFreXJlbHVBbHBoYT86IG51bWJlcixcbiAgYWN0aXZhdGlvbj86IGJhY2tlbmRfdXRpbC5BY3RpdmF0aW9uXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gYmF0Y2hNYXRNdWxJbXBsKHtcbiAgYSxcbiAgYixcbiAgdHJhbnNwb3NlQSxcbiAgdHJhbnNwb3NlQixcbiAgYmFja2VuZCxcbiAgYmlhcyA9IG51bGwsXG4gIHByZWx1QWN0aXZhdGlvbldlaWdodHMgPSBudWxsLFxuICBsZWFreXJlbHVBbHBoYSA9IDAsXG4gIGFjdGl2YXRpb24gPSBudWxsXG59OiBCYXRjaE1hdE11bENvbmZpZyk6IFRlbnNvckluZm8ge1xuICBjb25zdCBhUmFuayA9IGEuc2hhcGUubGVuZ3RoO1xuICBjb25zdCBiUmFuayA9IGIuc2hhcGUubGVuZ3RoO1xuXG4gIGNvbnN0IGlubmVyU2hhcGVBID0gdHJhbnNwb3NlQSA/IGEuc2hhcGVbYVJhbmsgLSAyXSA6IGEuc2hhcGVbYVJhbmsgLSAxXTtcbiAgY29uc3QgaW5uZXJTaGFwZUIgPSB0cmFuc3Bvc2VCID8gYi5zaGFwZVtiUmFuayAtIDFdIDogYi5zaGFwZVtiUmFuayAtIDJdO1xuXG4gIGNvbnN0IG91dGVyU2hhcGVBID0gdHJhbnNwb3NlQSA/IGEuc2hhcGVbYVJhbmsgLSAxXSA6IGEuc2hhcGVbYVJhbmsgLSAyXTtcbiAgY29uc3Qgb3V0ZXJTaGFwZUIgPSB0cmFuc3Bvc2VCID8gYi5zaGFwZVtiUmFuayAtIDJdIDogYi5zaGFwZVtiUmFuayAtIDFdO1xuXG4gIGNvbnN0IG91dGVyRGltc0EgPSBhLnNoYXBlLnNsaWNlKDAsIC0yKTtcbiAgY29uc3Qgb3V0ZXJEaW1zQiA9IGIuc2hhcGUuc2xpY2UoMCwgLTIpO1xuXG4gIGNvbnN0IGJhdGNoRGltQSA9IHV0aWwuc2l6ZUZyb21TaGFwZShvdXRlckRpbXNBKTtcbiAgY29uc3QgYmF0Y2hEaW1CID0gdXRpbC5zaXplRnJvbVNoYXBlKG91dGVyRGltc0IpO1xuXG4gIGNvbnN0IG91dFNoYXBlT3V0ZXJEaW1zID0gYnJvYWRjYXN0X3V0aWwuYXNzZXJ0QW5kR2V0QnJvYWRjYXN0U2hhcGUoXG4gICAgICBhLnNoYXBlLnNsaWNlKDAsIC0yKSwgYi5zaGFwZS5zbGljZSgwLCAtMikpO1xuICBjb25zdCBvdXRTaGFwZSA9IG91dFNoYXBlT3V0ZXJEaW1zLmNvbmNhdChbb3V0ZXJTaGFwZUEsIG91dGVyU2hhcGVCXSk7XG5cbiAgdXRpbC5hc3NlcnQoXG4gICAgICBpbm5lclNoYXBlQSA9PT0gaW5uZXJTaGFwZUIsXG4gICAgICAoKSA9PiBgRXJyb3IgaW4gbWF0TXVsOiBpbm5lciBzaGFwZXMgKCR7aW5uZXJTaGFwZUF9KSBhbmQgKGAgK1xuICAgICAgICAgIGAke2lubmVyU2hhcGVCfSkgb2YgVGVuc29ycyB3aXRoIHNoYXBlcyAke2Euc2hhcGV9IGFuZCBgICtcbiAgICAgICAgICBgJHtiLnNoYXBlfSBhbmQgdHJhbnNwb3NlQT0ke3RyYW5zcG9zZUF9YCArXG4gICAgICAgICAgYCBhbmQgdHJhbnNwb3NlQj0ke3RyYW5zcG9zZUJ9IG11c3QgbWF0Y2guYCk7XG5cbiAgY29uc3QgYTNkU2hhcGU6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSA9IHRyYW5zcG9zZUEgP1xuICAgICAgW2JhdGNoRGltQSwgaW5uZXJTaGFwZUEsIG91dGVyU2hhcGVBXSA6XG4gICAgICBbYmF0Y2hEaW1BLCBvdXRlclNoYXBlQSwgaW5uZXJTaGFwZUFdO1xuICBjb25zdCBiM2RTaGFwZTogW251bWJlciwgbnVtYmVyLCBudW1iZXJdID0gdHJhbnNwb3NlQiA/XG4gICAgICBbYmF0Y2hEaW1CLCBvdXRlclNoYXBlQiwgaW5uZXJTaGFwZUJdIDpcbiAgICAgIFtiYXRjaERpbUIsIGlubmVyU2hhcGVCLCBvdXRlclNoYXBlQl07XG5cbiAgLy8gVGhlIHJlc3Qgb2YgdGhlIGltcGxlbWVudGF0aW9uIGlzIGRlc2lnbmVkIHRvIG9wZXJhdGUgb24gcmFuay0zIHRlbnNvcnNcbiAgY29uc3QgYTNkID0gcmVzaGFwZSh7aW5wdXRzOiB7eDogYX0sIGJhY2tlbmQsIGF0dHJzOiB7c2hhcGU6IGEzZFNoYXBlfX0pO1xuICBjb25zdCBiM2QgPSByZXNoYXBlKHtpbnB1dHM6IHt4OiBifSwgYmFja2VuZCwgYXR0cnM6IHtzaGFwZTogYjNkU2hhcGV9fSk7XG4gIGNvbnN0IGludGVybWVkaWF0ZXM6IFRlbnNvckluZm9bXSA9IFthM2QsIGIzZF07XG5cbiAgY29uc3QgYmF0Y2hEaW0gPSBNYXRoLm1heChiYXRjaERpbUEsIGJhdGNoRGltQik7XG4gIGNvbnN0IGJhdGNoQUVxdWFsT25lID0gYmF0Y2hEaW1BID09PSAxO1xuICBjb25zdCBiYXRjaEJFcXVhbE9uZSA9IGJhdGNoRGltQiA9PT0gMTtcblxuICBjb25zdCBpbnB1dHM6IFRlbnNvckluZm9bXSA9IFthM2QsIGIzZF07XG4gIGNvbnN0IGRpbWVuc2lvbnMgPSBbXG4gICAge3R5cGU6ICdpbnQzMicsIGRhdGE6IFtvdXRlclNoYXBlQV19LCB7dHlwZTogJ2ludDMyJywgZGF0YTogW291dGVyU2hhcGVCXX0sXG4gICAge3R5cGU6ICdpbnQzMicsIGRhdGE6IFtpbm5lclNoYXBlQV19XG4gIF07XG5cbiAgbGV0IHByb2dyYW06IFdlYkdQVVByb2dyYW07XG4gIGxldCBvdXQ6IFRlbnNvckluZm87XG4gIGNvbnN0IG91dHB1dFNoYXBlOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0gPVxuICAgICAgW2JhdGNoRGltLCBvdXRlclNoYXBlQSwgb3V0ZXJTaGFwZUJdO1xuICBsZXQgbWF0bXVsUHJvZ3JhbVR5cGUgPSBlbnYoKS5nZXQoJ1dFQkdQVV9NQVRNVUxfUFJPR1JBTV9UWVBFJykgYXMgbnVtYmVyO1xuICBpZiAobWF0bXVsUHJvZ3JhbVR5cGUgPCAwKSB7XG4gICAgaWYgKG91dGVyU2hhcGVBICogb3V0ZXJTaGFwZUIgPD0gMTI4KSB7XG4gICAgICBtYXRtdWxQcm9ncmFtVHlwZSA9IE1hdE11bFByb2dyYW1UeXBlLk1hdE11bFJlZHVjZVByb2dyYW07XG4gICAgfSBlbHNlIGlmIChcbiAgICAgICAgLy8gVGhlc2UgYm91bmRhcmllcyBhcmUgYmFzZWQgb24gYm9keXBpeC1SZXNOZXQ1MC1pbWFnZS0wLjUuXG4gICAgICAgIC8vIFRPRE86IFJlbGF4IG9yIHRpZ2h0IHRoZXNlIGJvdW5kYXJpZXMgd2hlbiB3ZSBoYXZlIGEgY29tcGxldGUgbWF0bXVsXG4gICAgICAgIC8vIHRlc3QgY292ZXJhZ2UuXG4gICAgICAgIGJhdGNoRGltID09PSAxICYmIG91dGVyU2hhcGVBIDw9IDEyOCAmJiBvdXRlclNoYXBlQiA8PSA0OCAmJlxuICAgICAgICBpbm5lclNoYXBlQiA+PSAyMDAwKSB7XG4gICAgICBtYXRtdWxQcm9ncmFtVHlwZSA9IE1hdE11bFByb2dyYW1UeXBlLk1hdE11bFNwbGl0S1Byb2dyYW07XG4gICAgfSBlbHNlIGlmIChcbiAgICAgICAgLy8gV2hlbiB0aGUgb3V0cHV0IHNpemUgaXMgYWJzb2x1dGVseSBzbWFsbCBvciByZWxhdGl2ZWx5IHNtYWxsLCB3ZSBtYXlcbiAgICAgICAgLy8gdXNlIE1hdE11bFNtYWxsT3V0cHV0U2l6ZVByb2dyYW0gdG8gZ2V0IGJldHRlciBwZXJmb3JtYW5jZS5cbiAgICAgICAgLy8gQWJzb2x1dGVseSBzbWFsbCBzaXplIG1lYW5zIHRoYXQgdGhlIG91dHB1dCBzaXplIGlzIHNtYWxsZXIgdGhhbiBbMTYsXG4gICAgICAgIC8vIDUxMl0uIFJlbGF0aXZlbHkgc21hbGwgc2l6ZSBtZWFucyB0aGF0IG9uZSBkZW1lbnNpb24gc2l6ZSBvZiB0aGVcbiAgICAgICAgLy8gb3V0cHV0IGlzIHNtYWxsZXIgdGhhbiAxNiwgYW5kIHRoZSBvdXRwdXQgc2l6ZSBpcyBhbHNvIG1vcmUgdGhhbiBvclxuICAgICAgICAvLyBlcXVhbCB0d28gdGltZXMgc21hbGxlciB0aGFuIGVhY2ggb2YgdGhlIHR3byBpbnB1dCBzaXplcy4gRm9yXG4gICAgICAgIC8vIGV4YW1wbGUsIGlmIGlucHV0IHNpemVzIGFyZSBbMTIsIDIwNDhdIGFuZCBbMjA0OCwgMTAyNF0sIHRoZSBvdXRwdXRcbiAgICAgICAgLy8gc2l6ZSBpcyBbMTIsIDEwMjRdLCB3aGljaCBpcyByZWxhdGl2ZWx5IHNtYWxsIGNvbXBhcmVkIHRvIGlucHV0XG4gICAgICAgIC8vIHNpemVzLlxuICAgICAgICAob3V0ZXJTaGFwZUEgPD0gMTYgJiZcbiAgICAgICAgIChvdXRlclNoYXBlQiA8PSA1MTIgfHwgaW5uZXJTaGFwZUIgPj0gMiAqIG91dGVyU2hhcGVCKSkgfHxcbiAgICAgICAgKG91dGVyU2hhcGVCIDw9IDE2ICYmXG4gICAgICAgICAob3V0ZXJTaGFwZUEgPD0gNTEyIHx8IGlubmVyU2hhcGVBID49IDIgKiBvdXRlclNoYXBlQSkpKSB7XG4gICAgICBtYXRtdWxQcm9ncmFtVHlwZSA9IE1hdE11bFByb2dyYW1UeXBlLk1hdE11bFNtYWxsT3V0cHV0U2l6ZVByb2dyYW07XG4gICAgfSBlbHNlIHtcbiAgICAgIG1hdG11bFByb2dyYW1UeXBlID0gTWF0TXVsUHJvZ3JhbVR5cGUuTWF0TXVsUGFja2VkUHJvZ3JhbTtcbiAgICB9XG4gIH1cblxuICBzd2l0Y2ggKG1hdG11bFByb2dyYW1UeXBlKSB7XG4gICAgY2FzZSBNYXRNdWxQcm9ncmFtVHlwZS5NYXRNdWxSZWR1Y2VQcm9ncmFtOlxuICAgICAgcHJvZ3JhbSA9IG5ldyBNYXRNdWxSZWR1Y2VQcm9ncmFtKFxuICAgICAgICAgIG91dHB1dFNoYXBlLCBiYXRjaEFFcXVhbE9uZSwgYmF0Y2hCRXF1YWxPbmUsIHRyYW5zcG9zZUEsIHRyYW5zcG9zZUIsXG4gICAgICAgICAgYmlhcywgYWN0aXZhdGlvbiwgcHJlbHVBY3RpdmF0aW9uV2VpZ2h0cyk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIE1hdE11bFByb2dyYW1UeXBlLk1hdE11bFNwbGl0S1Byb2dyYW06IHtcbiAgICAgIC8vIFRoZSBvdXRwdXQgYnVmZmVyIG11c3QgYmUgaW5pdGFpbHplZCB0byB6ZXJvIGJlZm9yZSB1c2luZyBzaW5jZSB3ZVxuICAgICAgLy8gdXNlIGF0b21pY0FkZCBpbiBNYXRNdWxTcGxpdEtQcm9ncmFtLlxuICAgICAgb3V0ID0gZmlsbChcbiAgICAgICAgICB7YmFja2VuZCwgYXR0cnM6IHtzaGFwZTogb3V0cHV0U2hhcGUsIHZhbHVlOiAwLCBkdHlwZTogYS5kdHlwZX19KTtcbiAgICAgIHByb2dyYW0gPSBuZXcgTWF0TXVsU3BsaXRLUHJvZ3JhbShcbiAgICAgICAgICBvdXRwdXRTaGFwZSwgaW5uZXJTaGFwZUIsIGJhdGNoQUVxdWFsT25lLCBiYXRjaEJFcXVhbE9uZSwgdHJhbnNwb3NlQSxcbiAgICAgICAgICB0cmFuc3Bvc2VCKTtcbiAgICAgIGlmIChiaWFzIHx8IGFjdGl2YXRpb24pIHtcbiAgICAgICAgb3V0ID1cbiAgICAgICAgICAgIGJhY2tlbmQucnVuV2ViR1BVUHJvZ3JhbShwcm9ncmFtLCBpbnB1dHMsIGEuZHR5cGUsIGRpbWVuc2lvbnMsIG91dCk7XG4gICAgICAgIGNvbnN0IGJpYXNBY3RpdmF0aW9uUHJvZ3JhbSA9IG5ldyBCaWFzQWN0aXZhdGlvblByb2dyYW0oXG4gICAgICAgICAgICBvdXQuc2hhcGUsIGJpYXMsIGFjdGl2YXRpb24sIHByZWx1QWN0aXZhdGlvbldlaWdodHMpO1xuICAgICAgICBsZXQgdW5pZm9ybURhdGEgPSBudWxsO1xuICAgICAgICBjb25zdCBhY3RpdmF0aW9uSW5wdXRzOiBUZW5zb3JJbmZvW10gPSBbb3V0XTtcbiAgICAgICAgaWYgKGJpYXMpIHtcbiAgICAgICAgICBhY3RpdmF0aW9uSW5wdXRzLnB1c2goYmlhcyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHByZWx1QWN0aXZhdGlvbldlaWdodHMpIHtcbiAgICAgICAgICBhY3RpdmF0aW9uSW5wdXRzLnB1c2gocHJlbHVBY3RpdmF0aW9uV2VpZ2h0cyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFjdGl2YXRpb24gPT09ICdsZWFreXJlbHUnKSB7XG4gICAgICAgICAgdW5pZm9ybURhdGEgPSBbe3R5cGU6ICdmbG9hdDMyJywgZGF0YTogW2xlYWt5cmVsdUFscGhhXX1dO1xuICAgICAgICAgIGJpYXNBY3RpdmF0aW9uUHJvZ3JhbS51bmlmb3JtcyArPSAnIGFscGhhIDogZjMyLCc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgb3V0QWN0aXZhdGVkID0gYmFja2VuZC5ydW5XZWJHUFVQcm9ncmFtKFxuICAgICAgICAgICAgYmlhc0FjdGl2YXRpb25Qcm9ncmFtLCBhY3RpdmF0aW9uSW5wdXRzLCBvdXQuZHR5cGUsIHVuaWZvcm1EYXRhKTtcbiAgICAgICAgaW50ZXJtZWRpYXRlcy5wdXNoKG91dCk7XG4gICAgICAgIGNvbnN0IG91dFJlc2hhcGVkID0gcmVzaGFwZShcbiAgICAgICAgICAgIHtpbnB1dHM6IHt4OiBvdXRBY3RpdmF0ZWR9LCBiYWNrZW5kLCBhdHRyczoge3NoYXBlOiBvdXRTaGFwZX19KTtcbiAgICAgICAgaW50ZXJtZWRpYXRlcy5wdXNoKG91dEFjdGl2YXRlZCk7XG4gICAgICAgIGZvciAoY29uc3QgaSBvZiBpbnRlcm1lZGlhdGVzKSB7XG4gICAgICAgICAgYmFja2VuZC5kaXNwb3NlRGF0YShpLmRhdGFJZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG91dFJlc2hhcGVkO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGNhc2UgTWF0TXVsUHJvZ3JhbVR5cGUuTWF0TXVsU21hbGxPdXRwdXRTaXplUHJvZ3JhbTpcbiAgICAgIHByb2dyYW0gPSBuZXcgTWF0TXVsU21hbGxPdXRwdXRTaXplUHJvZ3JhbShcbiAgICAgICAgICBhM2RTaGFwZSwgYjNkU2hhcGUsIG91dHB1dFNoYXBlLCB0cmFuc3Bvc2VBLCB0cmFuc3Bvc2VCLCBiaWFzLFxuICAgICAgICAgIGFjdGl2YXRpb24sIHByZWx1QWN0aXZhdGlvbldlaWdodHMpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBNYXRNdWxQcm9ncmFtVHlwZS5NYXRNdWxQYWNrZWRQcm9ncmFtOlxuICAgICAgLy8gRXhwZXJpbWVudHMgc2hvdyB0aGF0IHNlcXVlbnRpYWwgYWNjZXNzIGlzIG1vcmUgZnJpZW5kbHkgZm9yIEludGVsXG4gICAgICAvLyBHUFVzLlxuICAgICAgY29uc3Qgc2VxdWVudGlhbEFjY2Vzc0J5VGhyZWFkcyA9IGJhY2tlbmQuYWRhcHRlckluZm8uaXNJbnRlbCgpO1xuICAgICAgcHJvZ3JhbSA9IG5ldyBNYXRNdWxQYWNrZWRQcm9ncmFtKFxuICAgICAgICAgIGEzZFNoYXBlLCBvdXRwdXRTaGFwZSwgYmF0Y2hBRXF1YWxPbmUsIGJhdGNoQkVxdWFsT25lLCB0cmFuc3Bvc2VBLFxuICAgICAgICAgIHRyYW5zcG9zZUIsIGJpYXMsIGFjdGl2YXRpb24sIHByZWx1QWN0aXZhdGlvbldlaWdodHMsXG4gICAgICAgICAgc2VxdWVudGlhbEFjY2Vzc0J5VGhyZWFkcyk7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBNYXRNdWxQcm9ncmFtVHlwZSAke21hdG11bFByb2dyYW1UeXBlfS5gKTtcbiAgfVxuXG4gIGlmIChiaWFzKSB7XG4gICAgaW5wdXRzLnB1c2goYmlhcyk7XG4gIH1cbiAgaWYgKHByZWx1QWN0aXZhdGlvbldlaWdodHMpIHtcbiAgICBpbnB1dHMucHVzaChwcmVsdUFjdGl2YXRpb25XZWlnaHRzKTtcbiAgfVxuICBpZiAoYWN0aXZhdGlvbiA9PT0gJ2xlYWt5cmVsdScpIHtcbiAgICBkaW1lbnNpb25zLnB1c2goe3R5cGU6ICdmbG9hdDMyJywgZGF0YTogW2xlYWt5cmVsdUFscGhhXX0pO1xuICAgIHByb2dyYW0udW5pZm9ybXMgKz0gJyBhbHBoYSA6IGYzMiwnO1xuICB9XG4gIG91dCA9IGJhY2tlbmQucnVuV2ViR1BVUHJvZ3JhbShwcm9ncmFtLCBpbnB1dHMsIGEuZHR5cGUsIGRpbWVuc2lvbnMsIG91dCk7XG4gIGNvbnN0IG91dFJlc2hhcGVkID1cbiAgICAgIHJlc2hhcGUoe2lucHV0czoge3g6IG91dH0sIGJhY2tlbmQsIGF0dHJzOiB7c2hhcGU6IG91dFNoYXBlfX0pO1xuICBpbnRlcm1lZGlhdGVzLnB1c2gob3V0KTtcbiAgZm9yIChjb25zdCBpIG9mIGludGVybWVkaWF0ZXMpIHtcbiAgICBiYWNrZW5kLmRpc3Bvc2VEYXRhKGkuZGF0YUlkKTtcbiAgfVxuICByZXR1cm4gb3V0UmVzaGFwZWQ7XG59XG4iXX0=