/**
 * @license
 * Copyright 2020 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use backend file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import { env } from '@tensorflow/tfjs-core';
import { FromPixels, util } from '@tensorflow/tfjs-core';
import { FromPixelsProgram } from '../from_pixels_webgpu';
export const fromPixelsConfig = {
    kernelName: FromPixels,
    backendName: 'webgpu',
    kernelFunc: fromPixels,
};
let fromPixels2DContext;
let willReadFrequently = env().getBool('CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU');
const videoToTextureMap = new Map();
export function fromPixels(args) {
    const { inputs, backend, attrs } = args;
    let { pixels } = inputs;
    const { numChannels } = attrs;
    if (pixels == null) {
        throw new Error('pixels passed to tf.browser.fromPixels() can not be null');
    }
    const isVideo = typeof (HTMLVideoElement) !== 'undefined' &&
        pixels instanceof HTMLVideoElement;
    const isImage = typeof (HTMLImageElement) !== 'undefined' &&
        pixels instanceof HTMLImageElement;
    const isCanvas = (typeof (HTMLCanvasElement) !== 'undefined' &&
        pixels instanceof HTMLCanvasElement) ||
        (typeof (OffscreenCanvas) !== 'undefined' &&
            pixels instanceof OffscreenCanvas);
    const isImageBitmap = typeof (ImageBitmap) !== 'undefined' && pixels instanceof ImageBitmap;
    const [width, height] = isVideo ?
        [
            pixels.videoWidth,
            pixels.videoHeight
        ] :
        [pixels.width, pixels.height];
    const outputShape = [height, width, numChannels];
    // Disable importExternalTexture temporarily as it has problem in spec and
    // browser impl
    const importVideo = false && env().getBool('WEBGPU_IMPORT_EXTERNAL_TEXTURE') && isVideo;
    const isVideoOrImage = isVideo || isImage;
    if (isImageBitmap || isCanvas || isVideoOrImage) {
        let textureInfo;
        if (importVideo) {
            const videoElement = pixels;
            if (!(videoToTextureMap.has(videoElement)) ||
                videoToTextureMap.get(videoElement).expired) {
                const externalTextureDescriptor = { source: videoElement };
                videoToTextureMap.set(videoElement, backend.device.importExternalTexture(externalTextureDescriptor));
            }
            textureInfo = {
                width,
                height,
                format: null,
                usage: null,
                texture: videoToTextureMap.get(videoElement)
            };
        }
        else {
            if (isVideoOrImage) {
                const newWillReadFrequently = env().getBool('CANVAS2D_WILL_READ_FREQUENTLY_FOR_GPU');
                if (fromPixels2DContext == null ||
                    newWillReadFrequently !== willReadFrequently) {
                    willReadFrequently = newWillReadFrequently;
                    fromPixels2DContext =
                        document.createElement('canvas').getContext('2d', { willReadFrequently });
                }
                fromPixels2DContext.canvas.width = width;
                fromPixels2DContext.canvas.height = height;
                fromPixels2DContext.drawImage(pixels, 0, 0, width, height);
                pixels = fromPixels2DContext.canvas;
            }
            const usage = GPUTextureUsage.COPY_DST |
                GPUTextureUsage.RENDER_ATTACHMENT | GPUTextureUsage.TEXTURE_BINDING;
            const format = 'rgba8unorm';
            const texture = backend.textureManager.acquireTexture(outputShape[1], outputShape[0], format, usage);
            backend.queue.copyExternalImageToTexture({ source: pixels }, { texture }, [outputShape[1], outputShape[0]]);
            textureInfo = { width, height, format, usage, texture };
        }
        const size = util.sizeFromShape(outputShape);
        const strides = util.computeStrides(outputShape);
        const program = new FromPixelsProgram(outputShape, numChannels, importVideo);
        const uniformData = [
            { type: 'uint32', data: [size] }, { type: 'uint32', data: [numChannels] },
            { type: 'uint32', data: [...strides] }
        ];
        const input = backend.makeTensorInfo([height, width], 'int32');
        const info = backend.tensorMap.get(input.dataId);
        info.resourceInfo = textureInfo;
        const result = backend.runWebGPUProgram(program, [input], 'int32', uniformData);
        backend.disposeData(input.dataId);
        return result;
    }
    // TODO: Encoding should happen on GPU once we no longer have to download
    // image data to the CPU.
    const imageData = pixels.data;
    let pixelArray = imageData;
    if (numChannels != null && numChannels !== 4) {
        pixelArray = new Uint8Array(pixels.width * pixels.height * numChannels);
        const dataLength = imageData.length;
        let j = 0;
        for (let i = 0; i < dataLength; i++) {
            if (i % 4 < numChannels) {
                pixelArray[j++] = imageData[i];
            }
        }
    }
    const output = backend.makeTensorInfo(outputShape, 'int32', new Int32Array(pixelArray));
    backend.uploadToGPU(output.dataId);
    return output;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRnJvbVBpeGVscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3RmanMtYmFja2VuZC13ZWJncHUvc3JjL2tlcm5lbHMvRnJvbVBpeGVscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLEVBQUMsR0FBRyxFQUEyQixNQUFNLHVCQUF1QixDQUFDO0FBQ3BFLE9BQU8sRUFBQyxVQUFVLEVBQXFDLElBQUksRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBSTFGLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBRXhELE1BQU0sQ0FBQyxNQUFNLGdCQUFnQixHQUFpQjtJQUM1QyxVQUFVLEVBQUUsVUFBVTtJQUN0QixXQUFXLEVBQUUsUUFBUTtJQUNyQixVQUFVLEVBQUUsVUFBOEI7Q0FDM0MsQ0FBQztBQUVGLElBQUksbUJBQTZDLENBQUM7QUFDbEQsSUFBSSxrQkFBa0IsR0FBRyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsdUNBQXVDLENBQUMsQ0FBQztBQUNoRixNQUFNLGlCQUFpQixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0FBRXBELE1BQU0sVUFBVSxVQUFVLENBQUMsSUFJMUI7SUFDQyxNQUFNLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUMsR0FBRyxJQUFJLENBQUM7SUFDdEMsSUFBSSxFQUFDLE1BQU0sRUFBQyxHQUFHLE1BQU0sQ0FBQztJQUN0QixNQUFNLEVBQUMsV0FBVyxFQUFDLEdBQUcsS0FBSyxDQUFDO0lBRTVCLElBQUksTUFBTSxJQUFJLElBQUksRUFBRTtRQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7S0FDN0U7SUFFRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxXQUFXO1FBQ3JELE1BQU0sWUFBWSxnQkFBZ0IsQ0FBQztJQUN2QyxN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QUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuQyxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IDIwMjAgR29vZ2xlIExMQy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgYmFja2VuZCBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAqL1xuXG5pbXBvcnQge2VudiwgS2VybmVsQ29uZmlnLCBLZXJuZWxGdW5jfSBmcm9tICdAdGVuc29yZmxvdy90ZmpzLWNvcmUnO1xuaW1wb3J0IHtGcm9tUGl4ZWxzLCBGcm9tUGl4ZWxzQXR0cnMsIEZyb21QaXhlbHNJbnB1dHMsIHV0aWx9IGZyb20gJ0B0ZW5zb3JmbG93L3RmanMtY29yZSc7XG5pbXBvcnQge2JhY2tlbmRfdXRpbCwgVGVuc29ySW5mb30gZnJvbSAnQHRlbnNvcmZsb3cvdGZqcy1jb3JlJztcblxuaW1wb3J0IHtUZXh0dXJlSW5mbywgV2ViR1BVQmFja2VuZH0gZnJvbSAnLi4vYmFja2VuZF93ZWJncHUnO1xuaW1wb3J0IHtGcm9tUGl4ZWxzUHJvZ3JhbX0gZnJvbSAnLi4vZnJvbV9waXhlbHNfd2ViZ3B1JztcblxuZXhwb3J0IGNvbnN0IGZyb21QaXhlbHNDb25maWc6IEtlcm5lbENvbmZpZyA9IHtcbiAga2VybmVsTmFtZTogRnJvbVBpeGVscyxcbiAgYmFja2VuZE5hbWU6ICd3ZWJncHUnLFxuICBrZXJuZWxGdW5jOiBmcm9tUGl4ZWxzIGFzIHt9IGFzIEtlcm5lbEZ1bmMsXG59O1xuXG5sZXQgZnJvbVBpeGVsczJEQ29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xubGV0IHdpbGxSZWFkRnJlcXVlbnRseSA9IGVudigpLmdldEJvb2woJ0NBTlZBUzJEX1dJTExfUkVBRF9GUkVRVUVOVExZX0ZPUl9HUFUnKTtcbmNvbnN0IHZpZGVvVG9UZXh0dXJlTWFwID0gbmV3IE1hcDxvYmplY3QsIG9iamVjdD4oKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGZyb21QaXhlbHMoYXJnczoge1xuICBpbnB1dHM6IEZyb21QaXhlbHNJbnB1dHMsXG4gIGJhY2tlbmQ6IFdlYkdQVUJhY2tlbmQsXG4gIGF0dHJzOiBGcm9tUGl4ZWxzQXR0cnNcbn0pOiBUZW5zb3JJbmZvIHtcbiAgY29uc3Qge2lucHV0cywgYmFja2VuZCwgYXR0cnN9ID0gYXJncztcbiAgbGV0IHtwaXhlbHN9ID0gaW5wdXRzO1xuICBjb25zdCB7bnVtQ2hhbm5lbHN9ID0gYXR0cnM7XG5cbiAgaWYgKHBpeGVscyA9PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdwaXhlbHMgcGFzc2VkIHRvIHRmLmJyb3dzZXIuZnJvbVBpeGVscygpIGNhbiBub3QgYmUgbnVsbCcpO1xuICB9XG5cbiAgY29uc3QgaXNWaWRlbyA9IHR5cGVvZiAoSFRNTFZpZGVvRWxlbWVudCkgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICBwaXhlbHMgaW5zdGFuY2VvZiBIVE1MVmlkZW9FbGVtZW50O1xuICBjb25zdCBpc0ltYWdlID0gdHlwZW9mIChIVE1MSW1hZ2VFbGVtZW50KSAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAgIHBpeGVscyBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQ7XG4gIGNvbnN0IGlzQ2FudmFzID0gKHR5cGVvZiAoSFRNTENhbnZhc0VsZW1lbnQpICE9PSAndW5kZWZpbmVkJyAmJlxuICAgICAgICAgICAgICAgICAgICBwaXhlbHMgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudCkgfHxcbiAgICAgICh0eXBlb2YgKE9mZnNjcmVlbkNhbnZhcykgIT09ICd1bmRlZmluZWQnICYmXG4gICAgICAgcGl4ZWxzIGluc3RhbmNlb2YgT2Zmc2NyZWVuQ2FudmFzKTtcbiAgY29uc3QgaXNJbWFnZUJpdG1hcCA9XG4gICAgICB0eXBlb2YgKEltYWdlQml0bWFwKSAhPT0gJ3VuZGVmaW5lZCcgJiYgcGl4ZWxzIGluc3RhbmNlb2YgSW1hZ2VCaXRtYXA7XG5cbiAgY29uc3QgW3dpZHRoLCBoZWlnaHRdID0gaXNWaWRlbyA/XG4gICAgICBbXG4gICAgICAgIChwaXhlbHMgYXMgSFRNTFZpZGVvRWxlbWVudCkudmlkZW9XaWR0aCxcbiAgICAgICAgKHBpeGVscyBhcyBIVE1MVmlkZW9FbGVtZW50KS52aWRlb0hlaWdodFxuICAgICAgXSA6XG4gICAgICBbcGl4ZWxzLndpZHRoLCBwaXhlbHMuaGVpZ2h0XTtcbiAgY29uc3Qgb3V0cHV0U2hhcGUgPSBbaGVpZ2h0LCB3aWR0aCwgbnVtQ2hhbm5lbHNdO1xuXG4gIC8vIERpc2FibGUgaW1wb3J0RXh0ZXJuYWxUZXh0dXJlIHRlbXBvcmFyaWx5IGFzIGl0IGhhcyBwcm9ibGVtIGluIHNwZWMgYW5kXG4gIC8vIGJyb3dzZXIgaW1wbFxuICBjb25zdCBpbXBvcnRWaWRlbyA9XG4gICAgICBmYWxzZSAmJiBlbnYoKS5nZXRCb29sKCdXRUJHUFVfSU1QT1JUX0VYVEVSTkFMX1RFWFRVUkUnKSAmJiBpc1ZpZGVvO1xuICBjb25zdCBpc1ZpZGVvT3JJbWFnZSA9IGlzVmlkZW8gfHwgaXNJbWFnZTtcbiAgaWYgKGlzSW1hZ2VCaXRtYXAgfHwgaXNDYW52YXMgfHwgaXNWaWRlb09ySW1hZ2UpIHtcbiAgICBsZXQgdGV4dHVyZUluZm86IFRleHR1cmVJbmZvO1xuICAgIGlmIChpbXBvcnRWaWRlbykge1xuICAgICAgY29uc3QgdmlkZW9FbGVtZW50ID0gcGl4ZWxzIGFzIEhUTUxWaWRlb0VsZW1lbnQ7XG4gICAgICBpZiAoISh2aWRlb1RvVGV4dHVyZU1hcC5oYXModmlkZW9FbGVtZW50KSkgfHxcbiAgICAgICAgICAodmlkZW9Ub1RleHR1cmVNYXAuZ2V0KHZpZGVvRWxlbWVudCkgYXMgR1BVRXh0ZXJuYWxUZXh0dXJlKS5leHBpcmVkKSB7XG4gICAgICAgIGNvbnN0IGV4dGVybmFsVGV4dHVyZURlc2NyaXB0b3IgPSB7c291cmNlOiB2aWRlb0VsZW1lbnR9O1xuICAgICAgICB2aWRlb1RvVGV4dHVyZU1hcC5zZXQoXG4gICAgICAgICAgICB2aWRlb0VsZW1lbnQsXG4gICAgICAgICAgICBiYWNrZW5kLmRldmljZS5pbXBvcnRFeHRlcm5hbFRleHR1cmUoZXh0ZXJuYWxUZXh0dXJlRGVzY3JpcHRvcikpO1xuICAgICAgfVxuXG4gICAgICB0ZXh0dXJlSW5mbyA9IHtcbiAgICAgICAgd2lkdGgsXG4gICAgICAgIGhlaWdodCxcbiAgICAgICAgZm9ybWF0OiBudWxsLFxuICAgICAgICB1c2FnZTogbnVsbCxcbiAgICAgICAgdGV4dHVyZTogdmlkZW9Ub1RleHR1cmVNYXAuZ2V0KHZpZGVvRWxlbWVudCkgYXMgR1BVRXh0ZXJuYWxUZXh0dXJlXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaXNWaWRlb09ySW1hZ2UpIHtcbiAgICAgICAgY29uc3QgbmV3V2lsbFJlYWRGcmVxdWVudGx5ID1cbiAgICAgICAgICAgIGVudigpLmdldEJvb2woJ0NBTlZBUzJEX1dJTExfUkVBRF9GUkVRVUVOVExZX0ZPUl9HUFUnKTtcbiAgICAgICAgaWYgKGZyb21QaXhlbHMyRENvbnRleHQgPT0gbnVsbCB8fFxuICAgICAgICAgICAgbmV3V2lsbFJlYWRGcmVxdWVudGx5ICE9PSB3aWxsUmVhZEZyZXF1ZW50bHkpIHtcbiAgICAgICAgICB3aWxsUmVhZEZyZXF1ZW50bHkgPSBuZXdXaWxsUmVhZEZyZXF1ZW50bHk7XG4gICAgICAgICAgZnJvbVBpeGVsczJEQ29udGV4dCA9XG4gICAgICAgICAgICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpLmdldENvbnRleHQoXG4gICAgICAgICAgICAgICAgICAnMmQnLCB7d2lsbFJlYWRGcmVxdWVudGx5fSkgYXMgQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuICAgICAgICB9XG4gICAgICAgIGZyb21QaXhlbHMyRENvbnRleHQuY2FudmFzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIGZyb21QaXhlbHMyRENvbnRleHQuY2FudmFzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgZnJvbVBpeGVsczJEQ29udGV4dC5kcmF3SW1hZ2UoXG4gICAgICAgICAgICBwaXhlbHMgYXMgSFRNTFZpZGVvRWxlbWVudCB8IEhUTUxJbWFnZUVsZW1lbnQsIDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgICBwaXhlbHMgPSBmcm9tUGl4ZWxzMkRDb250ZXh0LmNhbnZhcztcbiAgICAgIH1cblxuICAgICAgY29uc3QgdXNhZ2UgPSBHUFVUZXh0dXJlVXNhZ2UuQ09QWV9EU1QgfFxuICAgICAgICAgIEdQVVRleHR1cmVVc2FnZS5SRU5ERVJfQVRUQUNITUVOVCB8IEdQVVRleHR1cmVVc2FnZS5URVhUVVJFX0JJTkRJTkc7XG4gICAgICBjb25zdCBmb3JtYXQgPSAncmdiYTh1bm9ybScgYXMgR1BVVGV4dHVyZUZvcm1hdDtcbiAgICAgIGNvbnN0IHRleHR1cmUgPSBiYWNrZW5kLnRleHR1cmVNYW5hZ2VyLmFjcXVpcmVUZXh0dXJlKFxuICAgICAgICAgIG91dHB1dFNoYXBlWzFdLCBvdXRwdXRTaGFwZVswXSwgZm9ybWF0LCB1c2FnZSk7XG4gICAgICBiYWNrZW5kLnF1ZXVlLmNvcHlFeHRlcm5hbEltYWdlVG9UZXh0dXJlKFxuICAgICAgICAgIHtzb3VyY2U6IHBpeGVscyBhcyBIVE1MQ2FudmFzRWxlbWVudCB8IEltYWdlQml0bWFwfSwge3RleHR1cmV9LFxuICAgICAgICAgIFtvdXRwdXRTaGFwZVsxXSwgb3V0cHV0U2hhcGVbMF1dKTtcbiAgICAgIHRleHR1cmVJbmZvID0ge3dpZHRoLCBoZWlnaHQsIGZvcm1hdCwgdXNhZ2UsIHRleHR1cmV9O1xuICAgIH1cblxuICAgIGNvbnN0IHNpemUgPSB1dGlsLnNpemVGcm9tU2hhcGUob3V0cHV0U2hhcGUpO1xuICAgIGNvbnN0IHN0cmlkZXMgPSB1dGlsLmNvbXB1dGVTdHJpZGVzKG91dHB1dFNoYXBlKTtcbiAgICBjb25zdCBwcm9ncmFtID1cbiAgICAgICAgbmV3IEZyb21QaXhlbHNQcm9ncmFtKG91dHB1dFNoYXBlLCBudW1DaGFubmVscywgaW1wb3J0VmlkZW8pO1xuXG4gICAgY29uc3QgdW5pZm9ybURhdGEgPSBbXG4gICAgICB7dHlwZTogJ3VpbnQzMicsIGRhdGE6IFtzaXplXX0sIHt0eXBlOiAndWludDMyJywgZGF0YTogW251bUNoYW5uZWxzXX0sXG4gICAgICB7dHlwZTogJ3VpbnQzMicsIGRhdGE6IFsuLi5zdHJpZGVzXX1cbiAgICBdO1xuICAgIGNvbnN0IGlucHV0ID0gYmFja2VuZC5tYWtlVGVuc29ySW5mbyhbaGVpZ2h0LCB3aWR0aF0sICdpbnQzMicpO1xuICAgIGNvbnN0IGluZm8gPSBiYWNrZW5kLnRlbnNvck1hcC5nZXQoaW5wdXQuZGF0YUlkKTtcbiAgICBpbmZvLnJlc291cmNlSW5mbyA9IHRleHR1cmVJbmZvO1xuXG4gICAgY29uc3QgcmVzdWx0ID1cbiAgICAgICAgYmFja2VuZC5ydW5XZWJHUFVQcm9ncmFtKHByb2dyYW0sIFtpbnB1dF0sICdpbnQzMicsIHVuaWZvcm1EYXRhKTtcbiAgICBiYWNrZW5kLmRpc3Bvc2VEYXRhKGlucHV0LmRhdGFJZCk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIC8vIFRPRE86IEVuY29kaW5nIHNob3VsZCBoYXBwZW4gb24gR1BVIG9uY2Ugd2Ugbm8gbG9uZ2VyIGhhdmUgdG8gZG93bmxvYWRcbiAgLy8gaW1hZ2UgZGF0YSB0byB0aGUgQ1BVLlxuICBjb25zdCBpbWFnZURhdGEgPSAocGl4ZWxzIGFzIEltYWdlRGF0YSB8IGJhY2tlbmRfdXRpbC5QaXhlbERhdGEpLmRhdGE7XG4gIGxldCBwaXhlbEFycmF5ID0gaW1hZ2VEYXRhO1xuICBpZiAobnVtQ2hhbm5lbHMgIT0gbnVsbCAmJiBudW1DaGFubmVscyAhPT0gNCkge1xuICAgIHBpeGVsQXJyYXkgPSBuZXcgVWludDhBcnJheShwaXhlbHMud2lkdGggKiBwaXhlbHMuaGVpZ2h0ICogbnVtQ2hhbm5lbHMpO1xuXG4gICAgY29uc3QgZGF0YUxlbmd0aCA9IGltYWdlRGF0YS5sZW5ndGg7XG4gICAgbGV0IGogPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YUxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoaSAlIDQgPCBudW1DaGFubmVscykge1xuICAgICAgICBwaXhlbEFycmF5W2orK10gPSBpbWFnZURhdGFbaV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgY29uc3Qgb3V0cHV0ID1cbiAgICAgIGJhY2tlbmQubWFrZVRlbnNvckluZm8ob3V0cHV0U2hhcGUsICdpbnQzMicsIG5ldyBJbnQzMkFycmF5KHBpeGVsQXJyYXkpKTtcbiAgYmFja2VuZC51cGxvYWRUb0dQVShvdXRwdXQuZGF0YUlkKTtcbiAgcmV0dXJuIG91dHB1dDtcbn1cbiJdfQ==