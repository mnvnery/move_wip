const arrayProduct = (arr) => {
    let product = 1;
    for (let i = 0; i < arr.length; i++) {
        product *= arr[i];
    }
    return product;
};
export function tilesFitEvenlyIntoShape(tileSize, shape) {
    if (tileSize.length !== shape.length) {
        throw new Error(`Cannot compute whether rank ${tileSize.length}` +
            ` tiles fit evenly into rank ${shape.length} shape` +
            ` - ranks must match.`);
    }
    return shape.every((dim, dimIdx) => dim % tileSize[dimIdx] === 0);
}
// Computes dispatch geometry based on layout of output dimensions and
// workGroupSize.
export function computeDispatch(layout, outputShape, workGroupSize = [1, 1, 1], elementsPerThread = [1, 1, 1]) {
    const [dispatchX, dispatchY, dispatchZ] = [
        Math.ceil(arrayProduct(layout.x.map(d => outputShape[d])) /
            (workGroupSize[0] * elementsPerThread[0])),
        layout.y ? Math.ceil(arrayProduct(layout.y.map(d => outputShape[d])) /
            (workGroupSize[1] * elementsPerThread[1])) :
            1,
        layout.z ? Math.ceil(arrayProduct(layout.z.map(d => outputShape[d])) /
            (workGroupSize[2] * elementsPerThread[2])) :
            1
    ];
    return [dispatchX, dispatchY, dispatchZ];
}
export function computeWorkGroupInfoForMatMul(dimAOuter, dimInner, dimBOuter, transposeA = false) {
    // These are experimental values. Usually, we need to adjust the work group
    // size based on the input shapes to improve the EU occupancy.
    // TODO: WebGPU limits the maximum allowed shared memory size as 16K. To make
    // sure it doesn't exceed this limitations. Temporarily reduce the work group
    // size to [8, 8, 1] and the work per thread size is [4, 4, 1]. But we should
    // revisit it and find the balance between work group size and work per thread
    // size.
    const workGroupSize = [8, 8, 1];
    const elementsPerThread = [4, 4, 1];
    if (!transposeA) {
        if (dimAOuter <= 8) {
            elementsPerThread[1] = 1;
        }
        if (dimInner <= 16 && dimBOuter <= 16) {
            workGroupSize[0] = 4;
        }
    }
    return { workGroupSize, elementsPerThread };
}
export function computeWorkGroupSizeForConv2d(layout, outputShape, isVec4 = false) {
    if (isVec4) {
        return [8, 8, 1];
    }
    const dim0 = arrayProduct(layout.x.map(d => outputShape[d]));
    const dim1 = arrayProduct(layout.y.map(d => outputShape[d]));
    // TODO(jiajia.qin@intel.com): More fine tune based on outputShape.
    // These are experimental values. Usually, we need to adjust the work group
    // size based on the output shape. For example, when one dimension is smaller
    // than 4, it will be wasteful if we assign a larger size for this dimension,
    // which results lots of threads doing useless work and reduces parallelism
    // of hardware threads. But it is always a balance between work group size
    // and shared memory. If one dimension is too small, such as 1, shared memory
    // will won't be fully utilized.
    if (dim0 <= 4) {
        return [4, 16, 1];
    }
    if (dim1 <= 4) {
        return [16, 4, 1];
    }
    return [16, 16, 1];
}
export function computeWorkPerThreadForConv2d(layout, outputShape, isVec4 = false) {
    if (isVec4) {
        return [4, 4, 1];
    }
    const dim0 = arrayProduct(layout.x.map(d => outputShape[d]));
    const dim1 = arrayProduct(layout.y.map(d => outputShape[d]));
    // TODO(jiajia.qin@intel.com): More fine tune based on outputShape.
    // The following conditions correspond to the values set in
    // computeWorkGroupSizeForConv2d.
    if (dim0 <= 4) {
        return [1, 2, 1];
    }
    if (dim1 <= 4) {
        return [2, 1, 1];
    }
    return [2, 2, 1];
}
export function flatDispatchLayout(shape) {
    return { x: shape.map((d, i) => i) };
}
export function GPUBytesPerElement(dtype) {
    if (dtype === 'float32' || dtype === 'int32' || dtype === 'bool' ||
        dtype === 'string') {
        return 4;
    }
    else if (dtype === 'complex64') {
        return 8;
    }
    else {
        throw new Error(`Unknown dtype ${dtype}`);
    }
}
export function ArrayBufferToTypedArray(data, dtype) {
    if (dtype === 'float32') {
        return new Float32Array(data);
    }
    else if (dtype === 'int32') {
        return new Int32Array(data);
    }
    else if (dtype === 'bool' || dtype === 'string') {
        return Uint8Array.from(new Int32Array(data));
    }
    else {
        throw new Error(`Unknown dtype ${dtype}`);
    }
}
export function isWebGPUSupported() {
    return ((typeof window !== 'undefined') ||
        //@ts-ignore
        (typeof WorkerGlobalScope !== 'undefined')) &&
        !!navigator.gpu;
}
export var MatMulProgramType;
(function (MatMulProgramType) {
    MatMulProgramType[MatMulProgramType["MatMulReduceProgram"] = 0] = "MatMulReduceProgram";
    MatMulProgramType[MatMulProgramType["MatMulSplitKProgram"] = 1] = "MatMulSplitKProgram";
    MatMulProgramType[MatMulProgramType["MatMulSmallOutputSizeProgram"] = 2] = "MatMulSmallOutputSizeProgram";
    MatMulProgramType[MatMulProgramType["MatMulPackedProgram"] = 3] = "MatMulPackedProgram";
    MatMulProgramType[MatMulProgramType["MatMulMax"] = 4] = "MatMulMax";
})(MatMulProgramType || (MatMulProgramType = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViZ3B1X3V0aWwuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZmpzLWJhY2tlbmQtd2ViZ3B1L3NyYy93ZWJncHVfdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFrQkEsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFhLEVBQUUsRUFBRTtJQUNyQyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUM7SUFDaEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkMsT0FBTyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNuQjtJQUNELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMsQ0FBQztBQUVGLE1BQU0sVUFBVSx1QkFBdUIsQ0FDbkMsUUFBa0IsRUFBRSxLQUFlO0lBQ3JDLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQ1gsK0JBQStCLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDaEQsK0JBQStCLEtBQUssQ0FBQyxNQUFNLFFBQVE7WUFDbkQsc0JBQXNCLENBQUMsQ0FBQztLQUM3QjtJQUNELE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FDZCxDQUFDLEdBQVcsRUFBRSxNQUFjLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7QUFDckUsQ0FBQztBQUVELHNFQUFzRTtBQUN0RSxpQkFBaUI7QUFDakIsTUFBTSxVQUFVLGVBQWUsQ0FDM0IsTUFBaUQsRUFBRSxXQUFxQixFQUN4RSxnQkFBMEMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUNuRCxvQkFDSSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2YsTUFBTSxDQUFDLFNBQVMs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O1FBQy9DLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO0FBQ3RCLENBQUM7QUFFRCxNQUFNLENBQU4sSUFBWSxpQkFNWDtBQU5ELFdBQVksaUJBQWlCO0lBQzNCLHVGQUFtQixDQUFBO0lBQ25CLHVGQUFtQixDQUFBO0lBQ25CLHlHQUE0QixDQUFBO0lBQzVCLHVGQUFtQixDQUFBO0lBQ25CLG1FQUFTLENBQUE7QUFDWCxDQUFDLEVBTlcsaUJBQWlCLEtBQWpCLGlCQUFpQixRQU01QiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEdvb2dsZSBMTEMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gKi9cbmltcG9ydCB7RGF0YVR5cGV9IGZyb20gJ0B0ZW5zb3JmbG93L3RmanMtY29yZSc7XG5cbmNvbnN0IGFycmF5UHJvZHVjdCA9IChhcnI6IG51bWJlcltdKSA9PiB7XG4gIGxldCBwcm9kdWN0ID0gMTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICBwcm9kdWN0ICo9IGFycltpXTtcbiAgfVxuICByZXR1cm4gcHJvZHVjdDtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiB0aWxlc0ZpdEV2ZW5seUludG9TaGFwZShcbiAgICB0aWxlU2l6ZTogbnVtYmVyW10sIHNoYXBlOiBudW1iZXJbXSk6IGJvb2xlYW4ge1xuICBpZiAodGlsZVNpemUubGVuZ3RoICE9PSBzaGFwZS5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgY29tcHV0ZSB3aGV0aGVyIHJhbmsgJHt0aWxlU2l6ZS5sZW5ndGh9YCArXG4gICAgICAgIGAgdGlsZXMgZml0IGV2ZW5seSBpbnRvIHJhbmsgJHtzaGFwZS5sZW5ndGh9IHNoYXBlYCArXG4gICAgICAgIGAgLSByYW5rcyBtdXN0IG1hdGNoLmApO1xuICB9XG4gIHJldHVybiBzaGFwZS5ldmVyeShcbiAgICAgIChkaW06IG51bWJlciwgZGltSWR4OiBudW1iZXIpID0+IGRpbSAlIHRpbGVTaXplW2RpbUlkeF0gPT09IDApO1xufVxuXG4vLyBDb21wdXRlcyBkaXNwYXRjaCBnZW9tZXRyeSBiYXNlZCBvbiBsYXlvdXQgb2Ygb3V0cHV0IGRpbWVuc2lvbnMgYW5kXG4vLyB3b3JrR3JvdXBTaXplLlxuZXhwb3J0IGZ1bmN0aW9uIGNvbXB1dGVEaXNwYXRjaChcbiAgICBsYXlvdXQ6IHt4OiBudW1iZXJbXSwgeT86IG51bWJlcltdLCB6PzogbnVtYmVyW119LCBvdXRwdXRTaGFwZTogbnVtYmVyW10sXG4gICAgd29ya0dyb3VwU2l6ZTogW251bWJlciwgbnVtYmVyLCBudW1iZXJdID0gWzEsIDEsIDFdLFxuICAgIGVsZW1lbnRzUGVyVGhyZWFkOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0gPVxuICAgICAgICBbMSwgMSwgMV0pOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0ge1xuICBjb25zdCBbZGlzcGF0Y2hYLCBkaXNwYXRjaFksIGRpc3BhdGNoWl0gPSBbXG4gICAgTWF0aC5jZWlsKFxuICAgICAgICBhcnJheVByb2R1Y3QobGF5b3V0LngubWFwKGQgPT4gb3V0cHV0U2hhcGVbZF0pKSAvXG4gICAgICAgICh3b3JrR3JvdXBTaXplWzBdICogZWxlbWVudHNQZXJUaHJlYWRbMF0pKSxcbiAgICBsYXlvdXQueSA/IE1hdGguY2VpbChcbiAgICAgICAgICAgICAgICAgICBhcnJheVByb2R1Y3QobGF5b3V0LnkubWFwKGQgPT4gb3V0cHV0U2hhcGVbZF0pKSAvXG4gICAgICAgICAgICAgICAgICAgKHdvcmtHcm91cFNpemVbMV0gKiBlbGVtZW50c1BlclRocmVhZFsxXSkpIDpcbiAgICAgICAgICAgICAgIDEsXG4gICAgbGF5b3V0LnogPyBNYXRoLmNlaWwoXG4gICAgICAgICAgICAgICAgICAgYXJyYXlQcm9kdWN0KGxheW91dC56Lm1hcChkID0+IG91dHB1dFNoYXBlW2RdKSkgL1xuICAgICAgICAgICAgICAgICAgICh3b3JrR3JvdXBTaXplWzJdICogZWxlbWVudHNQZXJUaHJlYWRbMl0pKSA6XG4gICAgICAgICAgICAgICAxXG4gIF07XG4gIHJldHVybiBbZGlzcGF0Y2hYLCBkaXNwYXRjaFksIGRpc3BhdGNoWl07XG59XG5cbmV4cG9ydCB0eXBlIFdvcmtHcm91cEluZm8gPSB7XG4gIHdvcmtHcm91cFNpemU6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSxcbiAgZWxlbWVudHNQZXJUaHJlYWQ6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSxcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlV29ya0dyb3VwSW5mb0Zvck1hdE11bChcbiAgICBkaW1BT3V0ZXI6IG51bWJlciwgZGltSW5uZXI6IG51bWJlciwgZGltQk91dGVyOiBudW1iZXIsXG4gICAgdHJhbnNwb3NlQSA9IGZhbHNlKTogV29ya0dyb3VwSW5mbyB7XG4gIC8vIFRoZXNlIGFyZSBleHBlcmltZW50YWwgdmFsdWVzLiBVc3VhbGx5LCB3ZSBuZWVkIHRvIGFkanVzdCB0aGUgd29yayBncm91cFxuICAvLyBzaXplIGJhc2VkIG9uIHRoZSBpbnB1dCBzaGFwZXMgdG8gaW1wcm92ZSB0aGUgRVUgb2NjdXBhbmN5LlxuICAvLyBUT0RPOiBXZWJHUFUgbGltaXRzIHRoZSBtYXhpbXVtIGFsbG93ZWQgc2hhcmVkIG1lbW9yeSBzaXplIGFzIDE2Sy4gVG8gbWFrZVxuICAvLyBzdXJlIGl0IGRvZXNuJ3QgZXhjZWVkIHRoaXMgbGltaXRhdGlvbnMuIFRlbXBvcmFyaWx5IHJlZHVjZSB0aGUgd29yayBncm91cFxuICAvLyBzaXplIHRvIFs4LCA4LCAxXSBhbmQgdGhlIHdvcmsgcGVyIHRocmVhZCBzaXplIGlzIFs0LCA0LCAxXS4gQnV0IHdlIHNob3VsZFxuICAvLyByZXZpc2l0IGl0IGFuZCBmaW5kIHRoZSBiYWxhbmNlIGJldHdlZW4gd29yayBncm91cCBzaXplIGFuZCB3b3JrIHBlciB0aHJlYWRcbiAgLy8gc2l6ZS5cbiAgY29uc3Qgd29ya0dyb3VwU2l6ZTogW251bWJlciwgbnVtYmVyLCBudW1iZXJdID0gWzgsIDgsIDFdO1xuICBjb25zdCBlbGVtZW50c1BlclRocmVhZDogW251bWJlciwgbnVtYmVyLCBudW1iZXJdID0gWzQsIDQsIDFdO1xuXG4gIGlmICghdHJhbnNwb3NlQSkge1xuICAgIGlmIChkaW1BT3V0ZXIgPD0gOCkge1xuICAgICAgZWxlbWVudHNQZXJUaHJlYWRbMV0gPSAxO1xuICAgIH1cblxuICAgIGlmIChkaW1Jbm5lciA8PSAxNiAmJiBkaW1CT3V0ZXIgPD0gMTYpIHtcbiAgICAgIHdvcmtHcm91cFNpemVbMF0gPSA0O1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7d29ya0dyb3VwU2l6ZSwgZWxlbWVudHNQZXJUaHJlYWR9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZVdvcmtHcm91cFNpemVGb3JDb252MmQoXG4gICAgbGF5b3V0OiB7eDogbnVtYmVyW10sIHk/OiBudW1iZXJbXSwgej86IG51bWJlcltdfSwgb3V0cHV0U2hhcGU6IG51bWJlcltdLFxuICAgIGlzVmVjNCA9IGZhbHNlKTogW251bWJlciwgbnVtYmVyLCBudW1iZXJdIHtcbiAgaWYgKGlzVmVjNCkge1xuICAgIHJldHVybiBbOCwgOCwgMV07XG4gIH1cblxuICBjb25zdCBkaW0wID0gYXJyYXlQcm9kdWN0KGxheW91dC54Lm1hcChkID0+IG91dHB1dFNoYXBlW2RdKSk7XG4gIGNvbnN0IGRpbTEgPSBhcnJheVByb2R1Y3QobGF5b3V0LnkubWFwKGQgPT4gb3V0cHV0U2hhcGVbZF0pKTtcbiAgLy8gVE9ETyhqaWFqaWEucWluQGludGVsLmNvbSk6IE1vcmUgZmluZSB0dW5lIGJhc2VkIG9uIG91dHB1dFNoYXBlLlxuICAvLyBUaGVzZSBhcmUgZXhwZXJpbWVudGFsIHZhbHVlcy4gVXN1YWxseSwgd2UgbmVlZCB0byBhZGp1c3QgdGhlIHdvcmsgZ3JvdXBcbiAgLy8gc2l6ZSBiYXNlZCBvbiB0aGUgb3V0cHV0IHNoYXBlLiBGb3IgZXhhbXBsZSwgd2hlbiBvbmUgZGltZW5zaW9uIGlzIHNtYWxsZXJcbiAgLy8gdGhhbiA0LCBpdCB3aWxsIGJlIHdhc3RlZnVsIGlmIHdlIGFzc2lnbiBhIGxhcmdlciBzaXplIGZvciB0aGlzIGRpbWVuc2lvbixcbiAgLy8gd2hpY2ggcmVzdWx0cyBsb3RzIG9mIHRocmVhZHMgZG9pbmcgdXNlbGVzcyB3b3JrIGFuZCByZWR1Y2VzIHBhcmFsbGVsaXNtXG4gIC8vIG9mIGhhcmR3YXJlIHRocmVhZHMuIEJ1dCBpdCBpcyBhbHdheXMgYSBiYWxhbmNlIGJldHdlZW4gd29yayBncm91cCBzaXplXG4gIC8vIGFuZCBzaGFyZWQgbWVtb3J5LiBJZiBvbmUgZGltZW5zaW9uIGlzIHRvbyBzbWFsbCwgc3VjaCBhcyAxLCBzaGFyZWQgbWVtb3J5XG4gIC8vIHdpbGwgd29uJ3QgYmUgZnVsbHkgdXRpbGl6ZWQuXG4gIGlmIChkaW0wIDw9IDQpIHtcbiAgICByZXR1cm4gWzQsIDE2LCAxXTtcbiAgfVxuICBpZiAoZGltMSA8PSA0KSB7XG4gICAgcmV0dXJuIFsxNiwgNCwgMV07XG4gIH1cblxuICByZXR1cm4gWzE2LCAxNiwgMV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb21wdXRlV29ya1BlclRocmVhZEZvckNvbnYyZChcbiAgICBsYXlvdXQ6IHt4OiBudW1iZXJbXSwgeT86IG51bWJlcltdLCB6PzogbnVtYmVyW119LCBvdXRwdXRTaGFwZTogbnVtYmVyW10sXG4gICAgaXNWZWM0ID0gZmFsc2UpOiBbbnVtYmVyLCBudW1iZXIsIG51bWJlcl0ge1xuICBpZiAoaXNWZWM0KSB7XG4gICAgcmV0dXJuIFs0LCA0LCAxXTtcbiAgfVxuXG4gIGNvbnN0IGRpbTAgPSBhcnJheVByb2R1Y3QobGF5b3V0LngubWFwKGQgPT4gb3V0cHV0U2hhcGVbZF0pKTtcbiAgY29uc3QgZGltMSA9IGFycmF5UHJvZHVjdChsYXlvdXQueS5tYXAoZCA9PiBvdXRwdXRTaGFwZVtkXSkpO1xuICAvLyBUT0RPKGppYWppYS5xaW5AaW50ZWwuY29tKTogTW9yZSBmaW5lIHR1bmUgYmFzZWQgb24gb3V0cHV0U2hhcGUuXG4gIC8vIFRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBjb3JyZXNwb25kIHRvIHRoZSB2YWx1ZXMgc2V0IGluXG4gIC8vIGNvbXB1dGVXb3JrR3JvdXBTaXplRm9yQ29udjJkLlxuICBpZiAoZGltMCA8PSA0KSB7XG4gICAgcmV0dXJuIFsxLCAyLCAxXTtcbiAgfVxuICBpZiAoZGltMSA8PSA0KSB7XG4gICAgcmV0dXJuIFsyLCAxLCAxXTtcbiAgfVxuXG4gIHJldHVybiBbMiwgMiwgMV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmbGF0RGlzcGF0Y2hMYXlvdXQoc2hhcGU6IG51bWJlcltdKSB7XG4gIHJldHVybiB7eDogc2hhcGUubWFwKChkLCBpKSA9PiBpKX07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBHUFVCeXRlc1BlckVsZW1lbnQoZHR5cGU6IERhdGFUeXBlKTogbnVtYmVyIHtcbiAgaWYgKGR0eXBlID09PSAnZmxvYXQzMicgfHwgZHR5cGUgPT09ICdpbnQzMicgfHwgZHR5cGUgPT09ICdib29sJyB8fFxuICAgICAgZHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIDQ7XG4gIH0gZWxzZSBpZiAoZHR5cGUgPT09ICdjb21wbGV4NjQnKSB7XG4gICAgcmV0dXJuIDg7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIGR0eXBlICR7ZHR5cGV9YCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIEFycmF5QnVmZmVyVG9UeXBlZEFycmF5KGRhdGE6IEFycmF5QnVmZmVyLCBkdHlwZTogRGF0YVR5cGUpIHtcbiAgaWYgKGR0eXBlID09PSAnZmxvYXQzMicpIHtcbiAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShkYXRhKTtcbiAgfSBlbHNlIGlmIChkdHlwZSA9PT0gJ2ludDMyJykge1xuICAgIHJldHVybiBuZXcgSW50MzJBcnJheShkYXRhKTtcbiAgfSBlbHNlIGlmIChkdHlwZSA9PT0gJ2Jvb2wnIHx8IGR0eXBlID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiBVaW50OEFycmF5LmZyb20obmV3IEludDMyQXJyYXkoZGF0YSkpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBkdHlwZSAke2R0eXBlfWApO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1dlYkdQVVN1cHBvcnRlZCgpOiBib29sZWFuIHtcbiAgcmV0dXJuICgodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHx8XG4gICAgICAgICAgLy9AdHMtaWdub3JlXG4gICAgICAgICAgKHR5cGVvZiBXb3JrZXJHbG9iYWxTY29wZSAhPT0gJ3VuZGVmaW5lZCcpKSAmJlxuICAgICAgISFuYXZpZ2F0b3IuZ3B1O1xufVxuXG5leHBvcnQgZW51bSBNYXRNdWxQcm9ncmFtVHlwZSB7XG4gIE1hdE11bFJlZHVjZVByb2dyYW0sXG4gIE1hdE11bFNwbGl0S1Byb2dyYW0sXG4gIE1hdE11bFNtYWxsT3V0cHV0U2l6ZVByb2dyYW0sXG4gIE1hdE11bFBhY2tlZFByb2dyYW0sXG4gIE1hdE11bE1heFxufVxuIl19