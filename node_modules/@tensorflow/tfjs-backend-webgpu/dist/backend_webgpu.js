/**
 * @license
 * Copyright 2019 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */
import './flags_webgpu';
import { backend_util, buffer, DataStorage, engine, env, KernelBackend, util } from '@tensorflow/tfjs-core';
import { AdapterInfo } from './adapter_info';
import { BufferManager } from './buffer_manager';
import { TextureManager } from './texture_manager';
import * as webgpu_program from './webgpu_program';
import * as webgpu_util from './webgpu_util';
// Empirically determined constant used to determine size threshold for handing
// off execution to the CPU.
const CPU_HANDOFF_SIZE_THRESHOLD = env().getNumber('WEBGPU_CPU_HANDOFF_SIZE_THRESHOLD');
// Reshape dispatch, not to exceed device limits.
const reshapeDispatch = (device, program) => {
    const MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE = device.limits.maxComputeWorkgroupsPerDimension;
    const layout = program['dispatchLayout'];
    const dispatch = program['dispatch'];
    if (dispatch.every((d) => d <= MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE)) {
        return dispatch;
    }
    util.assert(dispatch[0] > MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE &&
        layout.y === undefined && layout.z === undefined, () => 'Dispatch size exceeds WebGPU limits in Y or Z dimension.');
    let dispatchAverage = Math.ceil(Math.sqrt(dispatch[0]));
    if (dispatchAverage > MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE) {
        dispatchAverage = Math.ceil(Math.cbrt(dispatch[0]));
        util.assert(dispatchAverage <= MAX_COMPUTE_PER_DIMENSION_DISPATCH_SIZE, () => 'Total dispatch size exceeds WebGPU maximum.');
        return [dispatchAverage, dispatchAverage, dispatchAverage];
    }
    else {
        return [dispatchAverage, dispatchAverage, 1];
    }
};
export class WebGPUBackend extends KernelBackend {
    constructor(device, adapterInfo) {
        super();
        this.commandQueueOwnedIds = new WeakSet();
        this.dispatchNumberInEncoder = 0;
        this.disposed = false;
        this.downloadWaitMs = 0;
        this.tensorDataPendingDisposal = [];
        this.stagingPendingDisposal = [];
        this.uniformPendingDisposal = [];
        this.uploadWaitMs = 0;
        if (!webgpu_util.isWebGPUSupported()) {
            throw new Error('WebGPU is not supported on this device');
        }
        this.pipelineCache = {};
        this.device = device;
        this.queue = device.queue;
        this.currentCommandEncoder = null;
        this.currentComputePass = null;
        this.supportTimeQuery = device.features.has('timestamp-query');
        this.adapterInfo = new AdapterInfo(adapterInfo);
        this.bufferManager = new BufferManager(this.device);
        this.textureManager = new TextureManager(this.device);
        this.tensorMap = new DataStorage(this, engine());
        if (this.supportTimeQuery) {
            this.querySet = this.device.createQuerySet({
                type: 'timestamp',
                count: 2,
            });
        }
        // Profiling tools like PIX needs this dummy canvas to
        // trigger capturing a frame.
        if (env().getBool('WEBGPU_USE_PROFILE_TOOL')) {
            this.dummyCanvas = document.createElement('canvas');
            this.dummyCanvas.width = 1;
            this.dummyCanvas.height = 1;
            this.dummyContext = this.dummyCanvas.getContext('webgpu');
            this.dummyContext.configure({
                device,
                format: 'bgra8unorm',
            });
            document.body.appendChild(this.dummyCanvas);
        }
    }
    nextDataId() {
        return WebGPUBackend.nextDataId++;
    }
    floatPrecision() {
        return 32;
    }
    defaultGpuBufferUsage() {
        return GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC |
            GPUBufferUsage.COPY_DST;
    }
    /**
     * Dispose the memory if the dataId has 0 refCount. Return true if the memory
     * is released or memory is not managed in this backend, false if memory is
     * not cleared.
     * @param dataId
     * @oaram force Optional, remove the data regardless of refCount
     */
    disposeData(dataId, force = false) {
        if (this.tensorDataPendingDisposal.indexOf(dataId) >= 0) {
            return false;
        }
        if (!this.tensorMap.has(dataId)) {
            return true;
        }
        const tensorData = this.tensorMap.get(dataId);
        this.decRef(dataId);
        if (!force && tensorData.refCount > 0) {
            return false;
        }
        // complex is never in commandQueueOwnedIds
        if (this.commandQueueOwnedIds.has(dataId)) {
            this.tensorDataPendingDisposal.push(dataId);
            return false;
        }
        const { complexTensorInfos } = this.tensorMap.get(dataId);
        if (complexTensorInfos != null) {
            this.disposeData(complexTensorInfos.real.dataId, force);
            this.disposeData(complexTensorInfos.imag.dataId, force);
        }
        this.releaseResource(dataId);
        this.tensorMap.delete(dataId);
        return true;
    }
    memory() {
        return {
            numBytesInGPU: this.bufferManager.numBytesUsed,
            numBytesAllocatedInGPU: this.bufferManager.numBytesAllocated,
            unreliable: false
        };
    }
    releaseResource(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        if (!tensorData || !tensorData.resourceInfo) {
            return;
        }
        if ('texture' in tensorData.resourceInfo) {
            const textureInfo = tensorData.resourceInfo;
            if (textureInfo.texture instanceof GPUTexture) {
                this.textureManager.releaseTexture(textureInfo.texture, textureInfo.width, textureInfo.height, textureInfo.format, textureInfo.usage);
            }
            textureInfo.texture = null;
        }
        else {
            const bufferInfo = tensorData.resourceInfo;
            this.bufferManager.releaseBuffer(bufferInfo.buffer, bufferInfo.size, bufferInfo.usage);
            bufferInfo.buffer = null;
        }
        tensorData.resourceInfo = null;
    }
    /** Return refCount of a `TensorData`. */
    refCount(dataId) {
        if (this.tensorMap.has(dataId)) {
            const tensorData = this.tensorMap.get(dataId);
            return tensorData.refCount;
        }
        return 0;
    }
    /** Increase refCount of a `TensorData`. */
    incRef(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        tensorData.refCount++;
    }
    /** Decrease refCount of a `TensorData`. */
    decRef(dataId) {
        if (this.tensorMap.has(dataId)) {
            const tensorData = this.tensorMap.get(dataId);
            tensorData.refCount--;
        }
    }
    write(values, shape, dtype) {
        if (dtype === 'complex64' && values != null) {
            throw new Error(`Cannot write to a complex64 dtype. ` +
                `Please use tf.complex(real, imag).`);
        }
        const dataId = { id: this.nextDataId() };
        this.tensorMap.set(dataId, { dtype, shape, values, refCount: 1 });
        return dataId;
    }
    move(dataId, values, shape, dtype, refCount) {
        if (dtype === 'complex64') {
            throw new Error(`Cannot write to a complex64 dtype. ` +
                `Please use tf.complex(real, imag).`);
        }
        this.tensorMap.set(dataId, { dtype, shape, values, refCount });
    }
    submitQueue() {
        this.ensureComputePassEnded();
        this.queue.submit([this.currentCommandEncoder.finish()]);
        this.currentCommandEncoder = null;
        this.dispatchNumberInEncoder = 0;
        this.commandQueueOwnedIds = new WeakSet();
        this.tensorDataPendingDisposal.forEach(d => {
            this.releaseResource(d);
            this.tensorMap.delete(d);
        });
        this.uniformPendingDisposal.forEach(d => this.bufferManager.releaseBuffer(d.buffer, d.size, d.usage));
        this.stagingPendingDisposal.forEach(d => this.bufferManager.releaseUploadBuffer(d.buffer, d.size, d.usage));
        this.tensorDataPendingDisposal = [];
        this.uniformPendingDisposal = [];
        this.stagingPendingDisposal = [];
    }
    ensureCommandEncoderReady() {
        if (!this.currentCommandEncoder) {
            this.currentCommandEncoder = this.device.createCommandEncoder();
        }
    }
    ensureComputePassEnded() {
        if (this.currentComputePass) {
            this.currentComputePass.end();
            this.currentComputePass = null;
        }
    }
    getComputePass() {
        if (!this.currentComputePass) {
            this.currentComputePass = this.currentCommandEncoder.beginComputePass();
        }
        return this.currentComputePass;
    }
    async getBufferData(buffer, size) {
        const staging = this.bufferManager.acquireBuffer(size, GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.copyBufferToBuffer(buffer, 0, staging, 0, size);
        this.submitQueue();
        await staging.mapAsync(GPUMapMode.READ);
        const values = staging.getMappedRange().slice(0);
        staging.unmap();
        if (staging != null) {
            this.bufferManager.releaseBuffer(staging, size, GPUBufferUsage.COPY_DST | GPUBufferUsage.MAP_READ);
        }
        // Need to get texture from swapChain to enable profiling tool
        // to capture a frame
        if (env().getBool('WEBGPU_USE_PROFILE_TOOL')) {
            util.assert(this.dummyContext !== undefined, () => `Fail to get context for profiling tool`);
            this.dummyContext.getCurrentTexture();
        }
        return values;
    }
    convertAndCacheOnCPU(dataId, data) {
        const tensorData = this.tensorMap.get(dataId);
        this.releaseResource(dataId);
        tensorData.values = data;
        return tensorData.values;
    }
    // TODO: Remove once this is fixed:
    // https://github.com/tensorflow/tfjs/issues/1595
    readSync(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        const { values } = tensorData;
        if (values == null) {
            throw new Error('WebGPU readSync is only available for CPU-resident tensors.');
        }
        return values;
    }
    async read(dataId) {
        if (!this.tensorMap.has(dataId)) {
            throw new Error(`Tensor ${dataId} was not registered!`);
        }
        const tensorData = this.tensorMap.get(dataId);
        const { values } = tensorData;
        if (values != null) {
            // TODO(xing.xu@intel.com): Merge backend_util.BackendValues and
            // backend_util.TypedArray.
            return this.convertAndCacheOnCPU(dataId, values);
        }
        // Download the values from the GPU.
        let vals;
        if (tensorData.dtype === 'complex64') {
            const ps = await Promise.all([
                this.read(tensorData.complexTensorInfos.real.dataId),
                this.read(tensorData.complexTensorInfos.imag.dataId)
            ]);
            const realValues = ps[0];
            const imagValues = ps[1];
            vals = backend_util.mergeRealAndImagArrays(realValues, imagValues);
        }
        else {
            const bufferInfo = tensorData.resourceInfo;
            const data = await this.getBufferData(bufferInfo.buffer, bufferInfo.size);
            vals = webgpu_util.ArrayBufferToTypedArray(data, tensorData.dtype);
        }
        this.convertAndCacheOnCPU(dataId, vals);
        return vals;
    }
    /**
     * Read tensor to a new GPUBuffer.
     * @param dataId The source tensor.
     */
    readToGPU(dataId) {
        const srcTensorData = this.tensorMap.get(dataId);
        const { values, dtype, shape, resourceInfo } = srcTensorData;
        if (dtype === 'complex64') {
            throw new Error('Does not support reading buffer for complex64 dtype.');
        }
        if (resourceInfo == null) {
            if (values != null) {
                throw new Error('Data is not on GPU but on CPU.');
            }
            else {
                throw new Error('There is no data on GPU or CPU.');
            }
        }
        const size = resourceInfo.size;
        const buffer = this.bufferManager.acquireBuffer(size, resourceInfo.usage);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.copyBufferToBuffer(resourceInfo.buffer, 0, buffer, 0, size);
        this.submitQueue();
        const tensorInfo = this.makeTensorInfo(shape, dtype);
        // Make engine track this tensor, so that we can dispose it later.
        const tensorRef = engine().makeTensorFromTensorInfo(tensorInfo);
        const tensorData = this.tensorMap.get(tensorInfo.dataId);
        tensorData
            .resourceInfo = { size, usage: this.defaultGpuBufferUsage(), buffer };
        return { tensorRef, buffer, bufSize: size };
    }
    bufferSync(t) {
        const data = this.readSync(t.dataId);
        if (t.dtype === 'string') {
            try {
                // Decode the bytes into string.
                const strings = data.map(d => util.decodeString(d));
                return buffer(t.shape, t.dtype, strings);
            }
            catch (_a) {
                throw new Error('Failed to decode encoded string bytes into utf-8');
            }
        }
        return buffer(t.shape, t.dtype, data);
    }
    async time(f) {
        if (!this.supportTimeQuery) {
            console.warn(`This device doesn't support timestamp-query extension. ` +
                `Start Chrome browser with flag ` +
                `--disable-dawn-features=disallow_unsafe_apis then try again. ` +
                `Otherwise, zero will be shown for the kernel time when profiling ` +
                `mode is enabled. Using performance.now is not workable for webgpu ` +
                `since it doesn't support synchronous data read from GPU.`);
        }
        const oldActiveTimers = this.activeTimers;
        const newActiveTimers = [];
        let outerMostTime = false;
        if (this.programTimersStack == null) {
            this.programTimersStack = newActiveTimers;
            outerMostTime = true;
        }
        else {
            this.activeTimers.push(newActiveTimers);
        }
        this.activeTimers = newActiveTimers;
        f();
        const flattenedActiveTimerQueries = util.flatten(this.activeTimers.map((d) => d.query))
            .filter(d => d != null);
        const flattenedActiveTimerNames = util.flatten(this.activeTimers.map((d) => d.name))
            .filter(d => d != null);
        this.activeTimers = oldActiveTimers;
        if (outerMostTime) {
            this.programTimersStack = null;
        }
        const res = {
            uploadWaitMs: this.uploadWaitMs,
            downloadWaitMs: this.downloadWaitMs,
            kernelMs: null,
            wallMs: null
        };
        const kernelMs = await Promise.all(flattenedActiveTimerQueries);
        res['kernelMs'] = util.sum(kernelMs);
        res['getExtraProfileInfo'] = () => kernelMs.map((d, i) => ({ name: flattenedActiveTimerNames[i], ms: d }))
            .map(d => `${d.name}: ${d.ms}`)
            .join(', ');
        this.uploadWaitMs = 0;
        this.downloadWaitMs = 0;
        return res;
    }
    makeTensorInfo(shape, dtype, values) {
        if (dtype === 'string' && values != null && values.length > 0 &&
            util.isString(values[0])) {
            values = values.map(d => util.encodeString(d));
        }
        const dataId = this.write(values, shape, dtype);
        return { dataId, shape, dtype };
    }
    tensorToBinding(tensor) {
        if (!tensor) {
            return null;
        }
        const tensorData = this.tensorMap.get(tensor.dataId);
        if ('texture' in tensorData.resourceInfo) {
            const info = tensorData.resourceInfo;
            if (info.texture instanceof GPUExternalTexture) {
                return info.texture;
            }
            else {
                return info.texture.createView();
            }
        }
        const bufferInfo = tensorData.resourceInfo;
        return { offset: 0, size: bufferInfo.size, buffer: bufferInfo.buffer };
    }
    async getQueryTime(query) {
        if (this.supportTimeQuery) {
            return this.getTimeFromQuerySet(query);
        }
        else {
            return 0;
        }
    }
    uploadToGPU(dataId) {
        const tensorData = this.tensorMap.get(dataId);
        // Already on the GPU.
        if (tensorData.resourceInfo) {
            return;
        }
        const size = webgpu_util.GPUBytesPerElement(tensorData.dtype) *
            util.sizeFromShape(tensorData.shape);
        const buffer = this.bufferManager.acquireBuffer(size, this.defaultGpuBufferUsage());
        tensorData
            .resourceInfo = { size, usage: this.defaultGpuBufferUsage(), buffer };
        if (tensorData.values) {
            const stagingBuffer = this.bufferManager.acquireUploadBuffer(size, GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC);
            const arrayBuffer = stagingBuffer.getMappedRange();
            if (tensorData.dtype === 'int32' || tensorData.dtype === 'bool') {
                new Int32Array(arrayBuffer).set(tensorData.values);
            }
            else {
                new Float32Array(arrayBuffer).set(tensorData.values);
            }
            stagingBuffer.unmap();
            this.ensureCommandEncoderReady();
            this.ensureComputePassEnded();
            this.currentCommandEncoder.copyBufferToBuffer(stagingBuffer, 0, buffer, 0, size);
            const stagingInfo = {
                size,
                usage: GPUBufferUsage.MAP_WRITE | GPUBufferUsage.COPY_SRC,
                buffer: stagingBuffer
            };
            this.stagingPendingDisposal.push(stagingInfo);
            // TODO: WebGPU doesn't support read data synchronously from GPU to CPU.
            // So it will report error when switching backend from WebGPU to others.
            // There are two situations: 1) swithcing the backend after running a
            // model; 2) swithcing the backend within the model. Temporarilly keep the
            // values on CPU to solve the first issue.
            // tensorData.values = null;
        }
    }
    makeUniforms(programUniform) {
        let currentOffset = 0;
        let preLength = 0;
        const offsets = [];
        programUniform.forEach((d) => {
            if (d.data.length === 0) {
                d.data = [1];
            }
            // https://www.w3.org/TR/WGSL/#alignof
            let baseAlignment;
            switch (d.data.length) {
                case 1:
                    baseAlignment = 4;
                    break;
                case 2:
                    baseAlignment = 8;
                    break;
                case 3:
                    baseAlignment = 16;
                    break;
                case 4:
                    baseAlignment = 16;
                    break;
                case 5:
                    baseAlignment = 16;
                    break;
                case 6:
                    baseAlignment = 16;
                    break;
                default:
                    util.assert(false, () => `Unsupported ${d.data.length}D shape`);
            }
            if (preLength === 5 || preLength === 6) {
                baseAlignment = 16;
            }
            currentOffset = Math.ceil(currentOffset / baseAlignment) * baseAlignment;
            preLength = d.data.length;
            offsets.push(currentOffset);
            currentOffset += d.data.length * 4;
        });
        const arrayBuffer = new ArrayBuffer(currentOffset);
        programUniform.forEach((d, i) => {
            const offset = offsets[i];
            if (d.type === 'int32') {
                new Int32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
            else if (d.type === 'uint32') {
                new Uint32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
            else {
                new Float32Array(arrayBuffer, offset, d.data.length).set(d.data);
            }
        });
        const uniformBuffer = this.bufferManager.acquireBuffer(currentOffset, GPUBufferUsage.COPY_DST | GPUBufferUsage.UNIFORM);
        this.queue.writeBuffer(uniformBuffer, 0, arrayBuffer, 0, currentOffset);
        const uniformInfo = {
            size: currentOffset,
            usage: GPUBufferUsage.COPY_DST | GPUBufferUsage.UNIFORM,
            buffer: uniformBuffer
        };
        this.uniformPendingDisposal.push(uniformInfo);
        return { offset: 0, size: currentOffset, buffer: uniformBuffer };
    }
    runWebGPUProgram(program, inputs, outputDtype, programDefinedUniform, output) {
        if (!output) {
            output = this.makeTensorInfo(program.outputShape, outputDtype);
        }
        if (util.sizeFromShape(output.shape) === 0) {
            // Short-circuit the computation since the result is empty (has 0 in its
            // shape).
            this.tensorMap.get(output.dataId).values =
                util.getTypedArrayFromDType(output.dtype, 0);
            return output;
        }
        this.uploadToGPU(output.dataId);
        program.dispatch = reshapeDispatch(this.device, program);
        // There are five kinds of uniforms: NAN, shapes, shape strides, program
        // size, program defined uniforms.
        let programUniform = [];
        let bufferShapes = [];
        if (!program.isFromPixels) {
            programUniform.push({ type: 'float32', data: [NaN] });
            bufferShapes = inputs.concat(output).map(d => d.shape);
            const uniformsType = 'int32';
            bufferShapes.map(d => {
                programUniform.push({ type: uniformsType, data: d });
            });
            const strides = util.computeStrides(output.shape);
            programUniform.push({ type: uniformsType, data: strides });
            if (program.size) {
                const size = util.sizeFromShape(program.outputShape);
                programUniform.push({ type: uniformsType, data: [program.isVec4 ? size / 4 : size] });
            }
        }
        const inputsData = inputs.map((input, i) => {
            if (input.dtype === 'complex64') {
                throw new Error(`GPGPUProgram does not support complex64 input. For complex64 ` +
                    `dtypes, please separate the program into real and imaginary ` +
                    `parts.`);
            }
            this.uploadToGPU(input.dataId);
            return {
                // Returning dtype from tensorMap because it reflects dtype
                // of underlying buffer, rather than abstract dtype.
                dtype: this.tensorMap.get(input.dataId).dtype,
                shape: input.shape,
                name: program.variableNames[i]
            };
        });
        const key = webgpu_program.makeShaderKey(program, bufferShapes, inputsData, output);
        let pipeline;
        if (key in this.pipelineCache) {
            pipeline = this.pipelineCache[key];
        }
        else {
            pipeline = webgpu_program.compileProgram(this.device, program, inputsData, output);
            this.pipelineCache[key] = pipeline;
        }
        if (programDefinedUniform) {
            programUniform = [...programUniform, ...programDefinedUniform];
        }
        const bindings = [
            this.tensorToBinding(output), ...inputs.map(t => this.tensorToBinding(t)),
            this.makeUniforms(programUniform)
        ];
        const bindGroup = this.device.createBindGroup({
            layout: pipeline.getBindGroupLayout(0),
            entries: bindings.map((b, i) => ({ binding: i, resource: b })),
        });
        this.ensureCommandEncoderReady();
        const pass = this.getComputePass();
        const shouldTimeProgram = this.activeTimers != null;
        if (shouldTimeProgram) {
            if (this.supportTimeQuery) {
                // tslint:disable-next-line:no-any
                pass.writeTimestamp(this.querySet, 0);
            }
        }
        pass.setPipeline(pipeline);
        pass.setBindGroup(0, bindGroup);
        pass.dispatchWorkgroups(program.dispatch[0], program.dispatch[1], program.dispatch[2]);
        if (shouldTimeProgram) {
            if (this.supportTimeQuery) {
                // tslint:disable-next-line:no-any
                pass.writeTimestamp(this.querySet, 1);
            }
        }
        this.dispatchNumberInEncoder++;
        inputs.forEach(input => {
            this.commandQueueOwnedIds.add(input.dataId);
        });
        this.commandQueueOwnedIds.add(output.dataId);
        if (env().get('WEBGPU_DEFERRED_SUBMIT_BATCH_SIZE') <= this.dispatchNumberInEncoder) {
            this.submitQueue();
        }
        if (shouldTimeProgram) {
            this.activeTimers.push({
                name: program.constructor.name,
                query: this.getQueryTime(this.querySet)
            });
        }
        return output;
    }
    async getTimeFromQuerySet(querySet) {
        const queryBuffer = this.bufferManager.acquireBuffer(16, GPUBufferUsage.COPY_SRC | GPUBufferUsage.QUERY_RESOLVE);
        const dst = this.bufferManager.acquireBuffer(16, GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST);
        this.ensureCommandEncoderReady();
        this.ensureComputePassEnded();
        this.currentCommandEncoder.resolveQuerySet(querySet, 0, 2, queryBuffer, 0);
        this.currentCommandEncoder.copyBufferToBuffer(queryBuffer, 0, dst, 0, 16);
        this.submitQueue();
        await dst.mapAsync(GPUMapMode.READ);
        const arrayBuf = new BigUint64Array(dst.getMappedRange());
        const timeElapsedNanos = Number((arrayBuf[1] - arrayBuf[0]));
        dst.unmap();
        this.bufferManager.releaseBuffer(dst, 16, GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST);
        this.bufferManager.releaseBuffer(queryBuffer, 16, GPUBufferUsage.COPY_SRC | GPUBufferUsage.QUERY_RESOLVE);
        // Return milliseconds.
        return timeElapsedNanos / 1000000;
    }
    shouldExecuteOnCPU(inputs, sizeThreshold = CPU_HANDOFF_SIZE_THRESHOLD) {
        return env().getBool('WEBGPU_CPU_FORWARD') &&
            inputs.every(input => this.tensorMap.get(input.dataId).resourceInfo == null &&
                util.sizeFromShape(input.shape) < sizeThreshold);
    }
    numDataIds() {
        return this.tensorMap.numDataIds() - this.tensorDataPendingDisposal.length;
    }
    dispose() {
        if (this.disposed) {
            return;
        }
        this.bufferManager.dispose();
        this.textureManager.dispose();
        this.disposed = true;
    }
}
WebGPUBackend.nextDataId = 0;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2VuZF93ZWJncHUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi90ZmpzLWJhY2tlbmQtd2ViZ3B1L3NyYy9iYWNrZW5kX3dlYmdwdS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFFSCxPQUFPLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBWSxNQUFNLEVBQUUsR0FBRyxFQUFXLGFBQWEsRUFBb0YsSUFBSSxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFFL00sT0FBTyxFQUFDLFdBQVcsRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDL0MsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ2pELE9BQU8sS0FBSyxjQUFjLE1BQU0sa0JBQWtCLENBQUM7QUFDbkQsT0FBTyxLQUFLLFdBQVcsTUFBTSxlQUFlLENBQUM7QUFpRDdDLCtFQUErRTtBQUMvRSw0QkFBNEI7QUFDNUIsTUFBTSwwQkFBMEIsR0FDNUIsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7QUFFekQsaURBQWlEO0FBQ2pELE1BQU0sZUFBZSxHQUNqQixDQUFDLE1BQWlCLEVBQ2pCLE9BQXFDLEVBQTRCLEVBQUU7SUFDbEUsTUFBTSx1Q0FBdUMsR0FDekMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxnQ0FBZ0MsQ0FBQztJQUNuRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUN6QyxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckMsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksdUNBQXVDLENBQUMsRUFBRTtR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QztRQUM3QixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO0lBQ3ZCLENBQUM7O0FBN3RCYyx3QkFBVSxHQUFHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGxpY2Vuc2VcbiAqIENvcHlyaWdodCAyMDE5IEdvb2dsZSBMTEMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gKi9cblxuaW1wb3J0ICcuL2ZsYWdzX3dlYmdwdSc7XG5cbmltcG9ydCB7YmFja2VuZF91dGlsLCBidWZmZXIsIERhdGFTdG9yYWdlLCBEYXRhVHlwZSwgZW5naW5lLCBlbnYsIEdQVURhdGEsIEtlcm5lbEJhY2tlbmQsIFJhbmssIFJlY3Vyc2l2ZUFycmF5LCBTaGFwZU1hcCwgVGVuc29yQnVmZmVyLCBUZW5zb3JJbmZvLCBUaW1pbmdJbmZvLCBUeXBlZEFycmF5LCB1dGlsfSBmcm9tICdAdGVuc29yZmxvdy90ZmpzLWNvcmUnO1xuXG5pbXBvcnQge0FkYXB0ZXJJbmZvLCBHUFVBZGFwdGVySW5mb30gZnJvbSAnLi9hZGFwdGVyX2luZm8nO1xuaW1wb3J0IHtCdWZmZXJNYW5hZ2VyfSBmcm9tICcuL2J1ZmZlcl9tYW5hZ2VyJztcbmltcG9ydCB7VGV4dHVyZU1hbmFnZXJ9IGZyb20gJy4vdGV4dHVyZV9tYW5hZ2VyJztcbmltcG9ydCAqIGFzIHdlYmdwdV9wcm9ncmFtIGZyb20gJy4vd2ViZ3B1X3Byb2dyYW0nO1xuaW1wb3J0ICogYXMgd2ViZ3B1X3V0aWwgZnJvbSAnLi93ZWJncHVfdXRpbCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViR1BVTWVtb3J5SW5mbyBleHRlbmRzIGJhY2tlbmRfdXRpbC5NZW1vcnlJbmZvIHtcbiAgbnVtQnl0ZXNJbkdQVTogbnVtYmVyO1xuICBudW1CeXRlc0FsbG9jYXRlZEluR1BVOiBudW1iZXI7XG4gIHVucmVsaWFibGU6IGJvb2xlYW47XG59XG5cbmV4cG9ydCB0eXBlIEJ1ZmZlckluZm8gPSB7XG4gIHNpemU6IG51bWJlcixcbiAgdXNhZ2U6IEdQVUJ1ZmZlclVzYWdlRmxhZ3MsXG4gIGJ1ZmZlcjogR1BVQnVmZmVyXG59O1xuXG5leHBvcnQgdHlwZSBUZXh0dXJlSW5mbyA9IHtcbiAgd2lkdGg6IG51bWJlcixcbiAgaGVpZ2h0OiBudW1iZXIsXG4gIGZvcm1hdDogR1BVVGV4dHVyZUZvcm1hdCxcbiAgdXNhZ2U6IEdQVVRleHR1cmVVc2FnZUZsYWdzLFxuICB0ZXh0dXJlOiBHUFVUZXh0dXJlfEdQVUV4dGVybmFsVGV4dHVyZVxufTtcblxudHlwZSBUZW5zb3JEYXRhID0ge1xuICB2YWx1ZXM6IGJhY2tlbmRfdXRpbC5CYWNrZW5kVmFsdWVzLFxuICBkdHlwZTogRGF0YVR5cGUsXG4gIHNoYXBlOiBudW1iZXJbXSxcbiAgcmVmQ291bnQ6IG51bWJlcixcbiAgcmVzb3VyY2VJbmZvPzogQnVmZmVySW5mb3xUZXh0dXJlSW5mbyxcbiAgLy8gRm9yIGNvbXBsZXggbnVtYmVycywgdGhlIHJlYWwgYW5kIGltYWdpbmFyeSBwYXJ0cyBhcmUgc3RvcmVkIGFzIHRoZWlyIG93blxuICAvLyBpbmRpdmlkdWFsIHRlbnNvcnMsIHdpdGggYSBwYXJlbnQgam9pbmluZyB0aGUgdHdvIHdpdGggdGhlXG4gIC8vIGNvbXBsZXhUZW5zb3JJbmZvcyBmaWVsZC5cbiAgY29tcGxleFRlbnNvckluZm9zPzoge3JlYWw6IFRlbnNvckluZm8sIGltYWc6IFRlbnNvckluZm99XG59O1xuXG5pbnRlcmZhY2UgRGF0YUlkIHt9XG5cbmV4cG9ydCB0eXBlIFdlYkdQVUtlcm5lbEluZm8gPSB7XG4gIG5hbWU6IHN0cmluZzsgcXVlcnk6IFByb21pc2U8bnVtYmVyPjtcbn07XG5cbmV4cG9ydCB0eXBlIFRpbWVyTm9kZSA9IFJlY3Vyc2l2ZUFycmF5PFdlYkdQVUtlcm5lbEluZm8+fFdlYkdQVUtlcm5lbEluZm87XG5cbmV4cG9ydCBpbnRlcmZhY2UgV2ViR1BVVGltaW5nSW5mbyBleHRlbmRzIFRpbWluZ0luZm8ge1xuICB1cGxvYWRXYWl0TXM6IG51bWJlcjtcbiAgZG93bmxvYWRXYWl0TXM6IG51bWJlcjtcbn1cblxudHlwZSBQcm9ncmFtVW5pZm9ybSA9IEFycmF5PHt0eXBlOiBzdHJpbmc7IGRhdGE6IG51bWJlcltdfT47XG5cbi8vIEVtcGlyaWNhbGx5IGRldGVybWluZWQgY29uc3RhbnQgdXNlZCB0byBkZXRlcm1pbmUgc2l6ZSB0aHJlc2hvbGQgZm9yIGhhbmRpbmdcbi8vIG9mZiBleGVjdXRpb24gdG8gdGhlIENQVS5cbmNvbnN0IENQVV9IQU5ET0ZGX1NJWkVfVEhSRVNIT0xEID1cbiAgICBlbnYoKS5nZXROdW1iZXIoJ1dFQkdQVV9DUFVfSEFORE9GRl9TSVpFX1RIUkVTSE9MRCcpO1xuXG4vLyBSZXNoYXBlIGRpc3BhdGNoLCBub3QgdG8gZXhjZWVkIGRldmljZSBsaW1pdHMuXG5jb25zdCByZXNoYXBlRGlzcGF0Y2ggPVxuICAgIChkZXZpY2U6IEdQVURldmljZSxcbiAgICAgcHJvZ3JhbTogd2ViZ3B1X3Byb2dyYW0uV2ViR1BVUHJvZ3JhbSk6IFtudW1iZXIsIG51bWJlciwgbnVtYmVyXSA9PiB7XG4gICAgICBjb25zdCBNQVhfQ09NUFVURV9QRVJfRElNRU5TSU9OX0RJU1BBVENIX1NJWkUgPVxuICAgICAgICAgIGRldmljZS5saW1pdHMubWF4Q29tcHV0ZVdvcmtncm91cHNQZXJEaW1lbnNpb247XG4gICAgICBjb25zdCBsYXlvdXQgPSBwcm9ncmFtWydkaXNwYXRjaExheW91dCddO1xuICAgICAgY29uc3QgZGlzcGF0Y2ggPSBwcm9ncmFtWydkaXNwYXRjaCddO1xuICAgICAgaWYgKGRpc3BhdGNoLmV2ZXJ5KChkKSA9PiBkIDw9IE1BWF9DT01QVVRFX1BFUl9ESU1FTlNJT05fRElTUEFUQ0hfU0laRSkpIHtcbiAgICAgICAgcmV0dXJuIGRpc3BhdGNoO1xuICAgICAgfVxuXG4gICAgICB1dGlsLmFzc2VydChcbiAgICAgICAgICBkaXNwYXRjaFswXSA+IE1BWF9DT01QVVRFX1BFUl9ESU1FTlNJT05fRElTUEFUQ0hfU0laRSAmJlxuICAgICAgICAgICAgICBsYXlvdXQueSA9PT0gdW5kZWZpbmVkICYmIGxheW91dC56ID09PSB1bmRlZmluZWQsXG4gICAgICAgICAgKCkgPT4gJ0Rpc3BhdGNoIHNpemUgZXhjZWVkcyBXZWJHUFUgbGltaXRzIGluIFkgb3IgWiBkaW1lbnNpb24uJyk7XG5cbiAgICAgIGxldCBkaXNwYXRjaEF2ZXJhZ2UgPSBNYXRoLmNlaWwoTWF0aC5zcXJ0KGRpc3BhdGNoWzBdKSk7XG4gICAgICBpZiAoZGlzcGF0Y2hBdmVyYWdlID4gTUFYX0NPTVBVVEVfUEVSX0RJTUVOU0lPTl9ESVNQQVRDSF9TSVpFKSB7XG4gICAgICAgIGRpc3BhdGNoQXZlcmFnZSA9IE1hdGguY2VpbChNYXRoLmNicnQoZGlzcGF0Y2hbMF0pKTtcbiAgICAgICAgdXRpbC5hc3NlcnQoXG4gICAgICAgICAgICBkaXNwYXRjaEF2ZXJhZ2UgPD0gTUFYX0NPTVBVVEVfUEVSX0RJTUVOU0lPTl9ESVNQQVRDSF9TSVpFLFxuICAgICAgICAgICAgKCkgPT4gJ1RvdGFsIGRpc3BhdGNoIHNpemUgZXhjZWVkcyBXZWJHUFUgbWF4aW11bS4nKTtcbiAgICAgICAgcmV0dXJuIFtkaXNwYXRjaEF2ZXJhZ2UsIGRpc3BhdGNoQXZlcmFnZSwgZGlzcGF0Y2hBdmVyYWdlXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBbZGlzcGF0Y2hBdmVyYWdlLCBkaXNwYXRjaEF2ZXJhZ2UsIDFdO1xuICAgICAgfVxuICAgIH07XG5cbmV4cG9ydCBjbGFzcyBXZWJHUFVCYWNrZW5kIGV4dGVuZHMgS2VybmVsQmFja2VuZCB7XG4gIGJ1ZmZlck1hbmFnZXI6IEJ1ZmZlck1hbmFnZXI7XG4gIGFkYXB0ZXJJbmZvOiBBZGFwdGVySW5mbztcbiAgZGV2aWNlOiBHUFVEZXZpY2U7XG4gIHF1ZXVlOiBHUFVRdWV1ZTtcbiAgdGVuc29yTWFwOiBEYXRhU3RvcmFnZTxUZW5zb3JEYXRhPjtcbiAgdGV4dHVyZU1hbmFnZXI6IFRleHR1cmVNYW5hZ2VyO1xuXG4gIHByaXZhdGUgYWN0aXZlVGltZXJzOiBUaW1lck5vZGVbXTtcbiAgcHJpdmF0ZSBjdXJyZW50Q29tbWFuZEVuY29kZXI6IEdQVUNvbW1hbmRFbmNvZGVyO1xuICBwcml2YXRlIGN1cnJlbnRDb21wdXRlUGFzczogR1BVQ29tcHV0ZVBhc3NFbmNvZGVyO1xuICBwcml2YXRlIGNvbW1hbmRRdWV1ZU93bmVkSWRzID0gbmV3IFdlYWtTZXQ8RGF0YUlkPigpO1xuICBwcml2YXRlIGRpc3BhdGNoTnVtYmVySW5FbmNvZGVyID0gMDtcbiAgcHJpdmF0ZSBkaXNwb3NlZCA9IGZhbHNlO1xuICBwcml2YXRlIGRvd25sb2FkV2FpdE1zID0gMDtcbiAgcHJpdmF0ZSBkdW1teUNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQ7XG4gIHByaXZhdGUgZHVtbXlDb250ZXh0OiBHUFVDYW52YXNDb250ZXh0O1xuICBwcml2YXRlIHRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWw6IERhdGFJZFtdID0gW107XG4gIHByaXZhdGUgc3RhdGljIG5leHREYXRhSWQgPSAwO1xuICBwcml2YXRlIHBpcGVsaW5lQ2FjaGU6IHtba2V5OiBzdHJpbmddOiBHUFVDb21wdXRlUGlwZWxpbmV9O1xuICBwcml2YXRlIHByb2dyYW1UaW1lcnNTdGFjazogVGltZXJOb2RlW107XG4gIHByaXZhdGUgcXVlcnlTZXQ6IEdQVVF1ZXJ5U2V0O1xuICBwcml2YXRlIHN0YWdpbmdQZW5kaW5nRGlzcG9zYWw6IEJ1ZmZlckluZm9bXSA9IFtdO1xuICBwcml2YXRlIHN1cHBvcnRUaW1lUXVlcnk6IGJvb2xlYW47XG4gIHByaXZhdGUgdW5pZm9ybVBlbmRpbmdEaXNwb3NhbDogQnVmZmVySW5mb1tdID0gW107XG4gIHByaXZhdGUgdXBsb2FkV2FpdE1zID0gMDtcblxuICBwcml2YXRlIG5leHREYXRhSWQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gV2ViR1BVQmFja2VuZC5uZXh0RGF0YUlkKys7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihkZXZpY2U6IEdQVURldmljZSwgYWRhcHRlckluZm8/OiBHUFVBZGFwdGVySW5mbykge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKCF3ZWJncHVfdXRpbC5pc1dlYkdQVVN1cHBvcnRlZCgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1dlYkdQVSBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoaXMgZGV2aWNlJyk7XG4gICAgfVxuICAgIHRoaXMucGlwZWxpbmVDYWNoZSA9IHt9O1xuICAgIHRoaXMuZGV2aWNlID0gZGV2aWNlO1xuICAgIHRoaXMucXVldWUgPSBkZXZpY2UucXVldWU7XG4gICAgdGhpcy5jdXJyZW50Q29tbWFuZEVuY29kZXIgPSBudWxsO1xuICAgIHRoaXMuY3VycmVudENvbXB1dGVQYXNzID0gbnVsbDtcbiAgICB0aGlzLnN1cHBvcnRUaW1lUXVlcnkgPSBkZXZpY2UuZmVhdHVyZXMuaGFzKCd0aW1lc3RhbXAtcXVlcnknKTtcbiAgICB0aGlzLmFkYXB0ZXJJbmZvID0gbmV3IEFkYXB0ZXJJbmZvKGFkYXB0ZXJJbmZvKTtcblxuICAgIHRoaXMuYnVmZmVyTWFuYWdlciA9IG5ldyBCdWZmZXJNYW5hZ2VyKHRoaXMuZGV2aWNlKTtcbiAgICB0aGlzLnRleHR1cmVNYW5hZ2VyID0gbmV3IFRleHR1cmVNYW5hZ2VyKHRoaXMuZGV2aWNlKTtcbiAgICB0aGlzLnRlbnNvck1hcCA9IG5ldyBEYXRhU3RvcmFnZSh0aGlzLCBlbmdpbmUoKSk7XG4gICAgaWYgKHRoaXMuc3VwcG9ydFRpbWVRdWVyeSkge1xuICAgICAgdGhpcy5xdWVyeVNldCA9IHRoaXMuZGV2aWNlLmNyZWF0ZVF1ZXJ5U2V0KHtcbiAgICAgICAgdHlwZTogJ3RpbWVzdGFtcCcsXG4gICAgICAgIGNvdW50OiAyLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gUHJvZmlsaW5nIHRvb2xzIGxpa2UgUElYIG5lZWRzIHRoaXMgZHVtbXkgY2FudmFzIHRvXG4gICAgLy8gdHJpZ2dlciBjYXB0dXJpbmcgYSBmcmFtZS5cbiAgICBpZiAoZW52KCkuZ2V0Qm9vbCgnV0VCR1BVX1VTRV9QUk9GSUxFX1RPT0wnKSkge1xuICAgICAgdGhpcy5kdW1teUNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgdGhpcy5kdW1teUNhbnZhcy53aWR0aCA9IDE7XG4gICAgICB0aGlzLmR1bW15Q2FudmFzLmhlaWdodCA9IDE7XG5cbiAgICAgIHRoaXMuZHVtbXlDb250ZXh0ID0gdGhpcy5kdW1teUNhbnZhcy5nZXRDb250ZXh0KCd3ZWJncHUnKTtcbiAgICAgIHRoaXMuZHVtbXlDb250ZXh0LmNvbmZpZ3VyZSh7XG4gICAgICAgIGRldmljZSxcbiAgICAgICAgZm9ybWF0OiAnYmdyYTh1bm9ybScsXG4gICAgICB9KTtcblxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmR1bW15Q2FudmFzKTtcbiAgICB9XG4gIH1cblxuICBmbG9hdFByZWNpc2lvbigpOiAzMiB7XG4gICAgcmV0dXJuIDMyO1xuICB9XG5cbiAgZGVmYXVsdEdwdUJ1ZmZlclVzYWdlKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIEdQVUJ1ZmZlclVzYWdlLlNUT1JBR0UgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyB8XG4gICAgICAgIEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUO1xuICB9XG5cbiAgLyoqXG4gICAqIERpc3Bvc2UgdGhlIG1lbW9yeSBpZiB0aGUgZGF0YUlkIGhhcyAwIHJlZkNvdW50LiBSZXR1cm4gdHJ1ZSBpZiB0aGUgbWVtb3J5XG4gICAqIGlzIHJlbGVhc2VkIG9yIG1lbW9yeSBpcyBub3QgbWFuYWdlZCBpbiB0aGlzIGJhY2tlbmQsIGZhbHNlIGlmIG1lbW9yeSBpc1xuICAgKiBub3QgY2xlYXJlZC5cbiAgICogQHBhcmFtIGRhdGFJZFxuICAgKiBAb2FyYW0gZm9yY2UgT3B0aW9uYWwsIHJlbW92ZSB0aGUgZGF0YSByZWdhcmRsZXNzIG9mIHJlZkNvdW50XG4gICAqL1xuICBkaXNwb3NlRGF0YShkYXRhSWQ6IERhdGFJZCwgZm9yY2UgPSBmYWxzZSk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwuaW5kZXhPZihkYXRhSWQpID49IDApIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnRlbnNvck1hcC5oYXMoZGF0YUlkKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIHRoaXMuZGVjUmVmKGRhdGFJZCk7XG4gICAgaWYgKCFmb3JjZSAmJiB0ZW5zb3JEYXRhLnJlZkNvdW50ID4gMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIGNvbXBsZXggaXMgbmV2ZXIgaW4gY29tbWFuZFF1ZXVlT3duZWRJZHNcbiAgICBpZiAodGhpcy5jb21tYW5kUXVldWVPd25lZElkcy5oYXMoZGF0YUlkKSkge1xuICAgICAgdGhpcy50ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsLnB1c2goZGF0YUlkKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCB7Y29tcGxleFRlbnNvckluZm9zfSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIGlmIChjb21wbGV4VGVuc29ySW5mb3MgIT0gbnVsbCkge1xuICAgICAgdGhpcy5kaXNwb3NlRGF0YShjb21wbGV4VGVuc29ySW5mb3MucmVhbC5kYXRhSWQsIGZvcmNlKTtcbiAgICAgIHRoaXMuZGlzcG9zZURhdGEoY29tcGxleFRlbnNvckluZm9zLmltYWcuZGF0YUlkLCBmb3JjZSk7XG4gICAgfVxuXG4gICAgdGhpcy5yZWxlYXNlUmVzb3VyY2UoZGF0YUlkKTtcbiAgICB0aGlzLnRlbnNvck1hcC5kZWxldGUoZGF0YUlkKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgbWVtb3J5KCk6IFdlYkdQVU1lbW9yeUluZm8ge1xuICAgIHJldHVybiB7XG4gICAgICBudW1CeXRlc0luR1BVOiB0aGlzLmJ1ZmZlck1hbmFnZXIubnVtQnl0ZXNVc2VkLFxuICAgICAgbnVtQnl0ZXNBbGxvY2F0ZWRJbkdQVTogdGhpcy5idWZmZXJNYW5hZ2VyLm51bUJ5dGVzQWxsb2NhdGVkLFxuICAgICAgdW5yZWxpYWJsZTogZmFsc2VcbiAgICB9IGFzIFdlYkdQVU1lbW9yeUluZm87XG4gIH1cblxuICByZWxlYXNlUmVzb3VyY2UoZGF0YUlkOiBEYXRhSWQpIHtcbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgaWYgKCF0ZW5zb3JEYXRhIHx8ICF0ZW5zb3JEYXRhLnJlc291cmNlSW5mbykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoJ3RleHR1cmUnIGluIHRlbnNvckRhdGEucmVzb3VyY2VJbmZvKSB7XG4gICAgICBjb25zdCB0ZXh0dXJlSW5mbyA9IHRlbnNvckRhdGEucmVzb3VyY2VJbmZvO1xuICAgICAgaWYgKHRleHR1cmVJbmZvLnRleHR1cmUgaW5zdGFuY2VvZiBHUFVUZXh0dXJlKSB7XG4gICAgICAgIHRoaXMudGV4dHVyZU1hbmFnZXIucmVsZWFzZVRleHR1cmUoXG4gICAgICAgICAgICB0ZXh0dXJlSW5mby50ZXh0dXJlLCB0ZXh0dXJlSW5mby53aWR0aCwgdGV4dHVyZUluZm8uaGVpZ2h0LFxuICAgICAgICAgICAgdGV4dHVyZUluZm8uZm9ybWF0LCB0ZXh0dXJlSW5mby51c2FnZSk7XG4gICAgICB9XG4gICAgICB0ZXh0dXJlSW5mby50ZXh0dXJlID0gbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYnVmZmVySW5mbyA9IHRlbnNvckRhdGEucmVzb3VyY2VJbmZvO1xuICAgICAgdGhpcy5idWZmZXJNYW5hZ2VyLnJlbGVhc2VCdWZmZXIoXG4gICAgICAgICAgYnVmZmVySW5mby5idWZmZXIsIGJ1ZmZlckluZm8uc2l6ZSwgYnVmZmVySW5mby51c2FnZSk7XG4gICAgICBidWZmZXJJbmZvLmJ1ZmZlciA9IG51bGw7XG4gICAgfVxuICAgIHRlbnNvckRhdGEucmVzb3VyY2VJbmZvID0gbnVsbDtcbiAgfVxuXG4gIC8qKiBSZXR1cm4gcmVmQ291bnQgb2YgYSBgVGVuc29yRGF0YWAuICovXG4gIHJlZkNvdW50KGRhdGFJZDogRGF0YUlkKTogbnVtYmVyIHtcbiAgICBpZiAodGhpcy50ZW5zb3JNYXAuaGFzKGRhdGFJZCkpIHtcbiAgICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICAgIHJldHVybiB0ZW5zb3JEYXRhLnJlZkNvdW50O1xuICAgIH1cbiAgICByZXR1cm4gMDtcbiAgfVxuXG4gIC8qKiBJbmNyZWFzZSByZWZDb3VudCBvZiBhIGBUZW5zb3JEYXRhYC4gKi9cbiAgaW5jUmVmKGRhdGFJZDogRGF0YUlkKTogdm9pZCB7XG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIHRlbnNvckRhdGEucmVmQ291bnQrKztcbiAgfVxuXG4gIC8qKiBEZWNyZWFzZSByZWZDb3VudCBvZiBhIGBUZW5zb3JEYXRhYC4gKi9cbiAgZGVjUmVmKGRhdGFJZDogRGF0YUlkKTogdm9pZCB7XG4gICAgaWYgKHRoaXMudGVuc29yTWFwLmhhcyhkYXRhSWQpKSB7XG4gICAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG4gICAgICB0ZW5zb3JEYXRhLnJlZkNvdW50LS07XG4gICAgfVxuICB9XG5cbiAgd3JpdGUodmFsdWVzOiBiYWNrZW5kX3V0aWwuQmFja2VuZFZhbHVlcywgc2hhcGU6IG51bWJlcltdLCBkdHlwZTogRGF0YVR5cGUpOlxuICAgICAgRGF0YUlkIHtcbiAgICBpZiAoZHR5cGUgPT09ICdjb21wbGV4NjQnICYmIHZhbHVlcyAhPSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYENhbm5vdCB3cml0ZSB0byBhIGNvbXBsZXg2NCBkdHlwZS4gYCArXG4gICAgICAgICAgYFBsZWFzZSB1c2UgdGYuY29tcGxleChyZWFsLCBpbWFnKS5gKTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkID0ge2lkOiB0aGlzLm5leHREYXRhSWQoKX07XG4gICAgdGhpcy50ZW5zb3JNYXAuc2V0KGRhdGFJZCwge2R0eXBlLCBzaGFwZSwgdmFsdWVzLCByZWZDb3VudDogMX0pO1xuICAgIHJldHVybiBkYXRhSWQ7XG4gIH1cblxuICBtb3ZlKFxuICAgICAgZGF0YUlkOiBEYXRhSWQsIHZhbHVlczogYmFja2VuZF91dGlsLkJhY2tlbmRWYWx1ZXMsIHNoYXBlOiBudW1iZXJbXSxcbiAgICAgIGR0eXBlOiBEYXRhVHlwZSwgcmVmQ291bnQ6IG51bWJlcik6IHZvaWQge1xuICAgIGlmIChkdHlwZSA9PT0gJ2NvbXBsZXg2NCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQ2Fubm90IHdyaXRlIHRvIGEgY29tcGxleDY0IGR0eXBlLiBgICtcbiAgICAgICAgICBgUGxlYXNlIHVzZSB0Zi5jb21wbGV4KHJlYWwsIGltYWcpLmApO1xuICAgIH1cbiAgICB0aGlzLnRlbnNvck1hcC5zZXQoZGF0YUlkLCB7ZHR5cGUsIHNoYXBlLCB2YWx1ZXMsIHJlZkNvdW50fSk7XG4gIH1cblxuICBzdWJtaXRRdWV1ZSgpIHtcbiAgICB0aGlzLmVuc3VyZUNvbXB1dGVQYXNzRW5kZWQoKTtcbiAgICB0aGlzLnF1ZXVlLnN1Ym1pdChbdGhpcy5jdXJyZW50Q29tbWFuZEVuY29kZXIuZmluaXNoKCldKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2RlciA9IG51bGw7XG4gICAgdGhpcy5kaXNwYXRjaE51bWJlckluRW5jb2RlciA9IDA7XG5cbiAgICB0aGlzLmNvbW1hbmRRdWV1ZU93bmVkSWRzID0gbmV3IFdlYWtTZXQ8RGF0YUlkPigpO1xuXG4gICAgdGhpcy50ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsLmZvckVhY2goZCA9PiB7XG4gICAgICB0aGlzLnJlbGVhc2VSZXNvdXJjZShkKTtcbiAgICAgIHRoaXMudGVuc29yTWFwLmRlbGV0ZShkKTtcbiAgICB9KTtcbiAgICB0aGlzLnVuaWZvcm1QZW5kaW5nRGlzcG9zYWwuZm9yRWFjaChcbiAgICAgICAgZCA9PiB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZUJ1ZmZlcihkLmJ1ZmZlciwgZC5zaXplLCBkLnVzYWdlKSk7XG4gICAgdGhpcy5zdGFnaW5nUGVuZGluZ0Rpc3Bvc2FsLmZvckVhY2goXG4gICAgICAgIGQgPT4gdGhpcy5idWZmZXJNYW5hZ2VyLnJlbGVhc2VVcGxvYWRCdWZmZXIoZC5idWZmZXIsIGQuc2l6ZSwgZC51c2FnZSkpO1xuXG4gICAgdGhpcy50ZW5zb3JEYXRhUGVuZGluZ0Rpc3Bvc2FsID0gW107XG4gICAgdGhpcy51bmlmb3JtUGVuZGluZ0Rpc3Bvc2FsID0gW107XG4gICAgdGhpcy5zdGFnaW5nUGVuZGluZ0Rpc3Bvc2FsID0gW107XG4gIH1cblxuICBlbnN1cmVDb21tYW5kRW5jb2RlclJlYWR5KCkge1xuICAgIGlmICghdGhpcy5jdXJyZW50Q29tbWFuZEVuY29kZXIpIHtcbiAgICAgIHRoaXMuY3VycmVudENvbW1hbmRFbmNvZGVyID0gdGhpcy5kZXZpY2UuY3JlYXRlQ29tbWFuZEVuY29kZXIoKTtcbiAgICB9XG4gIH1cblxuICBlbnN1cmVDb21wdXRlUGFzc0VuZGVkKCkge1xuICAgIGlmICh0aGlzLmN1cnJlbnRDb21wdXRlUGFzcykge1xuICAgICAgdGhpcy5jdXJyZW50Q29tcHV0ZVBhc3MuZW5kKCk7XG4gICAgICB0aGlzLmN1cnJlbnRDb21wdXRlUGFzcyA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgZ2V0Q29tcHV0ZVBhc3MoKSB7XG4gICAgaWYgKCF0aGlzLmN1cnJlbnRDb21wdXRlUGFzcykge1xuICAgICAgdGhpcy5jdXJyZW50Q29tcHV0ZVBhc3MgPSB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5iZWdpbkNvbXB1dGVQYXNzKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmN1cnJlbnRDb21wdXRlUGFzcztcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBnZXRCdWZmZXJEYXRhKGJ1ZmZlcjogR1BVQnVmZmVyLCBzaXplOiBudW1iZXIpOlxuICAgICAgUHJvbWlzZTxiYWNrZW5kX3V0aWwuQmFja2VuZFZhbHVlcz4ge1xuICAgIGNvbnN0IHN0YWdpbmcgPSB0aGlzLmJ1ZmZlck1hbmFnZXIuYWNxdWlyZUJ1ZmZlcihcbiAgICAgICAgc2l6ZSwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9EU1QgfCBHUFVCdWZmZXJVc2FnZS5NQVBfUkVBRCk7XG4gICAgdGhpcy5lbnN1cmVDb21tYW5kRW5jb2RlclJlYWR5KCk7XG4gICAgdGhpcy5lbnN1cmVDb21wdXRlUGFzc0VuZGVkKCk7XG4gICAgdGhpcy5jdXJyZW50Q29tbWFuZEVuY29kZXIuY29weUJ1ZmZlclRvQnVmZmVyKGJ1ZmZlciwgMCwgc3RhZ2luZywgMCwgc2l6ZSk7XG4gICAgdGhpcy5zdWJtaXRRdWV1ZSgpO1xuXG4gICAgYXdhaXQgc3RhZ2luZy5tYXBBc3luYyhHUFVNYXBNb2RlLlJFQUQpO1xuICAgIGNvbnN0IHZhbHVlcyA9IHN0YWdpbmcuZ2V0TWFwcGVkUmFuZ2UoKS5zbGljZSgwKTtcblxuICAgIHN0YWdpbmcudW5tYXAoKTtcbiAgICBpZiAoc3RhZ2luZyAhPSBudWxsKSB7XG4gICAgICB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZUJ1ZmZlcihcbiAgICAgICAgICBzdGFnaW5nLCBzaXplLCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCB8IEdQVUJ1ZmZlclVzYWdlLk1BUF9SRUFEKTtcbiAgICB9XG5cbiAgICAvLyBOZWVkIHRvIGdldCB0ZXh0dXJlIGZyb20gc3dhcENoYWluIHRvIGVuYWJsZSBwcm9maWxpbmcgdG9vbFxuICAgIC8vIHRvIGNhcHR1cmUgYSBmcmFtZVxuICAgIGlmIChlbnYoKS5nZXRCb29sKCdXRUJHUFVfVVNFX1BST0ZJTEVfVE9PTCcpKSB7XG4gICAgICB1dGlsLmFzc2VydChcbiAgICAgICAgICB0aGlzLmR1bW15Q29udGV4dCAhPT0gdW5kZWZpbmVkLFxuICAgICAgICAgICgpID0+IGBGYWlsIHRvIGdldCBjb250ZXh0IGZvciBwcm9maWxpbmcgdG9vbGApO1xuICAgICAgdGhpcy5kdW1teUNvbnRleHQuZ2V0Q3VycmVudFRleHR1cmUoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVzIGFzIGJhY2tlbmRfdXRpbC5CYWNrZW5kVmFsdWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0QW5kQ2FjaGVPbkNQVShkYXRhSWQ6IERhdGFJZCwgZGF0YTogYmFja2VuZF91dGlsLlR5cGVkQXJyYXkpOlxuICAgICAgYmFja2VuZF91dGlsLlR5cGVkQXJyYXkge1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICB0aGlzLnJlbGVhc2VSZXNvdXJjZShkYXRhSWQpO1xuICAgIHRlbnNvckRhdGEudmFsdWVzID0gZGF0YTtcbiAgICByZXR1cm4gdGVuc29yRGF0YS52YWx1ZXM7XG4gIH1cblxuICAvLyBUT0RPOiBSZW1vdmUgb25jZSB0aGlzIGlzIGZpeGVkOlxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vdGVuc29yZmxvdy90ZmpzL2lzc3Vlcy8xNTk1XG4gIHJlYWRTeW5jKGRhdGFJZDogb2JqZWN0KTogYmFja2VuZF91dGlsLkJhY2tlbmRWYWx1ZXMge1xuICAgIGNvbnN0IHRlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICBjb25zdCB7dmFsdWVzfSA9IHRlbnNvckRhdGE7XG5cbiAgICBpZiAodmFsdWVzID09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnV2ViR1BVIHJlYWRTeW5jIGlzIG9ubHkgYXZhaWxhYmxlIGZvciBDUFUtcmVzaWRlbnQgdGVuc29ycy4nKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWVzO1xuICB9XG5cbiAgYXN5bmMgcmVhZChkYXRhSWQ6IG9iamVjdCk6IFByb21pc2U8YmFja2VuZF91dGlsLkJhY2tlbmRWYWx1ZXM+IHtcbiAgICBpZiAoIXRoaXMudGVuc29yTWFwLmhhcyhkYXRhSWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbnNvciAke2RhdGFJZH0gd2FzIG5vdCByZWdpc3RlcmVkIWApO1xuICAgIH1cbiAgICBjb25zdCB0ZW5zb3JEYXRhID0gdGhpcy50ZW5zb3JNYXAuZ2V0KGRhdGFJZCk7XG5cbiAgICBjb25zdCB7dmFsdWVzfSA9IHRlbnNvckRhdGE7XG5cbiAgICBpZiAodmFsdWVzICE9IG51bGwpIHtcbiAgICAgIC8vIFRPRE8oeGluZy54dUBpbnRlbC5jb20pOiBNZXJnZSBiYWNrZW5kX3V0aWwuQmFja2VuZFZhbHVlcyBhbmRcbiAgICAgIC8vIGJhY2tlbmRfdXRpbC5UeXBlZEFycmF5LlxuICAgICAgcmV0dXJuIHRoaXMuY29udmVydEFuZENhY2hlT25DUFUoXG4gICAgICAgICAgICAgICAgIGRhdGFJZCwgdmFsdWVzIGFzIGJhY2tlbmRfdXRpbC5UeXBlZEFycmF5KSBhc1xuICAgICAgICAgIGJhY2tlbmRfdXRpbC5CYWNrZW5kVmFsdWVzO1xuICAgIH1cblxuICAgIC8vIERvd25sb2FkIHRoZSB2YWx1ZXMgZnJvbSB0aGUgR1BVLlxuICAgIGxldCB2YWxzOiBiYWNrZW5kX3V0aWwuQmFja2VuZFZhbHVlcztcbiAgICBpZiAodGVuc29yRGF0YS5kdHlwZSA9PT0gJ2NvbXBsZXg2NCcpIHtcbiAgICAgIGNvbnN0IHBzID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICB0aGlzLnJlYWQodGVuc29yRGF0YS5jb21wbGV4VGVuc29ySW5mb3MucmVhbC5kYXRhSWQpLFxuICAgICAgICB0aGlzLnJlYWQodGVuc29yRGF0YS5jb21wbGV4VGVuc29ySW5mb3MuaW1hZy5kYXRhSWQpXG4gICAgICBdKTtcblxuICAgICAgY29uc3QgcmVhbFZhbHVlcyA9IHBzWzBdO1xuICAgICAgY29uc3QgaW1hZ1ZhbHVlcyA9IHBzWzFdO1xuICAgICAgdmFscyA9IGJhY2tlbmRfdXRpbC5tZXJnZVJlYWxBbmRJbWFnQXJyYXlzKFxuICAgICAgICAgIHJlYWxWYWx1ZXMgYXMgRmxvYXQzMkFycmF5LCBpbWFnVmFsdWVzIGFzIEZsb2F0MzJBcnJheSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGJ1ZmZlckluZm8gPSB0ZW5zb3JEYXRhLnJlc291cmNlSW5mbyBhcyBCdWZmZXJJbmZvO1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0QnVmZmVyRGF0YShidWZmZXJJbmZvLmJ1ZmZlciwgYnVmZmVySW5mby5zaXplKTtcbiAgICAgIHZhbHMgPSB3ZWJncHVfdXRpbC5BcnJheUJ1ZmZlclRvVHlwZWRBcnJheShcbiAgICAgICAgICBkYXRhIGFzIEFycmF5QnVmZmVyLCB0ZW5zb3JEYXRhLmR0eXBlKTtcbiAgICB9XG4gICAgdGhpcy5jb252ZXJ0QW5kQ2FjaGVPbkNQVShkYXRhSWQsIHZhbHMpO1xuICAgIHJldHVybiB2YWxzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlYWQgdGVuc29yIHRvIGEgbmV3IEdQVUJ1ZmZlci5cbiAgICogQHBhcmFtIGRhdGFJZCBUaGUgc291cmNlIHRlbnNvci5cbiAgICovXG4gIHJlYWRUb0dQVShkYXRhSWQ6IERhdGFJZCk6IEdQVURhdGEge1xuICAgIGNvbnN0IHNyY1RlbnNvckRhdGEgPSB0aGlzLnRlbnNvck1hcC5nZXQoZGF0YUlkKTtcbiAgICBjb25zdCB7dmFsdWVzLCBkdHlwZSwgc2hhcGUsIHJlc291cmNlSW5mb30gPSBzcmNUZW5zb3JEYXRhO1xuXG4gICAgaWYgKGR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdEb2VzIG5vdCBzdXBwb3J0IHJlYWRpbmcgYnVmZmVyIGZvciBjb21wbGV4NjQgZHR5cGUuJyk7XG4gICAgfVxuXG4gICAgaWYgKHJlc291cmNlSW5mbyA9PSBudWxsKSB7XG4gICAgICBpZiAodmFsdWVzICE9IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhIGlzIG5vdCBvbiBHUFUgYnV0IG9uIENQVS4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVGhlcmUgaXMgbm8gZGF0YSBvbiBHUFUgb3IgQ1BVLicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHNpemUgPSAocmVzb3VyY2VJbmZvIGFzIEJ1ZmZlckluZm8pLnNpemU7XG4gICAgY29uc3QgYnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoc2l6ZSwgcmVzb3VyY2VJbmZvLnVzYWdlKTtcbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuc3VyZUNvbXB1dGVQYXNzRW5kZWQoKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9CdWZmZXIoXG4gICAgICAgIChyZXNvdXJjZUluZm8gYXMgQnVmZmVySW5mbykuYnVmZmVyLCAwLCBidWZmZXIsIDAsIHNpemUpO1xuICAgIHRoaXMuc3VibWl0UXVldWUoKTtcblxuICAgIGNvbnN0IHRlbnNvckluZm8gPSB0aGlzLm1ha2VUZW5zb3JJbmZvKHNoYXBlLCBkdHlwZSk7XG4gICAgLy8gTWFrZSBlbmdpbmUgdHJhY2sgdGhpcyB0ZW5zb3IsIHNvIHRoYXQgd2UgY2FuIGRpc3Bvc2UgaXQgbGF0ZXIuXG4gICAgY29uc3QgdGVuc29yUmVmID0gZW5naW5lKCkubWFrZVRlbnNvckZyb21UZW5zb3JJbmZvKHRlbnNvckluZm8pO1xuXG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldCh0ZW5zb3JJbmZvLmRhdGFJZCk7XG4gICAgdGVuc29yRGF0YVxuICAgICAgICAucmVzb3VyY2VJbmZvID0ge3NpemUsIHVzYWdlOiB0aGlzLmRlZmF1bHRHcHVCdWZmZXJVc2FnZSgpLCBidWZmZXJ9O1xuXG4gICAgcmV0dXJuIHt0ZW5zb3JSZWYsIGJ1ZmZlciwgYnVmU2l6ZTogc2l6ZX07XG4gIH1cblxuICBidWZmZXJTeW5jPFIgZXh0ZW5kcyBSYW5rLCBEIGV4dGVuZHMgRGF0YVR5cGU+KHQ6IFRlbnNvckluZm8pOlxuICAgICAgVGVuc29yQnVmZmVyPFIsIEQ+IHtcbiAgICBjb25zdCBkYXRhID0gdGhpcy5yZWFkU3luYyh0LmRhdGFJZCk7XG4gICAgaWYgKHQuZHR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICAvLyBEZWNvZGUgdGhlIGJ5dGVzIGludG8gc3RyaW5nLlxuICAgICAgICBjb25zdCBzdHJpbmdzID0gKGRhdGEgYXMgVWludDhBcnJheVtdKS5tYXAoZCA9PiB1dGlsLmRlY29kZVN0cmluZyhkKSk7XG4gICAgICAgIHJldHVybiBidWZmZXIodC5zaGFwZSBhcyBTaGFwZU1hcFtSXSwgdC5kdHlwZSwgc3RyaW5ncykgYXNcbiAgICAgICAgICAgIFRlbnNvckJ1ZmZlcjxSLCBEPjtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBkZWNvZGUgZW5jb2RlZCBzdHJpbmcgYnl0ZXMgaW50byB1dGYtOCcpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYnVmZmVyKHQuc2hhcGUgYXMgU2hhcGVNYXBbUl0sIHQuZHR5cGUsIGRhdGEgYXMgVHlwZWRBcnJheSkgYXNcbiAgICAgICAgVGVuc29yQnVmZmVyPFIsIEQ+O1xuICB9XG5cbiAgYXN5bmMgdGltZShmOiAoKSA9PiB2b2lkKTogUHJvbWlzZTxXZWJHUFVUaW1pbmdJbmZvPiB7XG4gICAgaWYgKCF0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICBgVGhpcyBkZXZpY2UgZG9lc24ndCBzdXBwb3J0IHRpbWVzdGFtcC1xdWVyeSBleHRlbnNpb24uIGAgK1xuICAgICAgICAgIGBTdGFydCBDaHJvbWUgYnJvd3NlciB3aXRoIGZsYWcgYCArXG4gICAgICAgICAgYC0tZGlzYWJsZS1kYXduLWZlYXR1cmVzPWRpc2FsbG93X3Vuc2FmZV9hcGlzIHRoZW4gdHJ5IGFnYWluLiBgICtcbiAgICAgICAgICBgT3RoZXJ3aXNlLCB6ZXJvIHdpbGwgYmUgc2hvd24gZm9yIHRoZSBrZXJuZWwgdGltZSB3aGVuIHByb2ZpbGluZyBgICtcbiAgICAgICAgICBgbW9kZSBpcyBlbmFibGVkLiBVc2luZyBwZXJmb3JtYW5jZS5ub3cgaXMgbm90IHdvcmthYmxlIGZvciB3ZWJncHUgYCArXG4gICAgICAgICAgYHNpbmNlIGl0IGRvZXNuJ3Qgc3VwcG9ydCBzeW5jaHJvbm91cyBkYXRhIHJlYWQgZnJvbSBHUFUuYCk7XG4gICAgfVxuICAgIGNvbnN0IG9sZEFjdGl2ZVRpbWVycyA9IHRoaXMuYWN0aXZlVGltZXJzO1xuICAgIGNvbnN0IG5ld0FjdGl2ZVRpbWVyczogVGltZXJOb2RlW10gPSBbXTtcblxuICAgIGxldCBvdXRlck1vc3RUaW1lID0gZmFsc2U7XG4gICAgaWYgKHRoaXMucHJvZ3JhbVRpbWVyc1N0YWNrID09IG51bGwpIHtcbiAgICAgIHRoaXMucHJvZ3JhbVRpbWVyc1N0YWNrID0gbmV3QWN0aXZlVGltZXJzO1xuICAgICAgb3V0ZXJNb3N0VGltZSA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWN0aXZlVGltZXJzLnB1c2gobmV3QWN0aXZlVGltZXJzKTtcbiAgICB9XG4gICAgdGhpcy5hY3RpdmVUaW1lcnMgPSBuZXdBY3RpdmVUaW1lcnM7XG5cbiAgICBmKCk7XG5cbiAgICBjb25zdCBmbGF0dGVuZWRBY3RpdmVUaW1lclF1ZXJpZXMgPVxuICAgICAgICB1dGlsLmZsYXR0ZW4odGhpcy5hY3RpdmVUaW1lcnMubWFwKChkOiBXZWJHUFVLZXJuZWxJbmZvKSA9PiBkLnF1ZXJ5KSlcbiAgICAgICAgICAgIC5maWx0ZXIoZCA9PiBkICE9IG51bGwpO1xuICAgIGNvbnN0IGZsYXR0ZW5lZEFjdGl2ZVRpbWVyTmFtZXMgPVxuICAgICAgICB1dGlsLmZsYXR0ZW4odGhpcy5hY3RpdmVUaW1lcnMubWFwKChkOiBXZWJHUFVLZXJuZWxJbmZvKSA9PiBkLm5hbWUpKVxuICAgICAgICAgICAgLmZpbHRlcihkID0+IGQgIT0gbnVsbCk7XG5cbiAgICB0aGlzLmFjdGl2ZVRpbWVycyA9IG9sZEFjdGl2ZVRpbWVycztcblxuICAgIGlmIChvdXRlck1vc3RUaW1lKSB7XG4gICAgICB0aGlzLnByb2dyYW1UaW1lcnNTdGFjayA9IG51bGw7XG4gICAgfVxuICAgIGNvbnN0IHJlczogV2ViR1BVVGltaW5nSW5mbyA9IHtcbiAgICAgIHVwbG9hZFdhaXRNczogdGhpcy51cGxvYWRXYWl0TXMsXG4gICAgICBkb3dubG9hZFdhaXRNczogdGhpcy5kb3dubG9hZFdhaXRNcyxcbiAgICAgIGtlcm5lbE1zOiBudWxsLFxuICAgICAgd2FsbE1zOiBudWxsXG4gICAgfTtcblxuICAgIGNvbnN0IGtlcm5lbE1zID0gYXdhaXQgUHJvbWlzZS5hbGwoZmxhdHRlbmVkQWN0aXZlVGltZXJRdWVyaWVzKTtcbiAgICByZXNbJ2tlcm5lbE1zJ10gPSB1dGlsLnN1bShrZXJuZWxNcyk7XG4gICAgcmVzWydnZXRFeHRyYVByb2ZpbGVJbmZvJ10gPSAoKSA9PlxuICAgICAgICBrZXJuZWxNcy5tYXAoKGQsIGkpID0+ICh7bmFtZTogZmxhdHRlbmVkQWN0aXZlVGltZXJOYW1lc1tpXSwgbXM6IGR9KSlcbiAgICAgICAgICAgIC5tYXAoZCA9PiBgJHtkLm5hbWV9OiAke2QubXN9YClcbiAgICAgICAgICAgIC5qb2luKCcsICcpO1xuICAgIHRoaXMudXBsb2FkV2FpdE1zID0gMDtcbiAgICB0aGlzLmRvd25sb2FkV2FpdE1zID0gMDtcbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgbWFrZVRlbnNvckluZm8oXG4gICAgICBzaGFwZTogbnVtYmVyW10sIGR0eXBlOiBEYXRhVHlwZSxcbiAgICAgIHZhbHVlcz86IGJhY2tlbmRfdXRpbC5CYWNrZW5kVmFsdWVzfHN0cmluZ1tdKTogVGVuc29ySW5mbyB7XG4gICAgaWYgKGR0eXBlID09PSAnc3RyaW5nJyAmJiB2YWx1ZXMgIT0gbnVsbCAmJiB2YWx1ZXMubGVuZ3RoID4gMCAmJlxuICAgICAgICB1dGlsLmlzU3RyaW5nKHZhbHVlc1swXSkpIHtcbiAgICAgIHZhbHVlcyA9ICh2YWx1ZXMgYXMge30gYXMgc3RyaW5nW10pLm1hcChkID0+IHV0aWwuZW5jb2RlU3RyaW5nKGQpKTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkID1cbiAgICAgICAgdGhpcy53cml0ZSh2YWx1ZXMgYXMgYmFja2VuZF91dGlsLkJhY2tlbmRWYWx1ZXMsIHNoYXBlLCBkdHlwZSk7XG4gICAgcmV0dXJuIHtkYXRhSWQsIHNoYXBlLCBkdHlwZX07XG4gIH1cblxuICBwcml2YXRlIHRlbnNvclRvQmluZGluZyh0ZW5zb3I/OiBUZW5zb3JJbmZvKTogR1BVQmluZGluZ1Jlc291cmNlIHtcbiAgICBpZiAoIXRlbnNvcikge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldCh0ZW5zb3IuZGF0YUlkKTtcbiAgICBpZiAoJ3RleHR1cmUnIGluIHRlbnNvckRhdGEucmVzb3VyY2VJbmZvKSB7XG4gICAgICBjb25zdCBpbmZvID0gdGVuc29yRGF0YS5yZXNvdXJjZUluZm87XG4gICAgICBpZiAoaW5mby50ZXh0dXJlIGluc3RhbmNlb2YgR1BVRXh0ZXJuYWxUZXh0dXJlKSB7XG4gICAgICAgIHJldHVybiBpbmZvLnRleHR1cmU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gaW5mby50ZXh0dXJlLmNyZWF0ZVZpZXcoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgYnVmZmVySW5mbyA9IHRlbnNvckRhdGEucmVzb3VyY2VJbmZvO1xuICAgIHJldHVybiB7b2Zmc2V0OiAwLCBzaXplOiBidWZmZXJJbmZvLnNpemUsIGJ1ZmZlcjogYnVmZmVySW5mby5idWZmZXJ9O1xuICB9XG5cbiAgYXN5bmMgZ2V0UXVlcnlUaW1lKHF1ZXJ5OiBHUFVRdWVyeVNldCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgaWYgKHRoaXMuc3VwcG9ydFRpbWVRdWVyeSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0VGltZUZyb21RdWVyeVNldChxdWVyeSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cbiAgfVxuXG4gIHVwbG9hZFRvR1BVKGRhdGFJZDogRGF0YUlkKTogdm9pZCB7XG4gICAgY29uc3QgdGVuc29yRGF0YSA9IHRoaXMudGVuc29yTWFwLmdldChkYXRhSWQpO1xuICAgIC8vIEFscmVhZHkgb24gdGhlIEdQVS5cbiAgICBpZiAodGVuc29yRGF0YS5yZXNvdXJjZUluZm8pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzaXplID0gd2ViZ3B1X3V0aWwuR1BVQnl0ZXNQZXJFbGVtZW50KHRlbnNvckRhdGEuZHR5cGUpICpcbiAgICAgICAgdXRpbC5zaXplRnJvbVNoYXBlKHRlbnNvckRhdGEuc2hhcGUpO1xuICAgIGNvbnN0IGJ1ZmZlciA9XG4gICAgICAgIHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKHNpemUsIHRoaXMuZGVmYXVsdEdwdUJ1ZmZlclVzYWdlKCkpO1xuXG4gICAgdGVuc29yRGF0YVxuICAgICAgICAucmVzb3VyY2VJbmZvID0ge3NpemUsIHVzYWdlOiB0aGlzLmRlZmF1bHRHcHVCdWZmZXJVc2FnZSgpLCBidWZmZXJ9O1xuICAgIGlmICh0ZW5zb3JEYXRhLnZhbHVlcykge1xuICAgICAgY29uc3Qgc3RhZ2luZ0J1ZmZlciA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlVXBsb2FkQnVmZmVyKFxuICAgICAgICAgIHNpemUsIEdQVUJ1ZmZlclVzYWdlLk1BUF9XUklURSB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfU1JDKTtcbiAgICAgIGNvbnN0IGFycmF5QnVmZmVyID0gc3RhZ2luZ0J1ZmZlci5nZXRNYXBwZWRSYW5nZSgpO1xuICAgICAgaWYgKHRlbnNvckRhdGEuZHR5cGUgPT09ICdpbnQzMicgfHwgdGVuc29yRGF0YS5kdHlwZSA9PT0gJ2Jvb2wnKSB7XG4gICAgICAgIG5ldyBJbnQzMkFycmF5KGFycmF5QnVmZmVyKS5zZXQodGVuc29yRGF0YS52YWx1ZXMgYXMgVHlwZWRBcnJheSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXcgRmxvYXQzMkFycmF5KGFycmF5QnVmZmVyKS5zZXQodGVuc29yRGF0YS52YWx1ZXMgYXMgRmxvYXQzMkFycmF5KTtcbiAgICAgIH1cbiAgICAgIHN0YWdpbmdCdWZmZXIudW5tYXAoKTtcbiAgICAgIHRoaXMuZW5zdXJlQ29tbWFuZEVuY29kZXJSZWFkeSgpO1xuICAgICAgdGhpcy5lbnN1cmVDb21wdXRlUGFzc0VuZGVkKCk7XG4gICAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9CdWZmZXIoXG4gICAgICAgICAgc3RhZ2luZ0J1ZmZlciwgMCwgYnVmZmVyLCAwLCBzaXplKTtcblxuICAgICAgY29uc3Qgc3RhZ2luZ0luZm8gPSB7XG4gICAgICAgIHNpemUsXG4gICAgICAgIHVzYWdlOiBHUFVCdWZmZXJVc2FnZS5NQVBfV1JJVEUgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyxcbiAgICAgICAgYnVmZmVyOiBzdGFnaW5nQnVmZmVyXG4gICAgICB9O1xuICAgICAgdGhpcy5zdGFnaW5nUGVuZGluZ0Rpc3Bvc2FsLnB1c2goc3RhZ2luZ0luZm8pO1xuICAgICAgLy8gVE9ETzogV2ViR1BVIGRvZXNuJ3Qgc3VwcG9ydCByZWFkIGRhdGEgc3luY2hyb25vdXNseSBmcm9tIEdQVSB0byBDUFUuXG4gICAgICAvLyBTbyBpdCB3aWxsIHJlcG9ydCBlcnJvciB3aGVuIHN3aXRjaGluZyBiYWNrZW5kIGZyb20gV2ViR1BVIHRvIG90aGVycy5cbiAgICAgIC8vIFRoZXJlIGFyZSB0d28gc2l0dWF0aW9uczogMSkgc3dpdGhjaW5nIHRoZSBiYWNrZW5kIGFmdGVyIHJ1bm5pbmcgYVxuICAgICAgLy8gbW9kZWw7IDIpIHN3aXRoY2luZyB0aGUgYmFja2VuZCB3aXRoaW4gdGhlIG1vZGVsLiBUZW1wb3JhcmlsbHkga2VlcCB0aGVcbiAgICAgIC8vIHZhbHVlcyBvbiBDUFUgdG8gc29sdmUgdGhlIGZpcnN0IGlzc3VlLlxuICAgICAgLy8gdGVuc29yRGF0YS52YWx1ZXMgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbWFrZVVuaWZvcm1zKHByb2dyYW1Vbmlmb3JtOiBQcm9ncmFtVW5pZm9ybSk6IEdQVUJpbmRpbmdSZXNvdXJjZSB7XG4gICAgbGV0IGN1cnJlbnRPZmZzZXQgPSAwO1xuICAgIGxldCBwcmVMZW5ndGggPSAwO1xuICAgIGNvbnN0IG9mZnNldHM6IG51bWJlcltdID0gW107XG4gICAgcHJvZ3JhbVVuaWZvcm0uZm9yRWFjaCgoZCkgPT4ge1xuICAgICAgaWYgKGQuZGF0YS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgZC5kYXRhID0gWzFdO1xuICAgICAgfVxuICAgICAgLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL1dHU0wvI2FsaWdub2ZcbiAgICAgIGxldCBiYXNlQWxpZ25tZW50OiBudW1iZXI7XG4gICAgICBzd2l0Y2ggKGQuZGF0YS5sZW5ndGgpIHtcbiAgICAgICAgY2FzZSAxOlxuICAgICAgICAgIGJhc2VBbGlnbm1lbnQgPSA0O1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgYmFzZUFsaWdubWVudCA9IDg7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgMzpcbiAgICAgICAgICBiYXNlQWxpZ25tZW50ID0gMTY7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgNDpcbiAgICAgICAgICBiYXNlQWxpZ25tZW50ID0gMTY7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgNTpcbiAgICAgICAgICBiYXNlQWxpZ25tZW50ID0gMTY7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgNjpcbiAgICAgICAgICBiYXNlQWxpZ25tZW50ID0gMTY7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgdXRpbC5hc3NlcnQoZmFsc2UsICgpID0+IGBVbnN1cHBvcnRlZCAke2QuZGF0YS5sZW5ndGh9RCBzaGFwZWApO1xuICAgICAgfVxuXG4gICAgICBpZiAocHJlTGVuZ3RoID09PSA1IHx8IHByZUxlbmd0aCA9PT0gNikge1xuICAgICAgICBiYXNlQWxpZ25tZW50ID0gMTY7XG4gICAgICB9XG4gICAgICBjdXJyZW50T2Zmc2V0ID0gTWF0aC5jZWlsKGN1cnJlbnRPZmZzZXQgLyBiYXNlQWxpZ25tZW50KSAqIGJhc2VBbGlnbm1lbnQ7XG4gICAgICBwcmVMZW5ndGggPSBkLmRhdGEubGVuZ3RoO1xuICAgICAgb2Zmc2V0cy5wdXNoKGN1cnJlbnRPZmZzZXQpO1xuICAgICAgY3VycmVudE9mZnNldCArPSBkLmRhdGEubGVuZ3RoICogNDtcbiAgICB9KTtcblxuICAgIGNvbnN0IGFycmF5QnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKGN1cnJlbnRPZmZzZXQpO1xuICAgIHByb2dyYW1Vbmlmb3JtLmZvckVhY2goKGQsIGkpID0+IHtcbiAgICAgIGNvbnN0IG9mZnNldCA9IG9mZnNldHNbaV07XG4gICAgICBpZiAoZC50eXBlID09PSAnaW50MzInKSB7XG4gICAgICAgIG5ldyBJbnQzMkFycmF5KGFycmF5QnVmZmVyLCBvZmZzZXQsIGQuZGF0YS5sZW5ndGgpLnNldChkLmRhdGEpO1xuICAgICAgfSBlbHNlIGlmIChkLnR5cGUgPT09ICd1aW50MzInKSB7XG4gICAgICAgIG5ldyBVaW50MzJBcnJheShhcnJheUJ1ZmZlciwgb2Zmc2V0LCBkLmRhdGEubGVuZ3RoKS5zZXQoZC5kYXRhKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG5ldyBGbG9hdDMyQXJyYXkoYXJyYXlCdWZmZXIsIG9mZnNldCwgZC5kYXRhLmxlbmd0aCkuc2V0KGQuZGF0YSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB1bmlmb3JtQnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoXG4gICAgICAgIGN1cnJlbnRPZmZzZXQsIEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUIHwgR1BVQnVmZmVyVXNhZ2UuVU5JRk9STSk7XG4gICAgdGhpcy5xdWV1ZS53cml0ZUJ1ZmZlcih1bmlmb3JtQnVmZmVyLCAwLCBhcnJheUJ1ZmZlciwgMCwgY3VycmVudE9mZnNldCk7XG5cbiAgICBjb25zdCB1bmlmb3JtSW5mbyA9IHtcbiAgICAgIHNpemU6IGN1cnJlbnRPZmZzZXQsXG4gICAgICB1c2FnZTogR1BVQnVmZmVyVXNhZ2UuQ09QWV9EU1QgfCBHUFVCdWZmZXJVc2FnZS5VTklGT1JNLFxuICAgICAgYnVmZmVyOiB1bmlmb3JtQnVmZmVyXG4gICAgfTtcbiAgICB0aGlzLnVuaWZvcm1QZW5kaW5nRGlzcG9zYWwucHVzaCh1bmlmb3JtSW5mbyk7XG5cbiAgICByZXR1cm4ge29mZnNldDogMCwgc2l6ZTogY3VycmVudE9mZnNldCwgYnVmZmVyOiB1bmlmb3JtQnVmZmVyfTtcbiAgfVxuXG4gIHB1YmxpYyBydW5XZWJHUFVQcm9ncmFtKFxuICAgICAgcHJvZ3JhbTogd2ViZ3B1X3Byb2dyYW0uV2ViR1BVUHJvZ3JhbSwgaW5wdXRzOiBUZW5zb3JJbmZvW10sXG4gICAgICBvdXRwdXREdHlwZTogRGF0YVR5cGUsIHByb2dyYW1EZWZpbmVkVW5pZm9ybT86IFByb2dyYW1Vbmlmb3JtLFxuICAgICAgb3V0cHV0PzogVGVuc29ySW5mbyk6IFRlbnNvckluZm8ge1xuICAgIGlmICghb3V0cHV0KSB7XG4gICAgICBvdXRwdXQgPSB0aGlzLm1ha2VUZW5zb3JJbmZvKHByb2dyYW0ub3V0cHV0U2hhcGUsIG91dHB1dER0eXBlKTtcbiAgICB9XG4gICAgaWYgKHV0aWwuc2l6ZUZyb21TaGFwZShvdXRwdXQuc2hhcGUpID09PSAwKSB7XG4gICAgICAvLyBTaG9ydC1jaXJjdWl0IHRoZSBjb21wdXRhdGlvbiBzaW5jZSB0aGUgcmVzdWx0IGlzIGVtcHR5IChoYXMgMCBpbiBpdHNcbiAgICAgIC8vIHNoYXBlKS5cbiAgICAgIHRoaXMudGVuc29yTWFwLmdldChvdXRwdXQuZGF0YUlkKS52YWx1ZXMgPVxuICAgICAgICAgIHV0aWwuZ2V0VHlwZWRBcnJheUZyb21EVHlwZShvdXRwdXQuZHR5cGUgYXMgJ2Zsb2F0MzInLCAwKTtcbiAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfVxuICAgIHRoaXMudXBsb2FkVG9HUFUob3V0cHV0LmRhdGFJZCk7XG4gICAgcHJvZ3JhbS5kaXNwYXRjaCA9IHJlc2hhcGVEaXNwYXRjaCh0aGlzLmRldmljZSwgcHJvZ3JhbSk7XG5cbiAgICAvLyBUaGVyZSBhcmUgZml2ZSBraW5kcyBvZiB1bmlmb3JtczogTkFOLCBzaGFwZXMsIHNoYXBlIHN0cmlkZXMsIHByb2dyYW1cbiAgICAvLyBzaXplLCBwcm9ncmFtIGRlZmluZWQgdW5pZm9ybXMuXG4gICAgbGV0IHByb2dyYW1Vbmlmb3JtOiBQcm9ncmFtVW5pZm9ybSA9IFtdO1xuICAgIGxldCBidWZmZXJTaGFwZXM6IG51bWJlcltdW10gPSBbXTtcbiAgICBpZiAoIXByb2dyYW0uaXNGcm9tUGl4ZWxzKSB7XG4gICAgICBwcm9ncmFtVW5pZm9ybS5wdXNoKHt0eXBlOiAnZmxvYXQzMicsIGRhdGE6IFtOYU5dfSk7XG4gICAgICBidWZmZXJTaGFwZXMgPSBpbnB1dHMuY29uY2F0KG91dHB1dCkubWFwKGQgPT4gZC5zaGFwZSk7XG4gICAgICBjb25zdCB1bmlmb3Jtc1R5cGUgPSAnaW50MzInO1xuICAgICAgYnVmZmVyU2hhcGVzLm1hcChkID0+IHtcbiAgICAgICAgcHJvZ3JhbVVuaWZvcm0ucHVzaCh7dHlwZTogdW5pZm9ybXNUeXBlLCBkYXRhOiBkfSk7XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHN0cmlkZXMgPSB1dGlsLmNvbXB1dGVTdHJpZGVzKG91dHB1dC5zaGFwZSk7XG4gICAgICBwcm9ncmFtVW5pZm9ybS5wdXNoKHt0eXBlOiB1bmlmb3Jtc1R5cGUsIGRhdGE6IHN0cmlkZXN9KTtcbiAgICAgIGlmIChwcm9ncmFtLnNpemUpIHtcbiAgICAgICAgY29uc3Qgc2l6ZSA9IHV0aWwuc2l6ZUZyb21TaGFwZShwcm9ncmFtLm91dHB1dFNoYXBlKTtcbiAgICAgICAgcHJvZ3JhbVVuaWZvcm0ucHVzaChcbiAgICAgICAgICAgIHt0eXBlOiB1bmlmb3Jtc1R5cGUsIGRhdGE6IFtwcm9ncmFtLmlzVmVjNCA/IHNpemUgLyA0IDogc2l6ZV19KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBpbnB1dHNEYXRhID0gaW5wdXRzLm1hcCgoaW5wdXQ6IFRlbnNvckluZm8sIGk6IG51bWJlcikgPT4ge1xuICAgICAgaWYgKGlucHV0LmR0eXBlID09PSAnY29tcGxleDY0Jykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgR1BHUFVQcm9ncmFtIGRvZXMgbm90IHN1cHBvcnQgY29tcGxleDY0IGlucHV0LiBGb3IgY29tcGxleDY0IGAgK1xuICAgICAgICAgICAgYGR0eXBlcywgcGxlYXNlIHNlcGFyYXRlIHRoZSBwcm9ncmFtIGludG8gcmVhbCBhbmQgaW1hZ2luYXJ5IGAgK1xuICAgICAgICAgICAgYHBhcnRzLmApO1xuICAgICAgfVxuICAgICAgdGhpcy51cGxvYWRUb0dQVShpbnB1dC5kYXRhSWQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAvLyBSZXR1cm5pbmcgZHR5cGUgZnJvbSB0ZW5zb3JNYXAgYmVjYXVzZSBpdCByZWZsZWN0cyBkdHlwZVxuICAgICAgICAvLyBvZiB1bmRlcmx5aW5nIGJ1ZmZlciwgcmF0aGVyIHRoYW4gYWJzdHJhY3QgZHR5cGUuXG4gICAgICAgIGR0eXBlOiB0aGlzLnRlbnNvck1hcC5nZXQoaW5wdXQuZGF0YUlkKS5kdHlwZSxcbiAgICAgICAgc2hhcGU6IGlucHV0LnNoYXBlLFxuICAgICAgICBuYW1lOiBwcm9ncmFtLnZhcmlhYmxlTmFtZXNbaV1cbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICBjb25zdCBrZXkgPVxuICAgICAgICB3ZWJncHVfcHJvZ3JhbS5tYWtlU2hhZGVyS2V5KHByb2dyYW0sIGJ1ZmZlclNoYXBlcywgaW5wdXRzRGF0YSwgb3V0cHV0KTtcblxuICAgIGxldCBwaXBlbGluZTtcbiAgICBpZiAoa2V5IGluIHRoaXMucGlwZWxpbmVDYWNoZSkge1xuICAgICAgcGlwZWxpbmUgPSB0aGlzLnBpcGVsaW5lQ2FjaGVba2V5XTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGlwZWxpbmUgPSB3ZWJncHVfcHJvZ3JhbS5jb21waWxlUHJvZ3JhbShcbiAgICAgICAgICB0aGlzLmRldmljZSwgcHJvZ3JhbSwgaW5wdXRzRGF0YSwgb3V0cHV0KTtcbiAgICAgIHRoaXMucGlwZWxpbmVDYWNoZVtrZXldID0gcGlwZWxpbmU7XG4gICAgfVxuXG4gICAgaWYgKHByb2dyYW1EZWZpbmVkVW5pZm9ybSkge1xuICAgICAgcHJvZ3JhbVVuaWZvcm0gPSBbLi4ucHJvZ3JhbVVuaWZvcm0sIC4uLnByb2dyYW1EZWZpbmVkVW5pZm9ybV07XG4gICAgfVxuICAgIGNvbnN0IGJpbmRpbmdzID0gW1xuICAgICAgdGhpcy50ZW5zb3JUb0JpbmRpbmcob3V0cHV0KSwgLi4uaW5wdXRzLm1hcCh0ID0+IHRoaXMudGVuc29yVG9CaW5kaW5nKHQpKSxcbiAgICAgIHRoaXMubWFrZVVuaWZvcm1zKHByb2dyYW1Vbmlmb3JtKVxuICAgIF07XG5cbiAgICBjb25zdCBiaW5kR3JvdXAgPSB0aGlzLmRldmljZS5jcmVhdGVCaW5kR3JvdXAoe1xuICAgICAgbGF5b3V0OiBwaXBlbGluZS5nZXRCaW5kR3JvdXBMYXlvdXQoMCksXG4gICAgICBlbnRyaWVzOiBiaW5kaW5ncy5tYXAoKGIsIGkpID0+ICh7YmluZGluZzogaSwgcmVzb3VyY2U6IGJ9KSksXG4gICAgfSk7XG5cbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICBjb25zdCBwYXNzID0gdGhpcy5nZXRDb21wdXRlUGFzcygpO1xuICAgIGNvbnN0IHNob3VsZFRpbWVQcm9ncmFtID0gdGhpcy5hY3RpdmVUaW1lcnMgIT0gbnVsbDtcbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgIGlmICh0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgICAgICAocGFzcyBhcyBhbnkpLndyaXRlVGltZXN0YW1wKHRoaXMucXVlcnlTZXQsIDApO1xuICAgICAgfVxuICAgIH1cbiAgICBwYXNzLnNldFBpcGVsaW5lKHBpcGVsaW5lKTtcbiAgICBwYXNzLnNldEJpbmRHcm91cCgwLCBiaW5kR3JvdXApO1xuICAgIHBhc3MuZGlzcGF0Y2hXb3JrZ3JvdXBzKFxuICAgICAgICBwcm9ncmFtLmRpc3BhdGNoWzBdLCBwcm9ncmFtLmRpc3BhdGNoWzFdLCBwcm9ncmFtLmRpc3BhdGNoWzJdKTtcbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgIGlmICh0aGlzLnN1cHBvcnRUaW1lUXVlcnkpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWFueVxuICAgICAgICAocGFzcyBhcyBhbnkpLndyaXRlVGltZXN0YW1wKHRoaXMucXVlcnlTZXQsIDEpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRpc3BhdGNoTnVtYmVySW5FbmNvZGVyKys7XG5cbiAgICBpbnB1dHMuZm9yRWFjaChpbnB1dCA9PiB7XG4gICAgICB0aGlzLmNvbW1hbmRRdWV1ZU93bmVkSWRzLmFkZChpbnB1dC5kYXRhSWQpO1xuICAgIH0pO1xuICAgIHRoaXMuY29tbWFuZFF1ZXVlT3duZWRJZHMuYWRkKG91dHB1dC5kYXRhSWQpO1xuXG4gICAgaWYgKGVudigpLmdldCgnV0VCR1BVX0RFRkVSUkVEX1NVQk1JVF9CQVRDSF9TSVpFJykgYXNcbiAgICAgICAgbnVtYmVyIDw9IHRoaXMuZGlzcGF0Y2hOdW1iZXJJbkVuY29kZXIpIHtcbiAgICAgIHRoaXMuc3VibWl0UXVldWUoKTtcbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkVGltZVByb2dyYW0pIHtcbiAgICAgIHRoaXMuYWN0aXZlVGltZXJzLnB1c2goe1xuICAgICAgICBuYW1lOiBwcm9ncmFtLmNvbnN0cnVjdG9yLm5hbWUsXG4gICAgICAgIHF1ZXJ5OiB0aGlzLmdldFF1ZXJ5VGltZSh0aGlzLnF1ZXJ5U2V0KVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvdXRwdXQ7XG4gIH1cblxuICBhc3luYyBnZXRUaW1lRnJvbVF1ZXJ5U2V0KHF1ZXJ5U2V0OiBHUFVRdWVyeVNldCkge1xuICAgIGNvbnN0IHF1ZXJ5QnVmZmVyID0gdGhpcy5idWZmZXJNYW5hZ2VyLmFjcXVpcmVCdWZmZXIoXG4gICAgICAgIDE2LCBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyB8IEdQVUJ1ZmZlclVzYWdlLlFVRVJZX1JFU09MVkUpO1xuICAgIGNvbnN0IGRzdCA9IHRoaXMuYnVmZmVyTWFuYWdlci5hY3F1aXJlQnVmZmVyKFxuICAgICAgICAxNiwgR1BVQnVmZmVyVXNhZ2UuTUFQX1JFQUQgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCk7XG5cbiAgICB0aGlzLmVuc3VyZUNvbW1hbmRFbmNvZGVyUmVhZHkoKTtcbiAgICB0aGlzLmVuc3VyZUNvbXB1dGVQYXNzRW5kZWQoKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5yZXNvbHZlUXVlcnlTZXQocXVlcnlTZXQsIDAsIDIsIHF1ZXJ5QnVmZmVyLCAwKTtcbiAgICB0aGlzLmN1cnJlbnRDb21tYW5kRW5jb2Rlci5jb3B5QnVmZmVyVG9CdWZmZXIocXVlcnlCdWZmZXIsIDAsIGRzdCwgMCwgMTYpO1xuICAgIHRoaXMuc3VibWl0UXVldWUoKTtcbiAgICBhd2FpdCBkc3QubWFwQXN5bmMoR1BVTWFwTW9kZS5SRUFEKTtcbiAgICBjb25zdCBhcnJheUJ1ZiA9IG5ldyBCaWdVaW50NjRBcnJheShkc3QuZ2V0TWFwcGVkUmFuZ2UoKSk7XG4gICAgY29uc3QgdGltZUVsYXBzZWROYW5vcyA9IE51bWJlcigoYXJyYXlCdWZbMV0gLSBhcnJheUJ1ZlswXSkpO1xuICAgIGRzdC51bm1hcCgpO1xuICAgIHRoaXMuYnVmZmVyTWFuYWdlci5yZWxlYXNlQnVmZmVyKFxuICAgICAgICBkc3QsIDE2LCBHUFVCdWZmZXJVc2FnZS5NQVBfUkVBRCB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNUKTtcbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIucmVsZWFzZUJ1ZmZlcihcbiAgICAgICAgcXVlcnlCdWZmZXIsIDE2LFxuICAgICAgICBHUFVCdWZmZXJVc2FnZS5DT1BZX1NSQyB8IEdQVUJ1ZmZlclVzYWdlLlFVRVJZX1JFU09MVkUpO1xuICAgIC8vIFJldHVybiBtaWxsaXNlY29uZHMuXG4gICAgcmV0dXJuIHRpbWVFbGFwc2VkTmFub3MgLyAxMDAwMDAwO1xuICB9XG5cbiAgc2hvdWxkRXhlY3V0ZU9uQ1BVKFxuICAgICAgaW5wdXRzOiBUZW5zb3JJbmZvW10sXG4gICAgICBzaXplVGhyZXNob2xkID0gQ1BVX0hBTkRPRkZfU0laRV9USFJFU0hPTEQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZW52KCkuZ2V0Qm9vbCgnV0VCR1BVX0NQVV9GT1JXQVJEJykgJiZcbiAgICAgICAgaW5wdXRzLmV2ZXJ5KFxuICAgICAgICAgICAgaW5wdXQgPT4gdGhpcy50ZW5zb3JNYXAuZ2V0KGlucHV0LmRhdGFJZCkucmVzb3VyY2VJbmZvID09IG51bGwgJiZcbiAgICAgICAgICAgICAgICB1dGlsLnNpemVGcm9tU2hhcGUoaW5wdXQuc2hhcGUpIDwgc2l6ZVRocmVzaG9sZCk7XG4gIH1cblxuICBudW1EYXRhSWRzKCkge1xuICAgIHJldHVybiB0aGlzLnRlbnNvck1hcC5udW1EYXRhSWRzKCkgLSB0aGlzLnRlbnNvckRhdGFQZW5kaW5nRGlzcG9zYWwubGVuZ3RoO1xuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICBpZiAodGhpcy5kaXNwb3NlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmJ1ZmZlck1hbmFnZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMudGV4dHVyZU1hbmFnZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMuZGlzcG9zZWQgPSB0cnVlO1xuICB9XG59XG4iXX0=